<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at F3A0</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F39B.html">F39B</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f3a0">Map</a></td>
<td class="next">
Next: <a href="F401.html">F401</a>
</td>
</tr>
</table>
<div class="description">F3A0: Update the SRB for a window</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="F404.html">F404</a> and <a href="F485.html">F485</a>. Updates the <a href="7F00.html">screen refresh buffer</a> (SRB) for a window (or window-pair) after a light switch has been flipped or a blind has been raised or lowered.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">0xB9-0xBD (corresponding to the 5th, 4th, 3rd, 2nd or 1st floor)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">0x00-0x1F or 0x40-0x5F (corresponding to the x-coordinate of the window)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="f3a0"></span>F3A0</td>
<td class="instruction">RES 6,L</td>
<td class="comment-1" rowspan="1">Now <span class="register">L</span>=X'/8 (where X' is the x-coordinate of the left edge of the window), and <span class="register">HL</span> points at the Z value corresponding to the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3a2"></span>F3A2</td>
<td class="instruction">LD BC,($7FFE)</td>
<td class="comment-1" rowspan="1">The play area coordinates of the top-left corner of the screen are stored at <a href="7FFE.html">7FFE</a> and <a href="7FFF.html">7FFF</a></td>
</tr>
<tr>
<td class="address-1"><span id="f3a6"></span>F3A6</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X (the x-coordinate of the leftmost column of the play area on screen)</td>
</tr>
<tr>
<td class="address-1"><span id="f3a7"></span>F3A7</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=X/8</td>
</tr>
<tr>
<td class="address-1"><span id="f3a8"></span>F3A8</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="f3a9"></span>F3A9</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="f3aa"></span>F3AA</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=X/8 (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="f3ab"></span>F3AB</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X'/8 (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="f3ac"></span>F3AC</td>
<td class="instruction">SUB E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X'/8-X/8</td>
</tr>
<tr>
<td class="address-1"><span id="f3ad"></span>F3AD</td>
<td class="instruction">CP $04</td>
<td class="comment-1" rowspan="1">Is the window off screen to the right or left?</td>
</tr>
<tr>
<td class="address-1"><span id="f3af"></span>F3AF</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="f3b0"></span>F3B0</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=0-3 (index of the 8-tile wide column containing the window)</td>
</tr>
<tr>
<td class="address-1"><span id="f3b1"></span>F3B1</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=1 (5th floor), 2, 3, 4 or 5 (1st floor)</td>
</tr>
<tr>
<td class="address-1"><span id="f3b2"></span>F3B2</td>
<td class="instruction">SUB $B8</td>
</tr>
<tr>
<td class="address-1"><span id="f3b4"></span>F3B4</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="5"><span class="register">D</span>=6 (5th floor), 12, 18, 24 or 30 (1st floor)</td>
</tr>
<tr>
<td class="address-1"><span id="f3b5"></span>F3B5</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3b6"></span>F3B6</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="f3b7"></span>F3B7</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3b8"></span>F3B8</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3b9"></span>F3B9</td>
<td class="instruction">SUB B</td>
<td class="comment-1" rowspan="1">Subtract Y, the y-coordinate of the topmost row of the play area on screen (2, 8, 14 or 20)</td>
</tr>
<tr>
<td class="address-1"><span id="f3ba"></span>F3BA</td>
<td class="instruction">ADD A,$04</td>
<td class="comment-1" rowspan="2">Is the window off screen?</td>
</tr>
<tr>
<td class="address-1"><span id="f3bc"></span>F3BC</td>
<td class="instruction">CP $15</td>
</tr>
<tr>
<td class="address-1"><span id="f3be"></span>F3BE</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="f3bf"></span>F3BF</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=4*(<span class="register">D</span>-Y+4)+<span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="f3c0"></span>F3C0</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3c1"></span>F3C1</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="f3c2"></span>F3C2</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">DE</span> at the SRB byte corresponding to the top row of the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3c3"></span>F3C3</td>
<td class="instruction">LD D,$7F</td>
</tr>
<tr>
<td class="address-1"><span id="f3c5"></span>F3C5</td>
<td class="instruction">LD C,$80</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=0x80 (10000000)</td>
</tr>
<tr>
<td class="address-1"><span id="f3c7"></span>F3C7</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the Z value for the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3c8"></span>F3C8</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the Z'' value for the leftmost column of tiles in the 8-tile wide segment that contains the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3c9"></span>F3C9</td>
<td class="instruction">SET 7,L</td>
</tr>
<tr>
<td class="address-1"><span id="f3cb"></span>F3CB</td>
<td class="instruction">LD H,$B8</td>
</tr>
<tr>
<td class="address-1"><span id="f3cd"></span>F3CD</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="f3ce"></span>F3CE</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL'</span> at the <a href="BF00.html">Z' value</a> for the 8x6 block of tiles that contains the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3cf"></span>F3CF</td>
<td class="instruction">LD H,$BF</td>
</tr>
<tr>
<td class="address-1"><span id="f3d1"></span>F3D1</td>
<td class="instruction">LD C,$01</td>
<td class="comment-1" rowspan="1"><span class="register">C'</span>=1 (00000001)</td>
</tr>
<tr>
<td class="address-1"><span id="f3d3"></span>F3D3</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f3d4"></span>
<div class="comments">
<div class="paragraph">
The following loop examines the 8x6 block of tiles that contains the window and updates the relevant SRB bytes for the affected window tiles.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="f3d4"></span>F3D4</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="f3d5"></span>F3D5</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Rotate the set bit in <span class="register">C'</span> one place to the right</td>
</tr>
<tr>
<td class="address-1"><span id="f3d7"></span>F3D7</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z' value</td>
</tr>
<tr>
<td class="address-1"><span id="f3d8"></span>F3D8</td>
<td class="instruction">AND C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we should use the T values in pages 0xA0, 0xA2, 0xA4, 0xA6, 0xA8 and 0xAA</td>
</tr>
<tr>
<td class="address-1"><span id="f3d9"></span>F3D9</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="f3da"></span>F3DA</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the pointer to the Z'' value</td>
</tr>
<tr>
<td class="address-1"><span id="f3db"></span>F3DB</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Z'' value</td>
</tr>
<tr>
<td class="address-1"><span id="f3dc"></span>F3DC</td>
<td class="instruction">LD H,$A0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the T value in page 0xA0</td>
</tr>
<tr>
<td class="address-1"><span id="f3de"></span>F3DE</td>
<td class="instruction">JR Z,$F3E2</td>
<td class="comment-1" rowspan="1">Jump unless we should use the T values in pages 0xAC, 0xAE, 0xB0, 0xB2, 0xB4 and 0xB6</td>
</tr>
<tr>
<td class="address-1"><span id="f3e0"></span>F3E0</td>
<td class="instruction">LD H,$AC</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the T value in page 0xAC</td>
</tr>
<tr>
<td class="address-2"><span id="f3e2"></span>F3E2</td>
<td class="instruction">LD B,$06</td>
<td class="comment-1" rowspan="1">There are 6 rows of tiles to consider</td>
</tr>
<tr>
<td class="address-2"><span id="f3e4"></span>F3E4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T</td>
</tr>
<tr>
<td class="address-1"><span id="f3e5"></span>F3E5</td>
<td class="instruction">AND $C0</td>
<td class="comment-1" rowspan="1">Keep only bits 6 and 7</td>
</tr>
<tr>
<td class="address-1"><span id="f3e7"></span>F3E7</td>
<td class="instruction">CP $80</td>
<td class="comment-1" rowspan="1">Is there a window tile here?</td>
</tr>
<tr>
<td class="address-1"><span id="f3e9"></span>F3E9</td>
<td class="instruction">JR NZ,$F3EE</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="f3eb"></span>F3EB</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="3">Set the appropriate bit in the SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="f3ec"></span>F3EC</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="address-1"><span id="f3ed"></span>F3ED</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-2"><span id="f3ee"></span>F3EE</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the next T value (in page 0xA2, 0xA4, 0xA6, 0xA8, 0xAA, 0xAE, 0xB0, 0xB2, 0xB4 or 0xB6)</td>
</tr>
<tr>
<td class="address-1"><span id="f3ef"></span>F3EF</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="f3f0"></span>F3F0</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the SRB byte for the next row down</td>
</tr>
<tr>
<td class="address-1"><span id="f3f1"></span>F3F1</td>
<td class="instruction">ADD A,$04</td>
</tr>
<tr>
<td class="address-1"><span id="f3f3"></span>F3F3</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3f4"></span>F3F4</td>
<td class="instruction">DJNZ $F3E4</td>
<td class="comment-1" rowspan="1">Jump back to consider the tile in the next row down</td>
</tr>
<tr>
<td class="address-1"><span id="f3f6"></span>F3F6</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> back at the SRB byte corresponding to the top row of the window</td>
</tr>
<tr>
<td class="address-1"><span id="f3f7"></span>F3F7</td>
<td class="instruction">SUB $18</td>
</tr>
<tr>
<td class="address-1"><span id="f3f9"></span>F3F9</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="f3fa"></span>F3FA</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the Z'' value pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="f3fb"></span>F3FB</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the Z'' value for the next column of tiles to the right (in page 0xB9-0xBF)</td>
</tr>
<tr>
<td class="address-1"><span id="f3fc"></span>F3FC</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Rotate the set bit in <span class="register">C</span> one place to the right</td>
</tr>
<tr>
<td class="address-1"><span id="f3fe"></span>F3FE</td>
<td class="instruction">JR NC,$F3D4</td>
<td class="comment-1" rowspan="1">Jump back until 8 tile columns have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="f400"></span>F400</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F39B.html">F39B</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f3a0">Map</a></td>
<td class="next">
Next: <a href="F401.html">F401</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/62368.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>