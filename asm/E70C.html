<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at E70C</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="E700.html">E700</a>
</td>
<td class="up">Up: <a href="../maps/all.html#e70c">Map</a></td>
<td class="next">
Next: <a href="E7E6.html">E7E6</a>
</td>
</tr>
</table>
<div class="description">E70C: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="65DB.html">65DB</a>, <a href="E80E.html">E80E</a>, <a href="E845.html">E845</a>, <a href="E87C.html">E87C</a>, <a href="E8B7.html">E8B7</a> and <a href="EA80.html">EA80</a>. Copies a background tile of the play area into the back buffer at <a href="A01E.html">A01E</a>, superimposes character sprite tiles and a foreground tile as appropriate, and then copies the resultant tile to the screen. Also sets the corresponding attribute byte.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Screen row number (0-19)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">Screen column number (0-31)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="e70c"></span>E70C</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Put the screen coordinates onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="e70d"></span>E70D</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="11">Compute the corresponding display file address in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="e70e"></span>E70E</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="e710"></span>E710</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e711"></span>E711</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e712"></span>E712</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e713"></span>E713</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="e714"></span>E714</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="e715"></span>E715</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="e716"></span>E716</td>
<td class="instruction">AND $18</td>
</tr>
<tr>
<td class="address-1"><span id="e718"></span>E718</td>
<td class="instruction">ADD A,$40</td>
</tr>
<tr>
<td class="address-1"><span id="e71a"></span>E71A</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="e71b"></span>E71B</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-1" rowspan="1">Put the display file address onto the stack and get the screen coordinates back in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="e71c"></span>E71C</td>
<td class="instruction">LD DE,($7FFE)</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=play area coordinates of the top-left corner of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="e720"></span>E720</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=play area coordinates of the tile to be printed</td>
</tr>
<tr>
<td class="address-1"><span id="e721"></span>E721</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Push these coordinates onto the stack...</td>
</tr>
<tr>
<td class="address-1"><span id="e722"></span>E722</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="e723"></span>E723</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">...and pop them into <span class="register">DE'</span></td>
</tr>
<tr>
<td class="address-1"><span id="e724"></span>E724</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e725"></span>
<div class="comments">
<div class="paragraph">
In order to find the graphic data and attribute byte for the play area tile(s) to be printed at (X,Y), we need the T and T' values for that location; these values can be found in turn from the Z, Z' and Z'' values for the location.
</div>
<div class="paragraph">
The Z value (0x00&lt;=Z&lt;=0x65) for the play area location (X,Y) is found in byte INT(X/8) of page 0xB8+INT(Y/6). Then the Z' value is found in byte Z of page <a href="BF00.html">0xBF</a>, and the Z'' value in byte 0x80+Z of page 0xB8+X%8.
</div>
<div class="paragraph">
Z'' and bit 7-(X%8) of Z' determine the address, P, of the T value for the play area location (X,Y): Z'' is the LSB, and the MSB is either 0xA0+2*(Y%6) or 0xAC+2*(Y%6), depending on whether bit 7-(X%8) of Z' is reset or set. The address of the T' value is P+256.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e725"></span>E725</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="address-1"><span id="e726"></span>E726</td>
<td class="instruction">LD D,$B7</td>
<td class="comment-1" rowspan="4">Set <span class="register">D</span>=0xB8+INT(Y/6) (0xB8-0xBE)</td>
</tr>
<tr>
<td class="address-2"><span id="e728"></span>E728</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="e729"></span>E729</td>
<td class="instruction">SUB $06</td>
</tr>
<tr>
<td class="address-1"><span id="e72b"></span>E72B</td>
<td class="instruction">JR NC,$E728</td>
</tr>
<tr>
<td class="address-1"><span id="e72d"></span>E72D</td>
<td class="instruction">ADD A,$56</td>
<td class="comment-1" rowspan="1">0x50&lt;=<span class="register">A</span>&lt;=0x55</td>
</tr>
<tr>
<td class="address-1"><span id="e72f"></span>E72F</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xA0, 0xA2, 0xA4, 0xA6, 0xA8 or 0xAA</td>
</tr>
<tr>
<td class="address-1"><span id="e730"></span>E730</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=0xA0+2*(Y%6)</td>
</tr>
<tr>
<td class="address-1"><span id="e731"></span>E731</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="address-1"><span id="e732"></span>E732</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1">Keep only bits 3-7</td>
</tr>
<tr>
<td class="address-1"><span id="e734"></span>E734</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="3">Slide them down into bits 0-4; now <span class="register">A</span>=INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="e735"></span>E735</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e736"></span>E736</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e737"></span>E737</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the Z value for the play area location (X,Y)</td>
</tr>
<tr>
<td class="address-1"><span id="e738"></span>E738</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="address-1"><span id="e739"></span>E739</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="1">Keep only bits 0-2; now <span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="address-1"><span id="e73b"></span>E73B</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save this value briefly</td>
</tr>
<tr>
<td class="address-1"><span id="e73c"></span>E73C</td>
<td class="instruction">ADD A,$A0</td>
<td class="comment-1" rowspan="1">0xA0&lt;=<span class="register">A</span>&lt;=0xA7</td>
</tr>
<tr>
<td class="address-1"><span id="e73e"></span>E73E</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=0xA0+(X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="e73f"></span>E73F</td>
<td class="instruction">LD L,$15</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x15 of page 0xA0+(X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="e741"></span>E741</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Now <span class="register">C</span>=0x80 (if X%8=0), 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, or 0x01 (if X%8=7)</td>
</tr>
<tr>
<td class="address-1"><span id="e742"></span>E742</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z (value of byte INT(X/8) of page 0xB8+INT(Y/6))</td>
</tr>
<tr>
<td class="address-1"><span id="e743"></span>E743</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Z (0x00-0x65)</td>
</tr>
<tr>
<td class="address-1"><span id="e744"></span>E744</td>
<td class="instruction">LD H,$BF</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the table of Z' values at <a href="BF00.html">BF00</a></td>
</tr>
<tr>
<td class="address-1"><span id="e746"></span>E746</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z' (0x00, 0x01, 0x03, 0x07, 0x0E, 0x1F, 0x80, 0x86, 0xC7, 0xD7, 0xF0, 0xFC, or 0xFF)</td>
</tr>
<tr>
<td class="address-1"><span id="e747"></span>E747</td>
<td class="instruction">AND C</td>
<td class="comment-1" rowspan="1">Is bit 7-(X%8) of Z' set?</td>
</tr>
<tr>
<td class="address-1"><span id="e748"></span>E748</td>
<td class="instruction">JR Z,$E74E</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="e74a"></span>E74A</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="3">Otherwise set <span class="register">B</span>=0xAC+2*(Y%6)</td>
</tr>
<tr>
<td class="address-1"><span id="e74b"></span>E74B</td>
<td class="instruction">ADD A,$0C</td>
</tr>
<tr>
<td class="address-1"><span id="e74d"></span>E74D</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-2"><span id="e74e"></span>E74E</td>
<td class="instruction">SET 7,L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x80+Z (0x80-0xE5)</td>
</tr>
<tr>
<td class="address-1"><span id="e750"></span>E750</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="address-1"><span id="e751"></span>E751</td>
<td class="instruction">ADD A,$B8</td>
<td class="comment-1" rowspan="2"><span class="register">H</span>=0xB8+X%8</td>
</tr>
<tr>
<td class="address-1"><span id="e753"></span>E753</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="e754"></span>E754</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=Z'' (value of byte 0x80+Z of page 0xB8+X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="e755"></span>E755</td>
<td class="instruction">SET 5,E</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=0x20+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="e757"></span>E757</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=value of byte 0x20+INT(X/8) of page 0xB8+INT(Y/6)</td>
</tr>
<tr>
<td class="address-1"><span id="e758"></span>E758</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=attribute byte address LSB (0x00-0x1B)</td>
</tr>
<tr>
<td class="address-1"><span id="e759"></span>E759</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0x20+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="e75a"></span>E75A</td>
<td class="instruction">XOR $60</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0x40+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="e75c"></span>E75C</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the window flags for the play area location (X,Y)</td>
</tr>
<tr>
<td class="address-1"><span id="e75d"></span>E75D</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T (value of byte Z'' of page 0xA0+2*(Y%6) or 0xAC+2*(Y%6))</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e75e"></span>
<div class="comments">
<div class="paragraph">
<span id="tValue" /> We have collected the T value for the play area location (X,Y). Bits 7 and 6 of T have the following meanings:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Value</th>
<th colspan="1" rowspan="1">Meaning</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">11</td>
<td class="" colspan="1" rowspan="1">This location has a background tile and a transparent foreground tile</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">10</td>
<td class="" colspan="1" rowspan="1">This location has a blank background tile and a transparent foreground tile (used by windows and house number signs)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">01</td>
<td class="" colspan="1" rowspan="1">This location has an opaque foreground tile only (characters with a z-coordinate of 1 will appear behind it)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">00</td>
<td class="" colspan="1" rowspan="1">This location has a background tile only (characters with a z-coordinate of 1 will appear in front of it)</td>
</tr>
</table>
</div>
<div class="paragraph">
When bits 7 and 6 of T are both set (11), bits 2-5 of T and bit 7 of T' indicate the LSB of the address of the background tile's graphic data; the MSB is always 0x80. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from bits 0-6 of T'; the MSBs are always 0x80.
</div>
<div class="paragraph">
When bit 7 of T is set and bit 6 is reset (10), bits 3-5 are unused, and bit 2 is set only if the right-hand window of a pair is at this location. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from T' (0x00-0x1F) and the window flags; the MSBs are always 0x80.
</div>
<div class="paragraph">
When bit 7 of T is reset, bit 5 is unused (always reset), and bits 2-4 indicate the MSB of the address of the tile's graphic data (0x80, 0x88, 0x90, 0x98 or 0xA0); the LSB is equal to T'.
</div>
<div class="paragraph">
Finally, bits 1 and 0 of T indicate the MSB of the address of the tile's attribute byte (0xA8, 0xA9, 0xAA or 0xAB); the LSB (0x00-0x1B, already collected in <span class="register">L</span> at this point) is found in byte 0x20+INT(X/8) of page 0xB8+INT(Y/6).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e75e"></span>E75E</td>
<td class="instruction">AND $03</td>
<td class="comment-1" rowspan="1">Keep only bits 0 and 1 of T</td>
</tr>
<tr>
<td class="address-1"><span id="e760"></span>E760</td>
<td class="instruction">ADD A,$A8</td>
<td class="comment-1" rowspan="1">0xA8&lt;=<span class="register">A</span>&lt;=0xAB</td>
</tr>
<tr>
<td class="address-1"><span id="e762"></span>E762</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">0xA8&lt;=<span class="register">H</span>&lt;=0xAB</td>
</tr>
<tr>
<td class="address-1"><span id="e763"></span>E763</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=play area tile attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="e764"></span>E764</td>
<td class="instruction">LD ($A81E),A</td>
<td class="comment-1" rowspan="1">Save it at <a href="A81E.html">A81E</a> for later retrieval</td>
</tr>
<tr>
<td class="address-1"><span id="e767"></span>E767</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T</td>
</tr>
<tr>
<td class="address-1"><span id="e768"></span>E768</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=0xA1+2*(Y%6) or 0xAD+2*(Y%6); now <span class="register">BC</span> points at the T' value</td>
</tr>
<tr>
<td class="address-1"><span id="e769"></span>E769</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Does this play area location have a background tile and a foreground tile?</td>
</tr>
<tr>
<td class="address-1"><span id="e76a"></span>E76A</td>
<td class="instruction">JR NC,$E7BC</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e76c"></span>
<div class="comments">
<div class="paragraph">
The play area location under consideration has a background tile and a foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e76c"></span>E76C</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is there a window or a house number sign here?</td>
</tr>
<tr>
<td class="address-1"><span id="e76e"></span>E76E</td>
<td class="instruction">JR NZ,$E784</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e770"></span>
<div class="comments">
<div class="paragraph">
There is a window or a house number sign at this location.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e770"></span>E770</td>
<td class="instruction">CALL <a href="F7DA.html">$F7DA</a></td>
<td class="comment-1" rowspan="1">Collect the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="e773"></span>E773</td>
<td class="instruction">JR Z,$E77B</td>
<td class="comment-1" rowspan="1">Jump unless we are dealing with the right-hand window of a pair</td>
</tr>
<tr>
<td class="address-1"><span id="e775"></span>E775</td>
<td class="instruction">AND $23</td>
<td class="comment-1" rowspan="1">Keep only bits 5 (light indicator), 1 and 0 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="e777"></span>E777</td>
<td class="instruction">ADD A,$60</td>
<td class="comment-1" rowspan="1">Set bit 7 if the light is off (i.e. copy bit 5 into bit 7)</td>
</tr>
<tr>
<td class="address-1"><span id="e779"></span>E779</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="2">Move bits 1 and 0 (decoration indicator) into bits 7 and 6, and the light indicator back into bit 5</td>
</tr>
<tr>
<td class="address-1"><span id="e77a"></span>E77A</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-2"><span id="e77b"></span>E77B</td>
<td class="instruction">AND $E0</td>
<td class="comment-1" rowspan="1">Keep only bits 5 (light indicator), 6 and 7 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="e77d"></span>E77D</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Copy these bits to <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="e77e"></span>E77E</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T' (0x00-0x1F for window tiles and house number sign tiles)</td>
</tr>
<tr>
<td class="address-1"><span id="e77f"></span>E77F</td>
<td class="instruction">OR E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="address-1"><span id="e780"></span>E780</td>
<td class="instruction">LD L,$9F</td>
<td class="comment-1" rowspan="1">Use tile 0x9F in page 0x80 (which is blank) as the background tile</td>
</tr>
<tr>
<td class="address-1"><span id="e782"></span>E782</td>
<td class="instruction">JR $E791</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e784"></span>
<div class="comments">
<div class="paragraph">
There is no window or house number sign at this location, and it has a background tile and a transparent foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="e784"></span>E784</td>
<td class="instruction">AND $78</td>
<td class="comment-1" rowspan="2">Keep only bits 2-5 of T</td>
</tr>
<tr>
<td class="address-1"><span id="e786"></span>E786</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="e787"></span>E787</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2">Shift bits 2-5 into bits 1-4 and set bit 7</td>
</tr>
<tr>
<td class="address-1"><span id="e788"></span>E788</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="e789"></span>E789</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=background tile reference (even number &gt;= 0x80)</td>
</tr>
<tr>
<td class="address-1"><span id="e78a"></span>E78A</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="address-1"><span id="e78b"></span>E78B</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Is bit 7 of T' set?</td>
</tr>
<tr>
<td class="address-1"><span id="e78c"></span>E78C</td>
<td class="instruction">JR NC,$E78F</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="e78e"></span>E78E</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Increment the background tile reference (to an odd number &gt;= 0x81)</td>
</tr>
<tr>
<td class="address-2"><span id="e78f"></span>E78F</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=T' with bit 7 set</td>
</tr>
<tr>
<td class="address-1"><span id="e790"></span>E790</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-2"><span id="e791"></span>E791</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="address-1"><span id="e792"></span>E792</td>
<td class="instruction">LD H,$80</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the background tile graphic data</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e794"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">HL</span> holds the base address of the background tile graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e794"></span>E794</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the foreground tile identifier (in <span class="register">E</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="e795"></span>E795</td>
<td class="instruction">CALL <a href="E700.html">$E700</a></td>
<td class="comment-1" rowspan="1">Copy the background tile into the back buffer at <a href="A01E.html">A01E</a></td>
</tr>
<tr>
<td class="address-1"><span id="e798"></span>E798</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1)</td>
</tr>
<tr>
<td class="address-1"><span id="e79a"></span>E79A</td>
<td class="instruction">CALL <a href="E8F3.html#e8f8">$E8F8</a></td>
</tr>
<tr>
<td class="address-1"><span id="e79d"></span>E79D</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the foreground tile identifier to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e79e"></span>
<div class="comments">
<div class="paragraph">
Now we superimpose the foreground tile. The 16 graphic and mask bytes for the foreground tile are found in two groups of 8 bytes in pages 0x80-0x87.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e79e"></span>E79E</td>
<td class="instruction">LD B,$C0</td>
<td class="comment-1" rowspan="1">The LSB of the first group of 8 bytes is found in page <a href="C000.html">0xC0</a></td>
</tr>
<tr>
<td class="address-1"><span id="e7a0"></span>E7A0</td>
<td class="instruction">LD DE,$A01E</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the back buffer at <a href="A01E.html">A01E</a></td>
</tr>
<tr>
<td class="address-1"><span id="e7a3"></span>E7A3</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=LSB of the first group of 8 bytes</td>
</tr>
<tr>
<td class="address-2"><span id="e7a4"></span>E7A4</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Copy the LSB to <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="e7a5"></span>E7A5</td>
<td class="instruction">LD H,$80</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first byte (a graphic byte) in the group</td>
</tr>
<tr>
<td class="address-1"><span id="e7a7"></span>E7A7</td>
<td class="instruction">LD B,$04</td>
<td class="comment-1" rowspan="1">There are 4 pairs of bytes per group</td>
</tr>
<tr>
<td class="address-2"><span id="e7a9"></span>E7A9</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7aa"></span>E7AA</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">OR on the graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7ab"></span>E7AB</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the corresponding mask byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7ac"></span>E7AC</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">AND on the mask byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7ad"></span>E7AD</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7ae"></span>E7AE</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Replace the back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7af"></span>E7AF</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="e7b0"></span>E7B0</td>
<td class="instruction">DJNZ $E7A9</td>
<td class="comment-1" rowspan="1">Jump back until all 8 bytes have been done</td>
</tr>
<tr>
<td class="address-1"><span id="e7b2"></span>E7B2</td>
<td class="instruction">LD B,$C1</td>
<td class="comment-1" rowspan="1">The LSB of the second group of 8 bytes is found in page <a href="C100.html">0xC1</a></td>
</tr>
<tr>
<td class="address-1"><span id="e7b4"></span>E7B4</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=LSB of the second group of 8 bytes</td>
</tr>
<tr>
<td class="address-1"><span id="e7b5"></span>E7B5</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we've just done the second group</td>
</tr>
<tr>
<td class="address-1"><span id="e7b6"></span>E7B6</td>
<td class="instruction">LD C,$FF</td>
<td class="comment-1" rowspan="1">Signal: the second group is next</td>
</tr>
<tr>
<td class="address-1"><span id="e7b8"></span>E7B8</td>
<td class="instruction">JR NZ,$E7A4</td>
<td class="comment-1" rowspan="1">Jump back until both groups have been done</td>
</tr>
<tr>
<td class="address-1"><span id="e7ba"></span>E7BA</td>
<td class="instruction">JR $E7CE</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e7bc"></span>
<div class="comments">
<div class="paragraph">
The play area location under consideration has only one tile: either a background tile (if bit 6 of T is reset), or an opaque foreground tile (bit 6 of T set).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="e7bc"></span>E7BC</td>
<td class="instruction">AND $B8</td>
<td class="comment-1" rowspan="1">Keep only bits 3-5 and 7 (bits 2-4 and 6 of T)</td>
</tr>
<tr>
<td class="address-1"><span id="e7be"></span>E7BE</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Copy bit 6 of T into the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="e7bf"></span>E7BF</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="e7c0"></span>E7C0</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2">Now <span class="register">A</span> has bit 7 set, and a copy of bits 2-4 of T in bits 3-5</td>
</tr>
<tr>
<td class="address-1"><span id="e7c1"></span>E7C1</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="e7c2"></span>E7C2</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=0x80, 0x88, 0x90, 0x98 or 0xA0</td>
</tr>
<tr>
<td class="address-1"><span id="e7c3"></span>E7C3</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="address-1"><span id="e7c4"></span>E7C4</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the tile graphic data</td>
</tr>
<tr>
<td class="address-1"><span id="e7c5"></span>E7C5</td>
<td class="instruction">CALL <a href="E700.html">$E700</a></td>
<td class="comment-1" rowspan="1">Copy the tile into the back buffer at <a href="A01E.html">A01E</a></td>
</tr>
<tr>
<td class="address-1"><span id="e7c8"></span>E7C8</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="e7c9"></span>E7C9</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1) if we're dealing with a background tile</td>
</tr>
<tr>
<td class="address-1"><span id="e7cb"></span>E7CB</td>
<td class="instruction">CALL NC,<a href="E8F3.html#e8f8">$E8F8</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e7ce"></span>
<div class="comments">
<div class="paragraph">
Now we can superimpose sprite tiles for characters who are in the foreground.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="e7ce"></span>E7CE</td>
<td class="instruction">LD A,$02</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are between a building and the sidewalk (z=2), and then for characters who are on the sidewalk or road (z=4)</td>
</tr>
<tr>
<td class="address-1"><span id="e7d0"></span>E7D0</td>
<td class="instruction">CALL <a href="E8F3.html">$E8F3</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e7d3"></span>
<div class="comments">
<div class="paragraph">
The tile in the back buffer is now ready to be drawn.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="e7d3"></span>E7D3</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=display file address</td>
</tr>
<tr>
<td class="address-1"><span id="e7d4"></span>E7D4</td>
<td class="instruction">LD C,E</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=corresponding attribute file address LSB</td>
</tr>
<tr>
<td class="address-1"><span id="e7d5"></span>E7D5</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=display file address MSB (0x40, 0x48 or 0x50)</td>
</tr>
<tr>
<td class="address-1"><span id="e7d6"></span>E7D6</td>
<td class="instruction">LD HL,$A01E</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the back buffer containing the tile to be drawn</td>
</tr>
<tr>
<td class="address-1"><span id="e7d9"></span>E7D9</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4"><span class="register">A</span>=0x58, 0x59 or 0x5A</td>
</tr>
<tr>
<td class="address-1"><span id="e7da"></span>E7DA</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e7db"></span>E7DB</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="e7dc"></span>E7DC</td>
<td class="instruction">ADD A,$50</td>
</tr>
<tr>
<td class="address-1"><span id="e7de"></span>E7DE</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the appropriate byte of the attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="e7df"></span>E7DF</td>
<td class="instruction">LD A,($A81E)</td>
<td class="comment-1" rowspan="1">Collect the attribute byte saved earlier at <a href="A81E.html">A81E</a></td>
</tr>
<tr>
<td class="address-1"><span id="e7e2"></span>E7E2</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Copy it to the attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="e7e3"></span>E7E3</td>
<td class="instruction">JP <a href="E700.html#e703">$E703</a></td>
<td class="comment-1" rowspan="1">Copy the tile to the display file</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="E700.html">E700</a>
</td>
<td class="up">Up: <a href="../maps/all.html#e70c">Map</a></td>
<td class="next">
Next: <a href="E7E6.html">E7E6</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20221122</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/59148.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>