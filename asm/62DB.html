<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 62DB</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="62DA.html">62DA</a></span></td>
<td class="up">Up: <a href="../maps/all.html#62db">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6329.html">6329</a></span></td>
</tr>
</table>
<div class="description">62DB: Control the sniper</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the command list at <a href="FD7A.html">FD7A</a>. Checks whether conditions are right for the sniper to appear, and if they are, hands over control to the interruptible subcommand routine at <a href="621E.html">621E</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">0xE3 (sniper)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="62db"></span>62DB</td>
<td class="instruction">LD A,($7FFF)</td>
<td class="comment-11" rowspan="1"><a href="7FFF.html">7FFF</a> holds the y-coordinate of the topmost row of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62de"></span>62DE</td>
<td class="instruction">CP $14</td>
<td class="comment-11" rowspan="1">Is the sidewalk on screen at the moment?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e0"></span>62E0</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e1"></span>62E1</td>
<td class="instruction">LD A,($7FFC)</td>
<td class="comment-11" rowspan="1">Collect Sam's status flags from <a href="7FFC.html">7FFC</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e4"></span>62E4</td>
<td class="instruction">AND $81</td>
<td class="comment-11" rowspan="1">Is Sam being carried or falling from a building at the moment?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e6"></span>62E6</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e7"></span>62E7</td>
<td class="instruction">LD L,$03</td>
<td class="comment-11" rowspan="2">Set bit 7 of byte 0x03 of the sniper's buffer, making him move quickly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62e9"></span>62E9</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62eb"></span>62EB</td>
<td class="instruction">LD L,$0A</td>
<td class="comment-11" rowspan="3">Decrement and then collect byte 0x0A of the sniper's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62ed"></span>62ED</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62ee"></span>62EE</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62ef"></span>62EF</td>
<td class="instruction">AND $0F</td>
<td class="comment-11" rowspan="1">Are any of bits 0-3 set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62f1"></span>62F1</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if so (15 times out of 16)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="62f2"></span>
<div class="comments">
<div class="paragraph">
Now we check how many keys Sam has collected. The exact number in Sam's possession affects the probability that the sniper will appear.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62f2"></span>62F2</td>
<td class="instruction">LD A,($7FEA)</td>
<td class="comment-11" rowspan="1">Collect the key inventory flags from <a href="7FEA.html">7FEA</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62f5"></span>62F5</td>
<td class="instruction">LD B,$1F</td>
<td class="comment-11" rowspan="6"><span class="register">B</span>=0x1F if Sam has no keys or one key, 0x3F if he has two keys, 0x7F if he has three, or 0xFF if he has all four</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="62f7"></span>62F7</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62f8"></span>62F8</td>
<td class="instruction">JR Z,$6300</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62fa"></span>62FA</td>
<td class="instruction">JR NC,$62F7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62fc"></span>62FC</td>
<td class="instruction">RL B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="62fe"></span>62FE</td>
<td class="instruction">JR $62F7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6300"></span>6300</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-11" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6303"></span>6303</td>
<td class="instruction">CP B</td>
<td class="comment-11" rowspan="1">Is <span class="register">A</span>&gt;=<span class="register">B</span>?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6304"></span>6304</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6305"></span>
<div class="comments">
<div class="paragraph">
The dice are telling us that the sniper should appear. But can we find a suitable spot for him?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6305"></span>6305</td>
<td class="instruction">LD DE,$6212</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the table of potential x-coordinates for the sniper at <a href="6212.html">6212</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6308"></span>6308</td>
<td class="instruction">LD L,$01</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x01 of the sniper's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="630a"></span>630A</td>
<td class="instruction">LD B,$07</td>
<td class="comment-11" rowspan="1">There are 7 entries in the table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="630c"></span>630C</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=potential x-coordinate for the sniper</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="630d"></span>630D</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next potential x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="630e"></span>630E</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Set the sniper's x-coordinate for testing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="630f"></span>630F</td>
<td class="instruction">CALL <a href="66D8.html#66da">$66DA</a></td>
<td class="comment-11" rowspan="1">Would this bring the sniper on screen no less than 8 x-coordinates away from Sam?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6312"></span>6312</td>
<td class="instruction">JR Z,$6317</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6314"></span>6314</td>
<td class="instruction">DJNZ $630C</td>
<td class="comment-11" rowspan="1">Otherwise consider the next potential x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6316"></span>6316</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6317"></span>
<div class="comments">
<div class="paragraph">
We have found a suitable place for the sniper to emerge from.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6317"></span>6317</td>
<td class="instruction">LD L,$11</td>
<td class="comment-11" rowspan="2">Byte 0x11 of the sniper's buffer is used to regulate the delay between shots; initialise it to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6319"></span>6319</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="631a"></span>631A</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0x10</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="631b"></span>631B</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-11" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="631e"></span>631E</td>
<td class="instruction">AND $0F</td>
<td class="comment-11" rowspan="3">Byte 0x10 of the sniper's buffer is used to decide when to duck and when to shoot; initialise it to a number between 0x0A and 0x19</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6320"></span>6320</td>
<td class="instruction">ADD A,$0A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6322"></span>6322</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6323"></span>6323</td>
<td class="instruction">LD BC,$621E</td>
<td class="comment-11" rowspan="2">Copy the address of the interruptible subcommand routine at <a href="621E.html">621E</a> into bytes 0x0E and 0x0F of the sniper's buffer, and then jump to it</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6326"></span>6326</td>
<td class="instruction">JP <a href="F7AB.html">$F7AB</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="62DA.html">62DA</a></span></td>
<td class="up">Up: <a href="../maps/all.html#62db">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="6329.html">6329</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20170516</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2017 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>