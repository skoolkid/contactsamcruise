<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at F748</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F731.html">F731</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f748">Map</a></td>
<td class="next">
Next: <a href="F79A.html">F79A</a>
</td>
</tr>
</table>
<div class="description">F748: Make a character walk up and down until somebody knocks on a door</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the command lists at <a href="FCFC.html">FCFC</a>, <a href="FE23.html">FE23</a>, <a href="FE58.html">FE58</a>, <a href="FE77.html">FE77</a> and <a href="FE96.html">FE96</a>. Makes the character start walking up or down towards his next walkabout destination, unless the character is on door duty and someone has knocked on the door (in which case this primary command terminates).
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0xD7-0xE5)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="f748"></span>F748</td>
<td class="instruction">LD L,$0B</td>
<td class="comment-1" rowspan="2">Copy the door identifier (0xA8, 0xAC, 0xAD or 0xB3) and walkabout duration indicator (0x00 or 0xFF) from the command list into bytes 0x0B and 0x0C of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f74a"></span>F74A</td>
<td class="instruction">CALL <a href="F171.html">$F171</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f74d"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F820.html">F820</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="f74d"></span>F74D</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-1" rowspan="3">Get a random number between 32 and 63 in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="f750"></span>F750</td>
<td class="instruction">AND $1F</td>
</tr>
<tr>
<td class="address-1"><span id="f752"></span>F752</td>
<td class="instruction">ADD A,$20</td>
</tr>
<tr>
<td class="address-1"><span id="f754"></span>F754</td>
<td class="instruction">LD L,$0D</td>
<td class="comment-1" rowspan="2">Store this number in byte 0x0D of the character's buffer; it is the number of mini-walkabouts the character will perform (if the walkabout duration indicator in byte 0x0C is 0xFF)</td>
</tr>
<tr>
<td class="address-1"><span id="f756"></span>F756</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f757"></span>F757</td>
<td class="instruction">LD L,$01</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x01 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f759"></span>F759</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="f75a"></span>F75A</td>
<td class="instruction">LD L,$0A</td>
<td class="comment-1" rowspan="2">Copy this into byte 0x0A of the character's buffer (it will be the walkabout origin)</td>
</tr>
<tr>
<td class="address-1"><span id="f75c"></span>F75C</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f75d"></span>F75D</td>
<td class="instruction">CALL <a href="F7B1.html">$F7B1</a></td>
<td class="comment-1" rowspan="1">Change the character's primary command routine address to <a href="F748.html#f760">F760</a> (below)</td>
</tr>
<tr>
<td class="address-1"><span id="f760"></span>F760</td>
<td class="instruction">LD BC,$F6E9</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the interruptible subcommand routine address at <a href="F6E9.html">F6E9</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f763"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="7A6A.html">7A6A</a> with <span class="register">BC</span>=<a href="7A57.html">7A57</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="f763"></span>F763</td>
<td class="instruction">LD L,$0B</td>
<td class="comment-1" rowspan="2">Collect the door identifier (0xA8, 0xAC, 0xAD, 0xAF or 0xB3) from byte 0x0B of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f765"></span>F765</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f766"></span>F766</td>
<td class="instruction">LD D,$7F</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at <a href="7FA8.html">7FA8</a> (always 0) or the door knock status flags for the door in question (see <a href="7FAA.html">7FAA</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="f768"></span>F768</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="f769"></span>F769</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Has somebody knocked at the door?</td>
</tr>
<tr>
<td class="address-1"><span id="f76b"></span>F76B</td>
<td class="instruction">JR Z,$F775</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="f76d"></span>F76D</td>
<td class="instruction">LD A,$C0</td>
<td class="comment-1" rowspan="3">Reset bit 7 and set bit 6 of the door knock status flags to indicate that someone is going to answer the door</td>
</tr>
<tr>
<td class="address-1"><span id="f76f"></span>F76F</td>
<td class="instruction">XOR (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f770"></span>F770</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f771"></span>F771</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-2"><span id="f772"></span>F772</td>
<td class="instruction">JP <a href="F280.html">$F280</a></td>
<td class="comment-1" rowspan="1">Move to the next command in the command list (which will send the character to the door)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f775"></span>
<div class="comments">
<div class="paragraph">
Either nobody has knocked on the door, or the character is not on door duty.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="f775"></span>F775</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="f776"></span>F776</td>
<td class="instruction">LD L,$0C</td>
<td class="comment-1" rowspan="2">Collect the walkabout duration indicator (0x00 or 0xFF) from byte 0x0C of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f778"></span>F778</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f779"></span>F779</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x0D</td>
</tr>
<tr>
<td class="address-1"><span id="f77a"></span>F77A</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-1" rowspan="2">Decrement the walkabout counter in byte 0x0D of the character's buffer, or leave it unchanged</td>
</tr>
<tr>
<td class="address-1"><span id="f77b"></span>F77B</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f77c"></span>F77C</td>
<td class="instruction">LD L,$0A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x0A of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f77e"></span>F77E</td>
<td class="instruction">JR NZ,$F78D</td>
<td class="comment-1" rowspan="1">Jump unless the walkabout counter is now 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f780"></span>
<div class="comments">
<div class="paragraph">
The character has finished walking up and down. If the character is not on door duty, we move to the next command in the command list; if the character is on door duty, we move six bytes ahead in the command list (past the door-opening commands).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="f780"></span>F780</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Collect the door identifier (0xA8, 0xAC, 0xAD, 0xAF or 0xB3) from byte 0x0B of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f781"></span>F781</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f782"></span>F782</td>
<td class="instruction">ADD A,$57</td>
<td class="comment-1" rowspan="1">Set the carry flag if it's &gt; 0xA8 (meaning the character was on door duty)</td>
</tr>
<tr>
<td class="address-1"><span id="f784"></span>F784</td>
<td class="instruction">SBC A,A</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=6 if the character was on door duty, 0 otherwise</td>
</tr>
<tr>
<td class="address-1"><span id="f785"></span>F785</td>
<td class="instruction">AND $06</td>
</tr>
<tr>
<td class="address-1"><span id="f787"></span>F787</td>
<td class="instruction">LD L,$16</td>
<td class="comment-1" rowspan="3">Add 0 or 6 to the character's command list offset (in byte 0x16 of his buffer)</td>
</tr>
<tr>
<td class="address-1"><span id="f789"></span>F789</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="f78a"></span>F78A</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f78b"></span>F78B</td>
<td class="instruction">JR $F772</td>
<td class="comment-1" rowspan="1">Terminate this primary command</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f78d"></span>
<div class="comments">
<div class="paragraph">
It's time to set another walkabout destination for this character.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="f78d"></span>F78D</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-1" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="f790"></span>F790</td>
<td class="instruction">OR $F9</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=-6, -4, -2 or 0</td>
</tr>
<tr>
<td class="address-1"><span id="f792"></span>F792</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="f793"></span>F793</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-1" rowspan="1">Add the walkabout origin x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="f794"></span>F794</td>
<td class="instruction">LD L,$10</td>
<td class="comment-1" rowspan="2">Store this x-coordinate in byte 0x10 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="f796"></span>F796</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f797"></span>F797</td>
<td class="instruction">JP <a href="F7AB.html">$F7AB</a></td>
<td class="comment-1" rowspan="1">Copy the interruptible subcommand routine address (<a href="7A57.html">7A57</a> or <a href="F6E9.html">F6E9</a>) from <span class="register">BC</span> into bytes 0x0E and 0x0F of the character's buffer, and then jump to it</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F731.html">F731</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f748">Map</a></td>
<td class="next">
Next: <a href="F79A.html">F79A</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/63304.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>