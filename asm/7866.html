<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 7866</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="77D3.html">77D3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7866">Map</a></td>
<td class="next">
Next: <a href="78F9.html">78F9</a>
</td>
</tr>
</table>
<div class="description">7866: Prepare for a cutscene</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7AB6.html">7AB6</a>. On entry, <span class="register">A</span> holds the LSB of the address of the <a href="7F00.html">screen refresh buffer</a> byte that corresponds to the top row of the portion of the play area to be displayed during the cutscene.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Screen refresh buffer address LSB</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">New y-coordinate for the topmost row of the play area on screen</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">New x-coordinate for the leftmost column of the play area on screen</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7866"></span>7866</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the play area coordinates briefly</td>
</tr>
<tr>
<td class="address-1"><span id="7867"></span>7867</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the screen refresh buffer address LSB briefly</td>
</tr>
<tr>
<td class="address-1"><span id="7868"></span>7868</td>
<td class="instruction">CALL <a href="FC57.html">$FC57</a></td>
<td class="comment-1" rowspan="1">Hide the play area</td>
</tr>
<tr>
<td class="address-1"><span id="786b"></span>786B</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the screen refresh buffer address LSB to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="786c"></span>786C</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first <a href="7F00.html">screen refresh buffer</a> (SRB) byte that will need updating later</td>
</tr>
<tr>
<td class="address-1"><span id="786d"></span>786D</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the play area coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="786e"></span>786E</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the SRB address for now</td>
</tr>
<tr>
<td class="address-1"><span id="786f"></span>786F</td>
<td class="instruction">AND $03</td>
<td class="comment-1" rowspan="6">Compute Sam's new x-coordinate (x+5, where x is the x-coordinate of the leftmost column of the portion of the play area to be displayed)</td>
</tr>
<tr>
<td class="address-1"><span id="7871"></span>7871</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7872"></span>7872</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7873"></span>7873</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7874"></span>7874</td>
<td class="instruction">ADD A,$05</td>
</tr>
<tr>
<td class="address-1"><span id="7876"></span>7876</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="7877"></span>7877</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=Sam's new x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="7878"></span>7878</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="2">Set the new y-coordinate of the topmost row of the play area on screen</td>
</tr>
<tr>
<td class="address-1"><span id="7879"></span>7879</td>
<td class="instruction">LD ($7FFF),A</td>
</tr>
<tr>
<td class="address-1"><span id="787c"></span>787C</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=screen refresh buffer address LSB</td>
</tr>
<tr>
<td class="address-1"><span id="787d"></span>787D</td>
<td class="instruction">SUB $0C</td>
<td class="comment-1" rowspan="5">Compute Sam's new y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="787f"></span>787F</td>
<td class="instruction">AND $FC</td>
</tr>
<tr>
<td class="address-1"><span id="7881"></span>7881</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7882"></span>7882</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7883"></span>7883</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="7884"></span>7884</td>
<td class="instruction">LD HL,$E600</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x00 of Sam's character buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7887"></span>7887</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="1">Set Sam's animatory state to <a href="../graphics/as.html#0">0x00</a> (standing/walking phase 1)</td>
</tr>
<tr>
<td class="address-1"><span id="7889"></span>7889</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x01</td>
</tr>
<tr>
<td class="address-1"><span id="788a"></span>788A</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Set Sam's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="788b"></span>788B</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x02</td>
</tr>
<tr>
<td class="address-1"><span id="788c"></span>788C</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Set Sam's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="788d"></span>788D</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">L</span>=0x04</td>
</tr>
<tr>
<td class="address-1"><span id="788e"></span>788E</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="788f"></span>788F</td>
<td class="instruction">LD (HL),$01</td>
<td class="comment-1" rowspan="1">Set Sam's z-coordinate</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7891"></span>
<div class="comments">
<div class="paragraph">
Next we cycle character buffer groups forwards or backwards as appropriate to correspond with the portion of the play area that will be on screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7891"></span>7891</td>
<td class="instruction">LD HL,$F1B7</td>
<td class="comment-1" rowspan="2">Place a RET instruction at <a href="F18E.html#f1b7">F1B7</a> so that the screen will not scroll right</td>
</tr>
<tr>
<td class="address-1"><span id="7894"></span>7894</td>
<td class="instruction">LD (HL),$C9</td>
</tr>
<tr>
<td class="address-1"><span id="7896"></span>7896</td>
<td class="instruction">LD L,$E0</td>
<td class="comment-1" rowspan="2">Place a RET instruction at <a href="F1BA.html#f1e0">F1E0</a> so that the screen will not scroll left</td>
</tr>
<tr>
<td class="address-1"><span id="7898"></span>7898</td>
<td class="instruction">LD (HL),$C9</td>
</tr>
<tr>
<td class="address-1"><span id="789a"></span>789A</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="789b"></span>789B</td>
<td class="instruction">LD HL,$7FFE</td>
<td class="comment-1" rowspan="2">Collect X (the x-coordinate of the leftmost column of the play area on screen) from <a href="7FFE.html">7FFE</a></td>
</tr>
<tr>
<td class="address-1"><span id="789e"></span>789E</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-2"><span id="789f"></span>789F</td>
<td class="instruction">CP E</td>
<td class="comment-1" rowspan="1">Does X match the target x-coordinate (in <span class="register">E</span>)?</td>
</tr>
<tr>
<td class="address-1"><span id="78a0"></span>78A0</td>
<td class="instruction">JR Z,$78B9</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="78a2"></span>78A2</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the target x-coordinate briefly</td>
</tr>
<tr>
<td class="address-1"><span id="78a3"></span>78A3</td>
<td class="instruction">JR C,$78AC</td>
<td class="comment-1" rowspan="1">Jump if X&lt;<span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="78a5"></span>78A5</td>
<td class="instruction">CALL <a href="F18E.html">$F18E</a></td>
<td class="comment-1" rowspan="1">Cycle a character buffer group forwards (but without scrolling the screen)</td>
</tr>
<tr>
<td class="address-1"><span id="78a8"></span>78A8</td>
<td class="instruction">LD A,$F8</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=-8</td>
</tr>
<tr>
<td class="address-1"><span id="78aa"></span>78AA</td>
<td class="instruction">JR $78B1</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="78ac"></span>78AC</td>
<td class="instruction">CALL <a href="F1BA.html">$F1BA</a></td>
<td class="comment-1" rowspan="1">Cycle a character buffer group backwards (but without scrolling the screen)</td>
</tr>
<tr>
<td class="address-1"><span id="78af"></span>78AF</td>
<td class="instruction">LD A,$08</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="78b1"></span>78B1</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the target x-coordinate to <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="78b2"></span>78B2</td>
<td class="instruction">LD HL,$7FFE</td>
<td class="comment-1" rowspan="3">Add 8 to or subtract 8 from X (the x-coordinate of the leftmost column of the play area on screen, stored at <a href="7FFE.html">7FFE</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="78b5"></span>78B5</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="78b6"></span>78B6</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="78b7"></span>78B7</td>
<td class="instruction">JR $789F</td>
<td class="comment-1" rowspan="1">Jump back to check whether we need to cycle any more character buffers backwards or forwards</td>
</tr>
<tr>
<td class="address-2"><span id="78b9"></span>78B9</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="78ba"></span>78BA</td>
<td class="instruction">LD (HL),$C3</td>
<td class="comment-1" rowspan="1">Restore the JP instruction at <a href="F1BA.html#f1e0">F1E0</a></td>
</tr>
<tr>
<td class="address-1"><span id="78bc"></span>78BC</td>
<td class="instruction">LD L,$B7</td>
<td class="comment-1" rowspan="2">Restore the JP instruction at <a href="F18E.html#f1b7">F1B7</a></td>
</tr>
<tr>
<td class="address-1"><span id="78be"></span>78BE</td>
<td class="instruction">LD (HL),$C3</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="78c0"></span>
<div class="comments">
<div class="paragraph">
Next we determine whether any lights near Sam need to be switched on and any window blinds need to be raised.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="78c0"></span>78C0</td>
<td class="instruction">LD H,$E6</td>
<td class="comment-1" rowspan="1">0xE6=Sam</td>
</tr>
<tr>
<td class="address-1"><span id="78c2"></span>78C2</td>
<td class="instruction">CALL <a href="F6A2.html">$F6A2</a></td>
<td class="comment-1" rowspan="1">Collect in <span class="register">C</span> the x-coordinate of the front column of Sam's sprite</td>
</tr>
<tr>
<td class="address-1"><span id="78c5"></span>78C5</td>
<td class="instruction">LD B,$C0</td>
<td class="comment-1" rowspan="2">Is there a light switch next to Sam?</td>
</tr>
<tr>
<td class="address-1"><span id="78c7"></span>78C7</td>
<td class="instruction">CALL <a href="F436.html#f454">$F454</a></td>
</tr>
<tr>
<td class="address-1"><span id="78ca"></span>78CA</td>
<td class="instruction">JR Z,$78EB</td>
<td class="comment-1" rowspan="1">Jump if not (we can reveal the play area now)</td>
</tr>
<tr>
<td class="address-1"><span id="78cc"></span>78CC</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-1" rowspan="1">Set the zero flag if the light switch affects the light in only one window or window-pair</td>
</tr>
<tr>
<td class="address-1"><span id="78ce"></span>78CE</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=window flags for Sam's location</td>
</tr>
<tr>
<td class="address-1"><span id="78cf"></span>78CF</td>
<td class="instruction">JR Z,$78D8</td>
<td class="comment-1" rowspan="1">Jump if the light switch affects the light in only one window or window-pair</td>
</tr>
<tr>
<td class="address-1"><span id="78d1"></span>78D1</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-1" rowspan="1">Is the light switch in the 'on' position?</td>
</tr>
<tr>
<td class="address-1"><span id="78d3"></span>78D3</td>
<td class="instruction">CALL NZ,<a href="F485.html#f4a6">$F4A6</a></td>
<td class="comment-1" rowspan="1">If not, switch the light on</td>
</tr>
<tr>
<td class="address-1"><span id="78d6"></span>78D6</td>
<td class="instruction">JR $78EB</td>
<td class="comment-1" rowspan="1">Jump forward to reveal the play area</td>
</tr>
<tr>
<td class="address-2"><span id="78d8"></span>78D8</td>
<td class="instruction">BIT 1,A</td>
<td class="comment-1" rowspan="1">Is there a right-hand window here with a blind?</td>
</tr>
<tr>
<td class="address-1"><span id="78da"></span>78DA</td>
<td class="instruction">JR Z,$78DE</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="78dc"></span>78DC</td>
<td class="instruction">RES 0,A</td>
<td class="comment-1" rowspan="1">Reset bit 0: blind raised in the right-hand window</td>
</tr>
<tr>
<td class="address-2"><span id="78de"></span>78DE</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is there a left-land or single window here with a blind?</td>
</tr>
<tr>
<td class="address-1"><span id="78e0"></span>78E0</td>
<td class="instruction">JR Z,$78E4</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="78e2"></span>78E2</td>
<td class="instruction">RES 6,A</td>
<td class="comment-1" rowspan="1">Reset bit 6: blind raised in the left-hand or only window</td>
</tr>
<tr>
<td class="address-2"><span id="78e4"></span>78E4</td>
<td class="instruction">RES 5,A</td>
<td class="comment-1" rowspan="1">Reset bit 5: light switch on</td>
</tr>
<tr>
<td class="address-1"><span id="78e6"></span>78E6</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Save the new window flags (blinds raised, light switch on)</td>
</tr>
<tr>
<td class="address-1"><span id="78e7"></span>78E7</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear <span class="register">A</span> to prevent the following call from changing the window flags (we've already updated them)</td>
</tr>
<tr>
<td class="address-1"><span id="78e8"></span>78E8</td>
<td class="instruction">CALL <a href="F485.html#f499">$F499</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the window</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="78eb"></span>
<div class="comments">
<div class="paragraph">
Finally we can reveal the portion of the play area in which Sam will walk up and down until the cutscene message has been displayed and the game resumes.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="78eb"></span>78EB</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the SRB address to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="78ec"></span>78EC</td>
<td class="instruction">LD B,$06</td>
<td class="comment-1" rowspan="1">The portion is 6 rows high</td>
</tr>
<tr>
<td class="address-1"><span id="78ee"></span>78EE</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1">Initialise <span class="register">A</span> for the loop that follows</td>
</tr>
<tr>
<td class="address-2"><span id="78ef"></span>78EF</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="4">Set all bits in the relevant SRB bytes</td>
</tr>
<tr>
<td class="address-1"><span id="78f0"></span>78F0</td>
<td class="instruction">LD (HL),$FF</td>
</tr>
<tr>
<td class="address-1"><span id="78f2"></span>78F2</td>
<td class="instruction">ADD A,$04</td>
</tr>
<tr>
<td class="address-1"><span id="78f4"></span>78F4</td>
<td class="instruction">DJNZ $78EF</td>
</tr>
<tr>
<td class="address-1"><span id="78f6"></span>78F6</td>
<td class="instruction">JP <a href="EA80.html">$EA80</a></td>
<td class="comment-1" rowspan="1">Update the display</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="77D3.html">77D3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7866">Map</a></td>
<td class="next">
Next: <a href="78F9.html">78F9</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/30822.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>