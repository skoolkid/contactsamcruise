<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 77D3</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="77A3.html">77A3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#77d3">Map</a></td>
<td class="next">
Next: <a href="7866.html">7866</a>
</td>
</tr>
</table>
<div class="description">77D3: Deal with Sam when he's on the phone</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="74D8.html">74D8</a> when bit 4 at <a href="7FFC.html">7FFC</a> is set (by the routine at <a href="76FA.html">76FA</a>), indicating that Sam is on the phone.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="77d3"></span>77D3</td>
<td class="instruction">LD HL,$7F9B</td>
<td class="comment-1" rowspan="1">The telephone call status flags are stored at <a href="7F9B.html">7F9B</a></td>
</tr>
<tr>
<td class="address-1"><span id="77d6"></span>77D6</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-1" rowspan="1">Has someone asked Sam 'WHO'S THERE?'</td>
</tr>
<tr>
<td class="address-1"><span id="77d8"></span>77D8</td>
<td class="instruction">JP NZ,<a href="776F.html">$776F</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="77db"></span>77DB</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-1" rowspan="1">Is the telephone call still in progress?</td>
</tr>
<tr>
<td class="address-1"><span id="77dd"></span>77DD</td>
<td class="instruction">JR Z,$77E3</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="77df"></span>77DF</td>
<td class="instruction">CALL <a href="F1E3.html">$F1E3</a></td>
<td class="comment-1" rowspan="1">Hang up if 'h' was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="77e2"></span>77E2</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="77e3"></span>
<div class="comments">
<div class="paragraph">
The telephone call is still in progress.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="77e3"></span>77E3</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Has Sam picked up a telephone that was ringing?</td>
</tr>
<tr>
<td class="address-1"><span id="77e5"></span>77E5</td>
<td class="instruction">JR Z,$77F3</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="77e7"></span>77E7</td>
<td class="instruction">CALL <a href="F1E3.html">$F1E3</a></td>
<td class="comment-1" rowspan="1">Hang up if 'h' was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="77ea"></span>77EA</td>
<td class="instruction">LD A,($7FD3)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ID of the telephone that Sam is holding</td>
</tr>
<tr>
<td class="address-1"><span id="77ed"></span>77ED</td>
<td class="instruction">LD HL,$6B4B</td>
<td class="comment-1" rowspan="1">The ringing phone location table is at <a href="6B4B.html">6B4B</a></td>
</tr>
<tr>
<td class="address-2"><span id="77f0"></span>77F0</td>
<td class="instruction">JP <a href="77A3.html">$77A3</a></td>
<td class="comment-1" rowspan="1">Check whether there is a message for Sam</td>
</tr>
<tr>
<td class="address-2"><span id="77f3"></span>77F3</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">Is the destination telephone ringing?</td>
</tr>
<tr>
<td class="address-1"><span id="77f5"></span>77F5</td>
<td class="instruction">JR Z,$7806</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="77f7"></span>77F7</td>
<td class="instruction">CALL <a href="F1E3.html">$F1E3</a></td>
<td class="comment-1" rowspan="1">Hang up if 'h' was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="77fa"></span>77FA</td>
<td class="instruction">CALL <a href="772F.html">$772F</a></td>
<td class="comment-1" rowspan="1">Is the telephone that Sam is calling either off-screen or close enough to a character that can pick it up?</td>
</tr>
<tr>
<td class="address-1"><span id="77fd"></span>77FD</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="77fe"></span>77FE</td>
<td class="instruction">LD A,($7F9A)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ID of the telephone that Sam is calling</td>
</tr>
<tr>
<td class="address-1"><span id="7801"></span>7801</td>
<td class="instruction">LD HL,$6B72</td>
<td class="comment-1" rowspan="1">The phone message table is at <a href="6B72.html">6B72</a></td>
</tr>
<tr>
<td class="address-1"><span id="7804"></span>7804</td>
<td class="instruction">JR $77F0</td>
<td class="comment-1" rowspan="1">Check whether Sam has called someone who has a message for him</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7806"></span>
<div class="comments">
<div class="paragraph">
Sam is still dialling the telephone number.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7806"></span>7806</td>
<td class="instruction">BIT 4,(HL)</td>
<td class="comment-1" rowspan="1">Are we currently making the sound effect of a digit being dialled?</td>
</tr>
<tr>
<td class="address-1"><span id="7808"></span>7808</td>
<td class="instruction">JR NZ,$7830</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="780a"></span>780A</td>
<td class="instruction">CALL <a href="F1E3.html">$F1E3</a></td>
<td class="comment-1" rowspan="1">Check for keypresses and hang up if 'h' was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="780d"></span>780D</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if no key with an ASCII code in the range 0x30-0x7F was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="780e"></span>780E</td>
<td class="instruction">CP $3A</td>
<td class="comment-1" rowspan="1">Was the ASCII code of the keypress greater than 0x39 ('9')?</td>
</tr>
<tr>
<td class="address-1"><span id="7810"></span>7810</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="7811"></span>7811</td>
<td class="instruction">CP $30</td>
<td class="comment-1" rowspan="1">Was the ASCII code less than 0x30 ('0')?</td>
</tr>
<tr>
<td class="address-1"><span id="7813"></span>7813</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="7814"></span>7814</td>
<td class="instruction">LD HL,$7F91</td>
<td class="comment-1" rowspan="5">Store the ASCII code of the digit in the first available space at <a href="7F92.html">7F92</a></td>
</tr>
<tr>
<td class="address-2"><span id="7817"></span>7817</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="7818"></span>7818</td>
<td class="instruction">BIT 5,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="781a"></span>781A</td>
<td class="instruction">JR NZ,$7817</td>
</tr>
<tr>
<td class="address-1"><span id="781c"></span>781C</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="781d"></span>781D</td>
<td class="instruction">SUB $30</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=digit that was dialled (0-9)</td>
</tr>
<tr>
<td class="address-1"><span id="781f"></span>781F</td>
<td class="instruction">JR NZ,$7823</td>
<td class="comment-1" rowspan="1">Jump unless '0' was dialled</td>
</tr>
<tr>
<td class="address-1"><span id="7821"></span>7821</td>
<td class="instruction">LD A,$0A</td>
<td class="comment-1" rowspan="1">The digit '0' will give 10 clicks</td>
</tr>
<tr>
<td class="address-2"><span id="7823"></span>7823</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=1-11</td>
</tr>
<tr>
<td class="address-1"><span id="7824"></span>7824</td>
<td class="instruction">LD ($E614),A</td>
<td class="comment-1" rowspan="1">Store this in byte 0x14 of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7827"></span>7827</td>
<td class="instruction">LD L,$9B</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="7F9B.html">7F9B</a> (telephone call status flags)</td>
</tr>
<tr>
<td class="address-1"><span id="7829"></span>7829</td>
<td class="instruction">LD (HL),$10</td>
<td class="comment-1" rowspan="1">Set bit 4</td>
</tr>
<tr>
<td class="address-1"><span id="782b"></span>782B</td>
<td class="instruction">LD A,$2A</td>
<td class="comment-1" rowspan="1">Message <a href="6A05.html">0x2A</a>: 'I DIALLED {number}'</td>
</tr>
<tr>
<td class="address-1"><span id="782d"></span>782D</td>
<td class="instruction">JP <a href="75CA.html">$75CA</a></td>
<td class="comment-1" rowspan="1">Queue this message urgently</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7830"></span>
<div class="comments">
<div class="paragraph">
The sound effect of a digit being dialled is currently in progress.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7830"></span>7830</td>
<td class="instruction">LD HL,$E608</td>
<td class="comment-1" rowspan="2">Set Sam's main action timer (in byte 0x08 of his buffer) to 3</td>
</tr>
<tr>
<td class="address-1"><span id="7833"></span>7833</td>
<td class="instruction">LD (HL),$03</td>
</tr>
<tr>
<td class="address-1"><span id="7835"></span>7835</td>
<td class="instruction">LD L,$14</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x14 of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7837"></span>7837</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Are there any more clicks to make?</td>
</tr>
<tr>
<td class="address-1"><span id="7838"></span>7838</td>
<td class="instruction">JP NZ,<a href="EC69.html">$EC69</a></td>
<td class="comment-1" rowspan="1">Make a click if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="783b"></span>
<div class="comments">
<div class="paragraph">
Sam has finished dialling a digit of the telephone number. Check whether the number dialled so far is valid.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="783b"></span>783B</td>
<td class="instruction">LD HL,$7F9B</td>
<td class="comment-1" rowspan="2">Clear all the telephone call status flags at <a href="7F9B.html">7F9B</a></td>
</tr>
<tr>
<td class="address-1"><span id="783e"></span>783E</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="7840"></span>7840</td>
<td class="instruction">LD L,$92</td>
<td class="comment-1" rowspan="2">Collect the ASCII code of the first digit that was dialled from <a href="7F92.html">7F92</a></td>
</tr>
<tr>
<td class="address-1"><span id="7842"></span>7842</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7843"></span>7843</td>
<td class="instruction">CP $30</td>
<td class="comment-1" rowspan="1">Was it '0'?</td>
</tr>
<tr>
<td class="address-1"><span id="7845"></span>7845</td>
<td class="instruction">JR Z,$7861</td>
<td class="comment-1" rowspan="1">Jump if so (no telephone numbers start with 0)</td>
</tr>
<tr>
<td class="address-1"><span id="7847"></span>7847</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="4">Add the ASCII codes of the second and third digits to the first</td>
</tr>
<tr>
<td class="address-1"><span id="7848"></span>7848</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7849"></span>7849</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="784a"></span>784A</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="784b"></span>784B</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the fourth digit</td>
</tr>
<tr>
<td class="address-1"><span id="784c"></span>784C</td>
<td class="instruction">CP $AB</td>
<td class="comment-1" rowspan="1">Set the zero flag if '999' was dialled</td>
</tr>
<tr>
<td class="address-1"><span id="784e"></span>784E</td>
<td class="instruction">LD A,$70</td>
<td class="comment-1" rowspan="1">0x70 is the ID of the telephone in the police station</td>
</tr>
<tr>
<td class="address-1"><span id="7850"></span>7850</td>
<td class="instruction">JR Z,$785A</td>
<td class="comment-1" rowspan="1">Jump if Sam has dialled the police</td>
</tr>
<tr>
<td class="address-1"><span id="7852"></span>7852</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">Has Sam dialled four digits yet?</td>
</tr>
<tr>
<td class="address-1"><span id="7854"></span>7854</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="7855"></span>7855</td>
<td class="instruction">CALL <a href="7A17.html">$7A17</a></td>
<td class="comment-1" rowspan="1">Has Sam dialled a valid telephone number?</td>
</tr>
<tr>
<td class="address-1"><span id="7858"></span>7858</td>
<td class="instruction">JR NZ,$7861</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-2"><span id="785a"></span>785A</td>
<td class="instruction">LD HL,$7FD3</td>
<td class="comment-1" rowspan="1"><a href="7FD3.html">7FD3</a> holds the ID of the telephone Sam is holding</td>
</tr>
<tr>
<td class="address-1"><span id="785d"></span>785D</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Does it match the ID of the telephone Sam is calling?</td>
</tr>
<tr>
<td class="address-1"><span id="785e"></span>785E</td>
<td class="instruction">JP NZ,<a href="7A0C.html">$7A0C</a></td>
<td class="comment-1" rowspan="1">Jump if not to place the call</td>
</tr>
<tr>
<td class="address-2"><span id="7861"></span>7861</td>
<td class="instruction">LD A,$2F</td>
<td class="comment-1" rowspan="1">Message <a href="6A4E.html">0x2F</a>: ' THE NUMBER WAS UNOBTAINABLE'</td>
</tr>
<tr>
<td class="address-1"><span id="7863"></span>7863</td>
<td class="instruction">JP <a href="776F.html#7799">$7799</a></td>
<td class="comment-1" rowspan="1">Disconnect the call and queue this message urgently</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="77A3.html">77A3</a>
</td>
<td class="up">Up: <a href="../maps/all.html#77d3">Map</a></td>
<td class="next">
Next: <a href="7866.html">7866</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/30675.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>