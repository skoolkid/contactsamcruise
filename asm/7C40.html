<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 7C40</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7C3F.html">7C3F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7c40">Map</a></td>
<td class="next">
Next: <a href="7CC7.html">7CC7</a>
</td>
</tr>
</table>
<div class="description">7C40: Check whether a character will soon be entering or leaving the hotel</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="ED8C.html">ED8C</a>. Checks whether a character will soon be entering or leaving the hotel, and if so, determines where he should start climbing the front steps (depending on his current location), or through which door he should leave (left or right, depending on his destination).
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0xD7-0xE6)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7c40"></span>7C40</td>
<td class="instruction">CALL <a href="ED36.html">$ED36</a></td>
<td class="comment-1" rowspan="1">Obtain an identifier for the character's current location</td>
</tr>
<tr>
<td class="address-1"><span id="7c43"></span>7C43</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the identifier</td>
</tr>
<tr>
<td class="address-1"><span id="7c44"></span>7C44</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the character on the sidewalk or the road?</td>
</tr>
<tr>
<td class="address-1"><span id="7c45"></span>7C45</td>
<td class="instruction">JR NZ,$7C70</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c47"></span>
<div class="comments">
<div class="paragraph">
The character is on the sidewalk or the road.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7c47"></span>7C47</td>
<td class="instruction">LD L,$0C</td>
<td class="comment-1" rowspan="2">Collect the character's destination location identifier from byte 0x0C of his buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7c49"></span>7C49</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7c4a"></span>7C4A</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">Keep only the region identifier bits (bits 4-7)</td>
</tr>
<tr>
<td class="address-1"><span id="7c4c"></span>7C4C</td>
<td class="instruction">CP $90</td>
<td class="comment-1" rowspan="1">Is the character going to the hotel?</td>
</tr>
<tr>
<td class="address-1"><span id="7c4e"></span>7C4E</td>
<td class="instruction">JR NZ,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c50"></span>
<div class="comments">
<div class="paragraph">
The character is on the sidewalk or road, and destined for somewhere inside or outside the hotel. Figure out which entrance (left or right) the character should use, based on his current location and his destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7c50"></span>7C50</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=destination location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="7c51"></span>7C51</td>
<td class="instruction">CP $95</td>
<td class="comment-1" rowspan="1">Set the carry flag if the destination is on the first floor or the front steps of the hotel</td>
</tr>
<tr>
<td class="address-1"><span id="7c53"></span>7C53</td>
<td class="instruction">LD L,$0A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x0A of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7c55"></span>7C55</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x' (the character's destination x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="7c56"></span>7C56</td>
<td class="instruction">JR C,$7C5A</td>
<td class="comment-1" rowspan="1">Jump if the destination is on the first floor or the front steps of the hotel (in which case 75&lt;=x'&lt;=82)</td>
</tr>
<tr>
<td class="address-1"><span id="7c58"></span>7C58</td>
<td class="instruction">LD A,$4F</td>
<td class="comment-1" rowspan="1">Assume x'=79 (the x-coordinate of the middle of the doorsteps of the hotel)</td>
</tr>
<tr>
<td class="address-2"><span id="7c5a"></span>7C5A</td>
<td class="instruction">LD L,$01</td>
<td class="comment-1" rowspan="2">Add x (the character's current x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="7c5c"></span>7C5C</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7c5d"></span>7C5D</td>
<td class="instruction">SUB $9E</td>
<td class="comment-1" rowspan="2">Reset the carry flag if 158-x'&lt;=x&lt;=285-x'</td>
</tr>
<tr>
<td class="address-1"><span id="7c5f"></span>7C5F</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="7c60"></span>7C60</td>
<td class="instruction">LD A,$58</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the rightmost front doorstep of the hotel</td>
</tr>
<tr>
<td class="address-1"><span id="7c62"></span>7C62</td>
<td class="instruction">JR NC,$7C66</td>
<td class="comment-1" rowspan="1">Jump if x&gt;=158-x' (the character will enter the hotel from the right)</td>
</tr>
<tr>
<td class="address-1"><span id="7c64"></span>7C64</td>
<td class="instruction">LD A,$43</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the leftmost front doorstep of the hotel</td>
</tr>
<tr>
<td class="address-2"><span id="7c66"></span>7C66</td>
<td class="instruction">LD BC,$FFA8</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the first byte of the entry that corresponds to the hotel in the data table of building entrance x-coordinates at <a href="FF98.html">FF98</a></td>
</tr>
<tr>
<td class="address-1"><span id="7c69"></span>7C69</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Set the first byte to 0x43 or 0x58</td>
</tr>
<tr>
<td class="address-1"><span id="7c6a"></span>7C6A</td>
<td class="instruction">ADD A,$02</td>
<td class="comment-1" rowspan="3">Set the second byte of the entry to 0x45 or 0x5A</td>
</tr>
<tr>
<td class="address-1"><span id="7c6c"></span>7C6C</td>
<td class="instruction">INC C</td>
</tr>
<tr>
<td class="address-1"><span id="7c6d"></span>7C6D</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-2"><span id="7c6e"></span>7C6E</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the identifier for the character's current location to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="7c6f"></span>7C6F</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c70"></span>
<div class="comments">
<div class="paragraph">
The character is not on the sidewalk or the road.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7c70"></span>7C70</td>
<td class="instruction">CP $95</td>
<td class="comment-1" rowspan="1">If the character's location identifier is at least 0x95, then he's not on the first floor or the front steps of the hotel</td>
</tr>
<tr>
<td class="address-1"><span id="7c72"></span>7C72</td>
<td class="instruction">JR NC,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if this is the case</td>
</tr>
<tr>
<td class="address-1"><span id="7c74"></span>7C74</td>
<td class="instruction">CP $91</td>
<td class="comment-1" rowspan="1">Is the character on the front steps of the hotel (below the level of the first floor)?</td>
</tr>
<tr>
<td class="address-1"><span id="7c76"></span>7C76</td>
<td class="instruction">JR Z,$7C8F</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7c78"></span>7C78</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">Keep only the region identifier bits (bits 4-7)</td>
</tr>
<tr>
<td class="address-1"><span id="7c7a"></span>7C7A</td>
<td class="instruction">CP $90</td>
<td class="comment-1" rowspan="1">Is the character on the first floor of the hotel?</td>
</tr>
<tr>
<td class="address-1"><span id="7c7c"></span>7C7C</td>
<td class="instruction">JR NZ,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c7e"></span>
<div class="comments">
<div class="paragraph">
The character is on the first floor of the hotel.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7c7e"></span>7C7E</td>
<td class="instruction">LD L,$0A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x0A of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7c80"></span>7C80</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x' (character's destination x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="7c81"></span>7C81</td>
<td class="instruction">LD L,$01</td>
<td class="comment-1" rowspan="2">Add x (the character's current x-coordinate; 75&lt;=x&lt;=82)</td>
</tr>
<tr>
<td class="address-1"><span id="7c83"></span>7C83</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7c84"></span>7C84</td>
<td class="instruction">SUB $9E</td>
<td class="comment-1" rowspan="2">Reset the carry flag if 158-x&lt;=x'&lt;=285-x</td>
</tr>
<tr>
<td class="address-1"><span id="7c86"></span>7C86</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="7c87"></span>7C87</td>
<td class="instruction">LD D,$4C</td>
<td class="comment-1" rowspan="1">Set <span class="register">D</span> (which holds the x-coordinate of the top of the steps going down to the sidewalk below) to 76 (x-coordinate of the left-hand entrance of the hotel)</td>
</tr>
<tr>
<td class="address-1"><span id="7c89"></span>7C89</td>
<td class="instruction">JR C,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if x'&lt;158-x (the character will exit the hotel on the left)</td>
</tr>
<tr>
<td class="address-1"><span id="7c8b"></span>7C8B</td>
<td class="instruction">LD D,$51</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the right-hand entrance of the hotel</td>
</tr>
<tr>
<td class="address-1"><span id="7c8d"></span>7C8D</td>
<td class="instruction">JR $7C6E</td>
<td class="comment-1" rowspan="1">Return to the caller with <span class="register">D</span> adjusted depending on the character's destination x-coordinate</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c8f"></span>
<div class="comments">
<div class="paragraph">
The character is on the front steps of the hotel (below the level of the first floor).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7c8f"></span>7C8F</td>
<td class="instruction">LD L,$0D</td>
<td class="comment-1" rowspan="2">Set the location/destination indicator in byte 0x0D of the character's buffer to 0 (the front steps of the hotel count as part of the sidewalk if the character is going somewhere other than the hotel)</td>
</tr>
<tr>
<td class="address-1"><span id="7c91"></span>7C91</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="7c93"></span>7C93</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x0C</td>
</tr>
<tr>
<td class="address-1"><span id="7c94"></span>7C94</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=destination location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="7c95"></span>7C95</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">Keep only the region identifier bits (bits 4-7)</td>
</tr>
<tr>
<td class="address-1"><span id="7c97"></span>7C97</td>
<td class="instruction">CP $90</td>
<td class="comment-1" rowspan="1">Is the character going to the hotel?</td>
</tr>
<tr>
<td class="address-1"><span id="7c99"></span>7C99</td>
<td class="instruction">JR NZ,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7c9b"></span>
<div class="comments">
<div class="paragraph">
The character is on the front steps of the hotel (below the level of the first floor), and his destination is somewhere inside or outside the hotel.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7c9b"></span>7C9B</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Set byte 0x0D of the character's buffer to 1 (indicating that the character is not on the sidewalk or the road, and is in the same region as his destination)</td>
</tr>
<tr>
<td class="address-1"><span id="7c9c"></span>7C9C</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7c9d"></span>7C9D</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x0C</td>
</tr>
<tr>
<td class="address-1"><span id="7c9e"></span>7C9E</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=destination location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="7c9f"></span>7C9F</td>
<td class="instruction">CP $95</td>
<td class="comment-1" rowspan="1">Is the destination on or below the first floor of the hotel?</td>
</tr>
<tr>
<td class="address-1"><span id="7ca1"></span>7CA1</td>
<td class="instruction">JR C,$7CC2</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7ca3"></span>
<div class="comments">
<div class="paragraph">
The character is on the front steps of the hotel (below the level of the first floor), and his destination is somewhere inside the hotel, above the first floor.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7ca3"></span>7CA3</td>
<td class="instruction">LD L,$01</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x01 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7ca5"></span>7CA5</td>
<td class="instruction">LD B,L</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=1 (go right)</td>
</tr>
<tr>
<td class="address-1"><span id="7ca6"></span>7CA6</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x (the character's x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="7ca7"></span>7CA7</td>
<td class="instruction">CP $4F</td>
<td class="comment-1" rowspan="1">Set the carry flag if x&lt;79</td>
</tr>
<tr>
<td class="address-1"><span id="7ca9"></span>7CA9</td>
<td class="instruction">LD A,$4C</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the left edge of the front door of the hotel</td>
</tr>
<tr>
<td class="address-1"><span id="7cab"></span>7CAB</td>
<td class="instruction">JR C,$7CAF</td>
<td class="comment-1" rowspan="1">Jump if x&lt;79</td>
</tr>
<tr>
<td class="address-1"><span id="7cad"></span>7CAD</td>
<td class="instruction">LD A,$52</td>
<td class="comment-1" rowspan="1">This is the x-coordinate of the right edge of the front door of the hotel</td>
</tr>
<tr>
<td class="address-2"><span id="7caf"></span>7CAF</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Compare <span class="register">A</span> (76 or 82) with x (the character's x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="7cb0"></span>7CB0</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x00 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7cb1"></span>7CB1</td>
<td class="instruction">JR C,$7CBB</td>
<td class="comment-1" rowspan="1">Jump if x is 77 or 78, or greater than 82 (meaning the character should go left to reach the hotel entrance)</td>
</tr>
<tr>
<td class="address-1"><span id="7cb3"></span>7CB3</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="address-1"><span id="7cb5"></span>7CB5</td>
<td class="instruction">JR NZ,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7cb7"></span>7CB7</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the identifier for the character's current location to <span class="register">A</span> (though it is ignored)</td>
</tr>
<tr>
<td class="address-2"><span id="7cb8"></span>7CB8</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=1 (go right) or 2 (go left)</td>
</tr>
<tr>
<td class="address-1"><span id="7cb9"></span>7CB9</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Drop the return address from the stack</td>
</tr>
<tr>
<td class="address-1"><span id="7cba"></span>7CBA</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return to the caller of <a href="ED8C.html">ED8C</a></td>
</tr>
<tr>
<td class="address-2"><span id="7cbb"></span>7CBB</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="address-1"><span id="7cbd"></span>7CBD</td>
<td class="instruction">JR Z,$7C6E</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7cbf"></span>7CBF</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=2 (go left)</td>
</tr>
<tr>
<td class="address-1"><span id="7cc0"></span>7CC0</td>
<td class="instruction">JR $7CB8</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7cc2"></span>
<div class="comments">
<div class="paragraph">
The character is on the front steps of the hotel (below the level of the first floor), and his destination is on or below the first floor of the hotel.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7cc2"></span>7CC2</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the identifier for the character's current location to <span class="register">A</span> (though it is ignored)</td>
</tr>
<tr>
<td class="address-1"><span id="7cc3"></span>7CC3</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Drop the return address from the stack</td>
</tr>
<tr>
<td class="address-1"><span id="7cc4"></span>7CC4</td>
<td class="instruction">JP <a href="ED8C.html#ed9b">$ED9B</a></td>
<td class="comment-1" rowspan="1">Re-enter the calling routine at <a href="ED8C.html#ed9b">ED9B</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7C3F.html">7C3F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7c40">Map</a></td>
<td class="next">
Next: <a href="7CC7.html">7CC7</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/31808.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>