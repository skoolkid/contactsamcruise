<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 7996</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7986.html">7986</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7996">Map</a></td>
<td class="next">
Next: <a href="79E4.html">79E4</a>
</td>
</tr>
</table>
<div class="description">7996: Collect a keypress during the game (or simulate one in demo mode)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Called from the main loop at <a href="F02B.html">F02B</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7996"></span>7996</td>
<td class="instruction">LD A,($7FEE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current game mode (0-4)</td>
</tr>
<tr>
<td class="address-1"><span id="7999"></span>7999</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it demo mode?</td>
</tr>
<tr>
<td class="address-1"><span id="799a"></span>799A</td>
<td class="instruction">JP NZ,<a href="EAB2.html">$EAB2</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="799d"></span>
<div class="comments">
<div class="paragraph">
It's demo mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="799d"></span>799D</td>
<td class="instruction">CALL <a href="EAD9.html">$EAD9</a></td>
<td class="comment-1" rowspan="1">Collect the ASCII code of the last key pressed in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="79a0"></span>79A0</td>
<td class="instruction">JP NZ,<a href="F0BE.html#f0ea">$F0EA</a></td>
<td class="comment-1" rowspan="1">Start a new game if a game key was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="79a3"></span>79A3</td>
<td class="instruction">LD A,$26</td>
<td class="comment-1" rowspan="1">Message <a href="69D1.html">0x26</a>: 'PRESS A KEY TO PLAY'</td>
</tr>
<tr>
<td class="address-1"><span id="79a5"></span>79A5</td>
<td class="instruction">LD ($7FD2),A</td>
<td class="comment-1" rowspan="1">Store this message number at <a href="7FD2.html">7FD2</a> so that it can be monitored</td>
</tr>
<tr>
<td class="address-1"><span id="79a8"></span>79A8</td>
<td class="instruction">CALL <a href="78FC.html#78ff">$78FF</a></td>
<td class="comment-1" rowspan="1">Is this message in the message queue?</td>
</tr>
<tr>
<td class="address-1"><span id="79ab"></span>79AB</td>
<td class="instruction">CALL NZ,<a href="6EC5.html">$6EC5</a></td>
<td class="comment-1" rowspan="1">If not, add it to the message queue (again)</td>
</tr>
<tr>
<td class="address-1"><span id="79ae"></span>79AE</td>
<td class="instruction">LD A,$F8</td>
<td class="comment-1" rowspan="2">Set bits 3-7 at <a href="7FEA.html">7FEA</a>, effectively giving Sam the keys to all the houses</td>
</tr>
<tr>
<td class="address-1"><span id="79b0"></span>79B0</td>
<td class="instruction">LD ($7FEA),A</td>
</tr>
<tr>
<td class="address-1"><span id="79b3"></span>79B3</td>
<td class="instruction">LD A,($E60B)</td>
<td class="comment-1" rowspan="1">Pick up byte 0x0B of Sam's buffer (which holds his destination y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="79b6"></span>79B6</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Has a destination been set for Sam yet?</td>
</tr>
<tr>
<td class="address-1"><span id="79b7"></span>79B7</td>
<td class="instruction">JR NZ,$79D4</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="79b9"></span>
<div class="comments">
<div class="paragraph">
We need to set a new destination for Sam.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="79b9"></span>79B9</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-1" rowspan="3">Get an even random number between 0x86 and 0x94 in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="79bc"></span>79BC</td>
<td class="instruction">AND $0E</td>
</tr>
<tr>
<td class="address-1"><span id="79be"></span>79BE</td>
<td class="instruction">ADD A,$86</td>
</tr>
<tr>
<td class="address-1"><span id="79c0"></span>79C0</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at an entry in the table of locations at <a href="7986.html">7986</a></td>
</tr>
<tr>
<td class="address-1"><span id="79c1"></span>79C1</td>
<td class="instruction">LD H,$79</td>
</tr>
<tr>
<td class="address-1"><span id="79c3"></span>79C3</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Collect the location coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="79c4"></span>79C4</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="79c5"></span>79C5</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="79c6"></span>79C6</td>
<td class="instruction">LD HL,$E60A</td>
<td class="comment-1" rowspan="4">Copy the location coordinates into bytes 0x0A and 0x0B of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="79c9"></span>79C9</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="address-1"><span id="79ca"></span>79CA</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="79cb"></span>79CB</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="address-1"><span id="79cc"></span>79CC</td>
<td class="instruction">LD C,$01</td>
<td class="comment-1" rowspan="1">Assume a z-coordinate of 1 (indoors)</td>
</tr>
<tr>
<td class="address-1"><span id="79ce"></span>79CE</td>
<td class="instruction">CALL <a href="ED36.html#ed47">$ED47</a></td>
<td class="comment-1" rowspan="1">Obtain an identifier for the location</td>
</tr>
<tr>
<td class="address-1"><span id="79d1"></span>79D1</td>
<td class="instruction">LD L,$0C</td>
<td class="comment-1" rowspan="2">Copy the destination location identifier into byte 0x0C of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="79d3"></span>79D3</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-2"><span id="79d4"></span>79D4</td>
<td class="instruction">LD H,$E6</td>
<td class="comment-1" rowspan="1">0xE6=Sam</td>
</tr>
<tr>
<td class="address-1"><span id="79d6"></span>79D6</td>
<td class="instruction">CALL <a href="ED8C.html">$ED8C</a></td>
<td class="comment-1" rowspan="1">Determine the next move Sam should make to reach his destination</td>
</tr>
<tr>
<td class="address-1"><span id="79d9"></span>79D9</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is Sam already at his destination?</td>
</tr>
<tr>
<td class="address-1"><span id="79da"></span>79DA</td>
<td class="instruction">JR Z,$79B9</td>
<td class="comment-1" rowspan="1">Jump back to set a new destination if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="79dc"></span>
<div class="comments">
<div class="paragraph">
Sam's destination has been set. Now to simulate a keypress that will make him take the next step towards it.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="79dc"></span>79DC</td>
<td class="instruction">ADD A,$7F</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the offset of the appropriate keypress to simulate in the table at <a href="7980.html">7980</a></td>
</tr>
<tr>
<td class="address-1"><span id="79de"></span>79DE</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="79df"></span>79DF</td>
<td class="instruction">LD H,$79</td>
</tr>
<tr>
<td class="address-1"><span id="79e1"></span>79E1</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the keypress offset</td>
</tr>
<tr>
<td class="address-1"><span id="79e2"></span>79E2</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Make sure the zero flag is reset to indicate that a simulated keypress was made (this instruction is redundant)</td>
</tr>
<tr>
<td class="address-1"><span id="79e3"></span>79E3</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7986.html">7986</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7996">Map</a></td>
<td class="next">
Next: <a href="79E4.html">79E4</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/31126.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>