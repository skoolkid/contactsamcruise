<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at F485</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="F436.html">F436</a></span></td>
<td class="up">Up: <a href="../maps/all.html#f485">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="F4E6.html">F4E6</a></span></td>
</tr>
</table>
<div class="description">F485: Make a character flip a light switch off or on occasionally</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="F5AC.html">F5AC</a> and <a href="F600.html">F600</a>. If the character is standing next to a light switch, this routine makes him flip the switch on (if it's off and affects the lights in more than one window or window-pair), or consider flipping the switch off (if it's on and affects the lights in only one window or window-pair).
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-229)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f485"></span>F485</td>
<td class="instruction">CALL <a href="F436.html">$F436</a></td>
<td class="comment-11" rowspan="1">Is the character standing next to a light switch?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f488"></span>F488</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f489"></span>F489</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-11" rowspan="1">Does the light switch affect lights in more than one window or window-pair?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f48b"></span>F48B</td>
<td class="instruction">JR NZ,$F4A2</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f48d"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F5A0.html">F5A0</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f48d"></span>F48D</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=window flags for the character's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f48e"></span>F48E</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-11" rowspan="1">Is the light switch here in the 'off' position?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f490"></span>F490</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f491"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F4E6.html">F4E6</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f491"></span>F491</td>
<td class="instruction">CALL <a href="F17F.html">$F17F</a></td>
<td class="comment-11" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f494"></span>F494</td>
<td class="instruction">CP $6E</td>
<td class="comment-11" rowspan="1">Is it greater than 109?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f496"></span>F496</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f497"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="717C.html">717C</a> and <a href="7576.html">7576</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f497"></span>F497</td>
<td class="instruction">LD A,$20</td>
<td class="comment-11" rowspan="1">Bit 5 set: light switch toggle</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f499"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="758C.html">758C</a> (with <span class="register">A</span>=1 or 64), <a href="7866.html">7866</a> (with <span class="register">A</span>=0) and <a href="F6E9.html">F6E9</a> (with <span class="register">A</span>=1, 32 or 64).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f499"></span>F499</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Push the address of the window flags onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f49a"></span>F49A</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1">Transfer this address into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f49b"></span>F49B</td>
<td class="instruction">XOR (HL)</td>
<td class="comment-11" rowspan="2">Flip bit 1, 5 or 6 of the window flags, thus flipping the light switch that affects the window, or raising or lowering the blind</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f49c"></span>F49C</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f49d"></span>F49D</td>
<td class="instruction">CALL <a href="F3A0.html">$F3A0</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the window</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a0"></span>F4A0</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a1"></span>F4A1</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4a2"></span>
<div class="comments">
<div class="paragraph">
The character is standing next to a light switch that affects lights in more than one window or window-pair.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4a2"></span>F4A2</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=window flags for the character's location</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4a3"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="717C.html">717C</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4a3"></span>F4A3</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-11" rowspan="1">Is the light switch here in the 'on' position?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a5"></span>F4A5</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4a6"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="7576.html">7576</a>, <a href="7866.html">7866</a> and <a href="F4E6.html">F4E6</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4a6"></span>F4A6</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Push the address of the window flags onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a7"></span>F4A7</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1">Transfer this address into <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a8"></span>F4A8</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=LSB of the address of the window flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4a9"></span>F4A9</td>
<td class="instruction">LD BC,$0420</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=4 (the four central windows on a floor of the hotel span four 8-tile wide segments), <span class="register">C</span>=32 (bit 5 set: light switch toggle)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ac"></span>F4AC</td>
<td class="instruction">CP $48</td>
<td class="comment-11" rowspan="1">Are we dealing with a window that is second from the left in the hotel?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ae"></span>F4AE</td>
<td class="instruction">JR NZ,$F4C1</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4b0"></span>
<div class="comments">
<div class="paragraph">
A light switch that affects the lights in the the four central windows on one of the floors of the hotel has been flipped.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4b0"></span>F4B0</td>
<td class="instruction">LD L,$48</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the window flags for the leftmost of the four central windows</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4b2"></span>F4B2</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the window flags pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4b3"></span>F4B3</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the segment counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4b4"></span>F4B4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Flip bit 5 of the window flags, thus flipping the light switch into the 'on' or 'off' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4b5"></span>F4B5</td>
<td class="instruction">XOR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4b6"></span>F4B6</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4b7"></span>F4B7</td>
<td class="instruction">CALL <a href="F3A0.html">$F3A0</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the window</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ba"></span>F4BA</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the segment counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4bb"></span>F4BB</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the window flags pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4bc"></span>F4BC</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move to the next window along</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4bd"></span>F4BD</td>
<td class="instruction">DJNZ $F4B2</td>
<td class="comment-11" rowspan="1">Jump back until all four windows have been done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4bf"></span>F4BF</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c0"></span>F4C0</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4c1"></span>F4C1</td>
<td class="instruction">CP $4B</td>
<td class="comment-11" rowspan="1">Are we dealing with a window that is second from the right in the hotel?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c3"></span>F4C3</td>
<td class="instruction">JR Z,$F4B0</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="f4c5"></span>
<div class="comments">
<div class="paragraph">
A light switch that affects the lights in the windows on more than one floor of a building other than the hotel has been flipped.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c5"></span>F4C5</td>
<td class="instruction">SUB C</td>
<td class="comment-11" rowspan="1">Subtract 32 from the LSB of the window flags address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c6"></span>F4C6</td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=3 (there are three floors to consider)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c7"></span>F4C7</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c8"></span>F4C8</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the fixture location flags for the area on the fourth floor (if any) above the light switch</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4c9"></span>F4C9</td>
<td class="instruction">LD H,$BA</td>
<td class="comment-11" rowspan="1">The fourth floor window flags are in bytes 64-95 of page 186 (at <a href="BA40.html">BA40</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4cb"></span>F4CB</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Collect the fixture location flags for the fourth floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4cc"></span>F4CC</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-11" rowspan="1">Does the light switch affect any windows on this floor?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4ce"></span>F4CE</td>
<td class="instruction">JR Z,$F4DD</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d0"></span>F4D0</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the window flags pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d1"></span>F4D1</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the fixture location flags pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d2"></span>F4D2</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the floor counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d3"></span>F4D3</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Flip bit 5 of the window flags, thus flipping the light switch into the 'on' or 'off' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d4"></span>F4D4</td>
<td class="instruction">XOR $20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d6"></span>F4D6</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4d7"></span>F4D7</td>
<td class="instruction">CALL <a href="F3A0.html">$F3A0</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the windows on this floor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4da"></span>F4DA</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the floor counter to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4db"></span>F4DB</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the fixture location flags pointer to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4dc"></span>F4DC</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the window flags pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="f4dd"></span>F4DD</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the window flags for the next floor down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4de"></span>F4DE</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="3">Point <span class="register">DE</span> at the fixture location flags for the next floor down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4df"></span>F4DF</td>
<td class="instruction">ADD A,$20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e1"></span>F4E1</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e2"></span>F4E2</td>
<td class="instruction">DJNZ $F4CB</td>
<td class="comment-11" rowspan="1">Jump back until the windows on the fourth, third and second floors have been dealt with</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e4"></span>F4E4</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="f4e5"></span>F4E5</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="F436.html">F436</a></span></td>
<td class="up">Up: <a href="../maps/all.html#f485">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="F4E6.html">F4E6</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20160123</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2016 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.1.</div>
</footer>
</body>
</html>