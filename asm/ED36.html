<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at ED36</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="ED30.html">ED30</a>
</td>
<td class="up">Up: <a href="../maps/all.html#ed36">Map</a></td>
<td class="next">
Next: <a href="ED8A.html">ED8A</a>
</td>
</tr>
</table>
<div class="description">ED36: Obtain an identifier for a character's current location</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7C40.html">7C40</a>. Returns with <span class="register">A</span>=0xFF if the character's z-coordinate is 2 or 4, and his y-coordinate is less than 31 (meaning he is on the fire escape of the apartment building next to no. 19, or falling from the roof of a building); with <span class="register">A</span>=0x00 if he's on the sidewalk or the road; or with certain bits of <span class="register">A</span> set or reset depending on the location:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Bit(s)</th>
<th colspan="1" rowspan="1">Meaning</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="2">0</td>
<td class="" colspan="1" rowspan="1">0: On the floor of a shop or other building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">1: On a staircase between floors, or on the front steps of a building below the first floor, or on the rim of a roof</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="7">1-3</td>
<td class="" colspan="1" rowspan="1">000: On the front steps of a building below the first floor</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">001: Next to the entrance to a shop or other building (outside)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">010: Shop or first floor of other building (inside)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">011: Second floor of a building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">100: Third floor of a building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">101: Fourth floor of a building (could be the roof)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">110: Fifth floor of a building (could be the roof)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4-7</td>
<td class="" colspan="1" rowspan="1">Region ID (see below)</td>
</tr>
</table>
</div>
<div class="paragraph">
The region ID in bits 4-7 corresponds to a certain shop or other building in the play area:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Region ID</th>
<th colspan="1" rowspan="1">Building</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0001</td>
<td class="" colspan="1" rowspan="1">Left-hand shop under the apartments next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0010</td>
<td class="" colspan="1" rowspan="1">Right-hand shop under the apartments next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0011</td>
<td class="" colspan="1" rowspan="1">Shop under no. 17</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0100</td>
<td class="" colspan="1" rowspan="1">Shop under no. 15</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0101</td>
<td class="" colspan="1" rowspan="1">Apartment building next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0110</td>
<td class="" colspan="1" rowspan="1">Police station</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0111</td>
<td class="" colspan="1" rowspan="1">No. 27</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1000</td>
<td class="" colspan="1" rowspan="1">No. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1001</td>
<td class="" colspan="1" rowspan="1">Hotel</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1010</td>
<td class="" colspan="1" rowspan="1">No. 31</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1011</td>
<td class="" colspan="1" rowspan="1">No. 19</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1100</td>
<td class="" colspan="1" rowspan="1">No. 17</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1101</td>
<td class="" colspan="1" rowspan="1">Unused</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1110</td>
<td class="" colspan="1" rowspan="1">No. 15</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1111</td>
<td class="" colspan="1" rowspan="1">Apartment building next to no. 19</td>
</tr>
</table>
</div>
<div class="paragraph">
In addition, on return <span class="register">E</span> holds the x-coordinate of the bottom of the staircase going up to the floor above, and <span class="register">D</span> holds the x-coordinate of the top of the staircase going down to the floor below.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0xD7-0xE6)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="ed36"></span>ED36</td>
<td class="instruction">LD L,$01</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="ed38"></span>ED38</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="ed39"></span>ED39</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=character's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="ed3a"></span>ED3A</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="ed3b"></span>ED3B</td>
<td class="instruction">LD L,$04</td>
<td class="comment-1" rowspan="2"><span class="register">C</span>=character's z-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="ed3d"></span>ED3D</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="ed3e"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="7190.html">7190</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="ed3e"></span>ED3E</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Is the z-coordinate 1 (indoors)?</td>
</tr>
<tr>
<td class="address-1"><span id="ed40"></span>ED40</td>
<td class="instruction">JR NZ,$ED47</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="ed42"></span>ED42</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="ed43"></span>ED43</td>
<td class="instruction">CP $1F</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=0xFF if the y-coordinate is less than 31, 0x00 otherwise</td>
</tr>
<tr>
<td class="address-1"><span id="ed45"></span>ED45</td>
<td class="instruction">SBC A,A</td>
</tr>
<tr>
<td class="address-1"><span id="ed46"></span>ED46</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return with <span class="register">A</span>=0xFF if the y-coordinate is less than 31, and the z-coordinate is 2 or 4</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="ed47"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="7996.html">7996</a> and <a href="7A39.html">7A39</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="ed47"></span>ED47</td>
<td class="instruction">CALL <a href="EAF8.html#eaff">$EAFF</a></td>
<td class="comment-1" rowspan="1">Check whether the character is on the sidewalk or road</td>
</tr>
<tr>
<td class="address-1"><span id="ed4a"></span>ED4A</td>
<td class="instruction">LD A,$00</td>
<td class="comment-1" rowspan="2">Return with <span class="register">A</span>=0 if the character is on the sidewalk or road</td>
</tr>
<tr>
<td class="address-1"><span id="ed4c"></span>ED4C</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="ed4d"></span>
<div class="comments">
<div class="paragraph">
At this point we have determined that the character is on the front steps of or inside a building.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="ed4d"></span>ED4D</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="address-1"><span id="ed4e"></span>ED4E</td>
<td class="instruction">LD A,$25</td>
<td class="comment-1" rowspan="6"><span class="register">L</span>=0x0A (if 31&lt;<span class="register">D</span>), 0x0B (25&lt;<span class="register">D</span>&lt;=31), 0x0C (19&lt;<span class="register">D</span>&lt;=25), 0x0D (13&lt;<span class="register">D</span>&lt;=19), 0x0E (7&lt;<span class="register">D</span>&lt;=13) or 0x0F (1&lt;<span class="register">D</span>&lt;=7)</td>
</tr>
<tr>
<td class="address-1"><span id="ed50"></span>ED50</td>
<td class="instruction">LD L,$09</td>
</tr>
<tr>
<td class="address-2"><span id="ed52"></span>ED52</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="ed53"></span>ED53</td>
<td class="instruction">SUB $06</td>
</tr>
<tr>
<td class="address-1"><span id="ed55"></span>ED55</td>
<td class="instruction">CP D</td>
</tr>
<tr>
<td class="address-1"><span id="ed56"></span>ED56</td>
<td class="instruction">JR NC,$ED52</td>
</tr>
<tr>
<td class="address-1"><span id="ed58"></span>ED58</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="2">Set the zero flag if <span class="register">D</span>=7, 13, 19, 25 or 31 (corresponding to the floor of a building)</td>
</tr>
<tr>
<td class="address-1"><span id="ed59"></span>ED59</td>
<td class="instruction">ADD A,$06</td>
</tr>
<tr>
<td class="address-1"><span id="ed5b"></span>ED5B</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="ed5c"></span>ED5C</td>
<td class="instruction">LD H,$EF</td>
<td class="comment-1" rowspan="1">The region identifier tables are in page 0xEF</td>
</tr>
<tr>
<td class="address-1"><span id="ed5e"></span>ED5E</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="ed5f"></span>ED5F</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at one of the tables at <a href="EF0A.html#ef10">EF10</a>, <a href="EF0A.html#ef48">EF48</a>, <a href="EF0A.html#ef70">EF70</a>, <a href="EF0A.html#ef98">EF98</a>, <a href="EF0A.html#efc0">EFC0</a> and <a href="EF0A.html#efe8">EFE8</a></td>
</tr>
<tr>
<td class="address-2"><span id="ed60"></span>ED60</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="6">Find the first entry whose first byte is greater than <span class="register">A</span> (the target x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="ed61"></span>ED61</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="ed62"></span>ED62</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="ed63"></span>ED63</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="ed64"></span>ED64</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="ed65"></span>ED65</td>
<td class="instruction">JR NC,$ED60</td>
</tr>
<tr>
<td class="address-1"><span id="ed67"></span>ED67</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=fourth byte of the entry (x-coordinate of the bottom of the staircase going up to the floor above)</td>
</tr>
<tr>
<td class="address-1"><span id="ed68"></span>ED68</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="ed69"></span>ED69</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=third byte of the entry (x-coordinate of the top of the staircase going down to the floor below)</td>
</tr>
<tr>
<td class="address-1"><span id="ed6a"></span>ED6A</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="ed6b"></span>ED6B</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=second byte of the entry (location identifier)</td>
</tr>
<tr>
<td class="address-1"><span id="ed6c"></span>ED6C</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="ed6d"></span>ED6D</td>
<td class="instruction">CP $50</td>
<td class="comment-1" rowspan="1">Is the second byte of the entry less than 0x50?</td>
</tr>
<tr>
<td class="address-1"><span id="ed6f"></span>ED6F</td>
<td class="instruction">JR NC,$ED7A</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="ed71"></span>
<div class="comments">
<div class="paragraph">
The second byte of the entry is less than 0x50, which is true only for the four entries in the region identifier table at <a href="EF0A.html#ef10">EF10</a> that correspond to the shops.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="ed71"></span>ED71</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag (though the values are ignored at this point)</td>
</tr>
<tr>
<td class="address-2"><span id="ed72"></span>ED72</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="ed73"></span>ED73</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Set the zero flag if the z-coordinate is 1 (indoors)</td>
</tr>
<tr>
<td class="address-1"><span id="ed75"></span>ED75</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="ed76"></span>ED76</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if the z-coordinate is 1</td>
</tr>
<tr>
<td class="address-1"><span id="ed77"></span>ED77</td>
<td class="instruction">SUB $02</td>
<td class="comment-1" rowspan="1">Reset bit 2 of <span class="register">A</span>, and set bit 1 (to indicate that the character is standing outside the door of a shop or house)</td>
</tr>
<tr>
<td class="address-1"><span id="ed79"></span>ED79</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="ed7a"></span>
<div class="comments">
<div class="paragraph">
The second byte of the entry (held in <span class="register">A</span>) is at least 0x50, which means it corresponds to a location other than one of the four shops.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="ed7a"></span>ED7A</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">Keep only bits 0-3 of the location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="ed7c"></span>ED7C</td>
<td class="instruction">CP $04</td>
<td class="comment-1" rowspan="1">Is this location on the first floor of a building?</td>
</tr>
<tr>
<td class="address-1"><span id="ed7e"></span>ED7E</td>
<td class="instruction">JR NZ,$ED84</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="ed80"></span>ED80</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="ed81"></span>ED81</td>
<td class="instruction">JR Z,$ED72</td>
<td class="comment-1" rowspan="1">Jump if the y-coordinate corresponds to a floor of a building</td>
</tr>
<tr>
<td class="address-1"><span id="ed83"></span>ED83</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> and the zero flag again</td>
</tr>
<tr>
<td class="address-2"><span id="ed84"></span>ED84</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="ed85"></span>ED85</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="ed86"></span>ED86</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="ed87"></span>ED87</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if the y-coordinate corresponds to a floor of a building</td>
</tr>
<tr>
<td class="address-1"><span id="ed88"></span>ED88</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set bit 0 of <span class="register">A</span> to indicate that the character is on a staircase between two floors of a building, or on the front steps of a building below the first floor, or on the rim of a roof</td>
</tr>
<tr>
<td class="address-1"><span id="ed89"></span>ED89</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="ED30.html">ED30</a>
</td>
<td class="up">Up: <a href="../maps/all.html#ed36">Map</a></td>
<td class="next">
Next: <a href="ED8A.html">ED8A</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/60726.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>