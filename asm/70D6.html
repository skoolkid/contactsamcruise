<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 70D6</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="70D5.html">70D5</a></span></td>
<td class="up">Up: <a href="../maps/all.html#70d6">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="710C.html">710C</a></span></td>
</tr>
</table>
<div class="description">70D6: Check whether a character is visible to passers-by</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7222.html">7222</a>. Returns with the zero flag set if the character is not inside any building, or is in the stairwell of the police station or one of the apartment buildings, or is on the catwalk, or is on the roof of a building.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0xD7-0xE6)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="70d6"></span>70D6</td>
<td class="instruction">LD L,$04</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x04 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70d8"></span>70D8</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the character indoors?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70da"></span>70DA</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with the zero flag set if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="70db"></span>
<div class="comments">
<div class="paragraph">
The character is indoors, so examine his location more precisely.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70db"></span>70DB</td>
<td class="instruction">LD L,$01</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0x01 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70dd"></span>70DD</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x (character's x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70de"></span>70DE</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=INT((x+1)/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70df"></span>70DF</td>
<td class="instruction">AND $F8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e1"></span>70E1</td>
<td class="instruction">CP $08</td>
<td class="comment-11" rowspan="2">Return if 7&lt;=x&lt;=14 (the character is in the stairwell of the apartment building at the far left of town)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e3"></span>70E3</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e4"></span>70E4</td>
<td class="instruction">CP $88</td>
<td class="comment-11" rowspan="2">Return if 135&lt;=x&lt;=142 (the character is in the stairwell of the police station)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e6"></span>70E6</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e7"></span>70E7</td>
<td class="instruction">CP $C0</td>
<td class="comment-11" rowspan="2">Return if 191&lt;=x&lt;=198 (the character is in the stairwell of the apartment building next to no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70e9"></span>70E9</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70ea"></span>70EA</td>
<td class="instruction">CP $18</td>
<td class="comment-11" rowspan="2">Return if 23&lt;=x&lt;=30 (the character is on the catwalk)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70ec"></span>70EC</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="70ed"></span>
<div class="comments">
<div class="paragraph">
The character is neither on the catwalk, nor in a stairwell that is visible from outside.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70ed"></span>70ED</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x (the character's x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70ee"></span>70EE</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0x00 (this should be 'INC L', so that <span class="register">HL</span> points at the character's y-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70ef"></span>70EF</td>
<td class="instruction">CP $38</td>
<td class="comment-11" rowspan="2">Jump if x&lt;56 (the character is in no. 74 or the apartment building next to it)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70f1"></span>70F1</td>
<td class="instruction">JR C,$7102</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70f3"></span>70F3</td>
<td class="instruction">CP $68</td>
<td class="comment-11" rowspan="2">Return with the zero flag reset if 56&lt;=x&lt;=103 (the character is in the hotel, whose roof is inaccessible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70f5"></span>70F5</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70f6"></span>70F6</td>
<td class="instruction">CP $7B</td>
<td class="comment-11" rowspan="2">Jump if 104&lt;=x&lt;=122 (the character is in no. 31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70f8"></span>70F8</td>
<td class="instruction">JR C,$7106</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70fa"></span>70FA</td>
<td class="instruction">CP $CF</td>
<td class="comment-11" rowspan="2">Jump if 123&lt;=x&lt;=206 (the character is in the police station, no. 27 or the apartment building next to no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70fc"></span>70FC</td>
<td class="instruction">JR C,$7102</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="70fe"></span>70FE</td>
<td class="instruction">CP $DE</td>
<td class="comment-11" rowspan="2">Jump if 207&lt;=x&lt;=221 (the character is in no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7100"></span>7100</td>
<td class="instruction">JR C,$7106</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="7102"></span>
<div class="comments">
<div class="paragraph">
If we get here, then the character is in the apartment building at the far left of town, no. 74, the police station, no. 27, the apartment building next to no. 19, no. 17, or no. 15.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7102"></span>7102</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="1">If the character's y-coordinate is greater than this, he's inside (as opposed to on the roof)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7104"></span>7104</td>
<td class="instruction">JR $7108</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="7106"></span>
<div class="comments">
<div class="paragraph">
If we get here, then the character is in no. 31 or no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7106"></span>7106</td>
<td class="instruction">LD A,$0E</td>
<td class="comment-11" rowspan="1">If the character's y-coordinate is greater than this, he's inside (as opposed to on the roof)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="7108"></span>
<div class="comments">
<div class="paragraph">
The next instruction is supposed to compare <span class="register">A</span> with the character's y-coordinate to see whether he's on the roof of a building (as opposed to inside it), but because of the erroneous 'DEC L' instruction above, it instead compares <span class="register">A</span> with the character's animatory state. This is a <a href="../reference/bugs.html#troubleHiding">bug</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="7108"></span>7108</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Compare <span class="register">A</span> (8 or 14) with the character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="7109"></span>7109</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the zero flag reset if <span class="register">A</span> is smaller</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="710a"></span>710A</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set the zero flag (the character is visible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="710b"></span>710B</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="70D5.html">70D5</a></span></td>
<td class="up">Up: <a href="../maps/all.html#70d6">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="710C.html">710C</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20181020</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2018 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.0.</div>
<div><a href="http://skoolkit.ca/disassemblies/contact_sam_cruise/asm/28886.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>