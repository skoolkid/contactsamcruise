<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 63838</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63837.html">63837</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63838">Map</a></td>
<td class="next">
Next: <a href="63953.html">63953</a>
</td>
</tr>
</table>
<div class="description">63838: Change Sam's disguise</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Continues from the routine at <a href="64218.html">64218</a>. Replaces certain sprite tiles that are used by Sam's animatory states (thus changing his appearance), and then draws Sam's new disguise in the bottom right corner of the screen.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">230 (Sam)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="63838"></span>63838</td>
<td class="instruction">LD L,8</td>
<td class="comment-1" rowspan="2">Set Sam's main action timer (in byte 8 of his buffer) to 8</td>
</tr>
<tr>
<td class="address-1"><span id="63840"></span>63840</td>
<td class="instruction">LD (HL),L</td>
</tr>
<tr>
<td class="address-1"><span id="63841"></span>63841</td>
<td class="instruction">LD HL,32713</td>
<td class="comment-1" rowspan="1"><a href="32713.html">32713</a> holds Sam's current disguise ID</td>
</tr>
<tr>
<td class="address-1"><span id="63844"></span>63844</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63845"></span>63845</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=next disguise ID (0-7)</td>
</tr>
<tr>
<td class="address-1"><span id="63846"></span>63846</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="63848"></span>63848</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store the new disguise ID</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63849"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="30989.html">30989</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63849"></span>63849</td>
<td class="instruction">CALL <a href="32009.html#32010">32010</a></td>
<td class="comment-1" rowspan="1">Set the attribute bytes for Sam's current disguise</td>
</tr>
<tr>
<td class="address-1"><span id="63852"></span>63852</td>
<td class="instruction">LD A,(32713)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Sam's disguise ID (0-7)</td>
</tr>
<tr>
<td class="address-1"><span id="63855"></span>63855</td>
<td class="instruction">ADD A,223</td>
<td class="comment-1" rowspan="3">Point <span class="register">BC</span> at the reference for the first replacement tile (in the data table at <a href="57150.html">57150</a>, <a href="57406.html">57406</a>, <a href="57662.html">57662</a>, <a href="57918.html">57918</a>, <a href="58174.html">58174</a>, <a href="58430.html">58430</a>, <a href="58686.html">58686</a> or <a href="58942.html">58942</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="63857"></span>63857</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="63858"></span>63858</td>
<td class="instruction">LD C,62</td>
</tr>
<tr>
<td class="address-1"><span id="63860"></span>63860</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63861"></span>63861</td>
<td class="instruction">LD HL,56893</td>
<td class="comment-1" rowspan="1"><span class="register">HL'</span> will index the sprite tile reference data table at <a href="56894.html">56894</a></td>
</tr>
<tr>
<td class="address-1"><span id="63864"></span>63864</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="63865"></span>63865</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63866"></span>63866</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL'</span> at the next sprite tile reference</td>
</tr>
<tr>
<td class="address-1"><span id="63867"></span>63867</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Collect the tile reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63868"></span>63868</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63869"></span>63869</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Have we reached the end of the table?</td>
</tr>
<tr>
<td class="address-1"><span id="63870"></span>63870</td>
<td class="instruction">JR Z,63914</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="63872"></span>63872</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">DE</span> at the first byte of graphic data for this sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63873"></span>63873</td>
<td class="instruction">LD D,199</td>
</tr>
<tr>
<td class="address-1"><span id="63875"></span>63875</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=reference for the replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63876"></span>63876</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the reference for the next replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63877"></span>63877</td>
<td class="instruction">CP 126</td>
<td class="comment-1" rowspan="1">Set the carry flag if the tile reference is &lt; 126</td>
</tr>
<tr>
<td class="address-1"><span id="63879"></span>63879</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=reference for the replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63880"></span>63880</td>
<td class="instruction">JR NC,63900</td>
<td class="comment-1" rowspan="1">Jump if we're dealing with a tile reference &gt;= 126</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63882"></span>
<div class="comments">
<div class="paragraph">
We're dealing with a replacement tile (of Sam in disguise) whose reference is &lt; 126. The graphic data for such tiles is arranged in 8 pairs (graphic byte, mask byte) in bytes 80-125 across pages 223-230.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63882"></span>63882</td>
<td class="instruction">LD H,223</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the graphic data for the replacement tile</td>
</tr>
<tr>
<td class="address-2"><span id="63884"></span>63884</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Copy a byte of graphic data from the replacement tile into the target sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63885"></span>63885</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="63886"></span>63886</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next byte of mask data for the target sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63887"></span>63887</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next byte of mask data for the replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63888"></span>63888</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="2">Copy a byte of mask data from the replacement tile into the target sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63889"></span>63889</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="63890"></span>63890</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next byte of graphic data for the target sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63891"></span>63891</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the next byte of graphic data for the replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63892"></span>63892</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="63893"></span>63893</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Have we copied the replacement tile over the target sprite tile yet?</td>
</tr>
<tr>
<td class="address-1"><span id="63894"></span>63894</td>
<td class="instruction">CP 231</td>
</tr>
<tr>
<td class="address-1"><span id="63896"></span>63896</td>
<td class="instruction">JR NZ,63884</td>
<td class="comment-1" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="address-1"><span id="63898"></span>63898</td>
<td class="instruction">JR 63865</td>
<td class="comment-1" rowspan="1">Jump back to deal with the next replacement tile</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63900"></span>
<div class="comments">
<div class="paragraph">
We're dealing with a replacement tile whose reference is &gt;= 126. The graphic data for such tiles is arranged in groups of 16 (8 pairs of graphic bytes and mask bytes) across pages 215-230.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63900"></span>63900</td>
<td class="instruction">LD H,215</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the graphic data for the replacement tile</td>
</tr>
<tr>
<td class="address-1"><span id="63902"></span>63902</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the replacement tile reference pointer</td>
</tr>
<tr>
<td class="address-1"><span id="63903"></span>63903</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="1">There are 16 bytes of graphic and mask data to copy</td>
</tr>
<tr>
<td class="address-2"><span id="63905"></span>63905</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="5">Copy the replacement tile over the target sprite tile</td>
</tr>
<tr>
<td class="address-1"><span id="63906"></span>63906</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="63907"></span>63907</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="63908"></span>63908</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="63909"></span>63909</td>
<td class="instruction">DJNZ 63905</td>
</tr>
<tr>
<td class="address-1"><span id="63911"></span>63911</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the replacement tile reference pointer to <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="63912"></span>63912</td>
<td class="instruction">JR 63865</td>
<td class="comment-1" rowspan="1">Jump back to deal with the next replacement tile</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63914"></span>
<div class="comments">
<div class="paragraph">
Now we can draw Sam's disguise in the bottom right of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63914"></span>63914</td>
<td class="instruction">LD HL,55170</td>
<td class="comment-1" rowspan="1">This is the address of the tile reference for the top-left tile in Sam's sprite (animatory state <a href="../graphics/as.html#0">0</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="63917"></span>63917</td>
<td class="instruction">LD DE,20669</td>
<td class="comment-1" rowspan="1">20669 is the display file address for the leftmost byte in the top row of pixels of Sam's disguise in the bottom right of the screen</td>
</tr>
<tr>
<td class="address-2"><span id="63920"></span>63920</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the sprite tile reference pointer</td>
</tr>
<tr>
<td class="address-1"><span id="63921"></span>63921</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the first byte of graphic data for this tile</td>
</tr>
<tr>
<td class="address-1"><span id="63922"></span>63922</td>
<td class="instruction">LD H,199</td>
</tr>
<tr>
<td class="address-2"><span id="63924"></span>63924</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="7">Copy the tile to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="63925"></span>63925</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="63926"></span>63926</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="63927"></span>63927</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="63928"></span>63928</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="63929"></span>63929</td>
<td class="instruction">BIT 3,D</td>
</tr>
<tr>
<td class="address-1"><span id="63931"></span>63931</td>
<td class="instruction">JR Z,63924</td>
</tr>
<tr>
<td class="address-1"><span id="63933"></span>63933</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the sprite tile reference pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="63934"></span>63934</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next tile reference</td>
</tr>
<tr>
<td class="address-1"><span id="63935"></span>63935</td>
<td class="instruction">LD D,80</td>
<td class="comment-1" rowspan="4">Set <span class="register">DE</span> to the display file address for the next tile</td>
</tr>
<tr>
<td class="address-1"><span id="63937"></span>63937</td>
<td class="instruction">LD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="63938"></span>63938</td>
<td class="instruction">ADD A,32</td>
</tr>
<tr>
<td class="address-1"><span id="63940"></span>63940</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="63941"></span>63941</td>
<td class="instruction">JR NC,63920</td>
<td class="comment-1" rowspan="1">Jump back unless we've finished a column of three tiles</td>
</tr>
<tr>
<td class="address-1"><span id="63943"></span>63943</td>
<td class="instruction">CP 31</td>
<td class="comment-1" rowspan="1">Have we just finished the third column?</td>
</tr>
<tr>
<td class="address-1"><span id="63945"></span>63945</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="63946"></span>63946</td>
<td class="instruction">SUB 95</td>
<td class="comment-1" rowspan="2">Set <span class="register">DE</span> to the display file address for the first tile in the next column</td>
</tr>
<tr>
<td class="address-1"><span id="63948"></span>63948</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="63949"></span>63949</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the reference for the first tile in this column</td>
</tr>
<tr>
<td class="address-1"><span id="63950"></span>63950</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="63951"></span>63951</td>
<td class="instruction">JR 63920</td>
<td class="comment-1" rowspan="1">Jump back to draw this column of tiles</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63837.html">63837</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63838">Map</a></td>
<td class="next">
Next: <a href="63953.html">63953</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/F95E.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>