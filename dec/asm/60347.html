<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 60347</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="60334.html">60334</a></span></td>
<td class="up">Up: <a href="../maps/all.html#60347">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="60504.html">60504</a></span></td>
</tr>
</table>
<div class="description">60347: Make a character move left</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="60641.html">60641</a>, <a href="62926.html">62926</a>, <a href="62976.html">62976</a> and <a href="63209.html">63209</a>. Turns the character round if he's facing right; otherwise moves him left, or up and to the left, or down and to the left (in that order of preference, and if possible). Returns with the carry flag set unless the character could not move.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60347"></span>60347</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="60293.html">60293</a></td>
<td class="comment-11" rowspan="1">Make the character stand up if he's lying down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60350"></span>60350</td>
<td class="bytes-0"></td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if the character was lying down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60351"></span>60351</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the character is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60353"></span>60353</td>
<td class="bytes-0"></td>
<td class="instruction">LD DE,40985</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the direction indicator table at <a href="40985.html">40985</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60356"></span>60356</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60368</td>
<td class="comment-11" rowspan="1">Jump if the character is facing left</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60358"></span>
<div class="comments">
<div class="paragraph">
The character is facing right, so we make him turn round first. This entry point is also used by the routine at <a href="60334.html">60334</a> to make a character who is facing left turn round.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60358"></span>60358</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the character's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60361"></span>60361</td>
<td class="bytes-0"></td>
<td class="instruction">XOR 128</td>
<td class="comment-11" rowspan="1">Flip bit 7 of the character's animatory state, thus turning him round</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60363"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="60293.html">60293</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60363"></span>60363</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="59861.html">59861</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60366"></span>60366</td>
<td class="bytes-0"></td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag to indicate that the character was moved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60367"></span>60367</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60368"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="60315.html">60315</a> (with <span class="register">DE</span>=<a href="41496.html">41496</a>, <a href="41752.html">41752</a>, <a href="42008.html">42008</a> or <a href="42264.html">42264</a>) to move a character up or down, and by the routine at <a href="60334.html">60334</a> (with <span class="register">DE</span>=<a href="41241.html">41241</a>) to make a character move right.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60368"></span>60368</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character buffer pointer briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60369"></span>60369</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the pointer to the direction indicator table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60370"></span>60370</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60373"></span>60373</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the direction indicator table (<a href="40985.html">40985</a>, <a href="41241.html">41241</a>, <a href="41496.html">41496</a>, <a href="41752.html">41752</a>, <a href="42008.html">42008</a> or <a href="42264.html">42264</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60374"></span>60374</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=location type indicator (1-5; see <a href="60179.html">60179</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60375"></span>60375</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=direction descriptor (see <a href="60179.html">60179</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60376"></span>60376</td>
<td class="bytes-0"></td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">Does this direction indicator correspond to a direction that is available at the character's current location?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60377"></span>60377</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,60386</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60379"></span>60379</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next byte in the direction indicator table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60380"></span>60380</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 2,L</td>
<td class="comment-11" rowspan="1">Have we reached the end of the direction indicator table?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60382"></span>60382</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60375</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60384"></span>60384</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character buffer pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60385"></span>60385</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return with the carry flag reset (the character did not move)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60386"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">A</span>=128, 64, 32, 16, 8 or 4; the bit set in <span class="register">A</span> indicates the direction in which the character has chosen to move next:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Bit</th>
<th colspan="1" rowspan="1">Direction</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">7</td>
<td class="" colspan="1" rowspan="1">Left</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">6</td>
<td class="" colspan="1" rowspan="1">Right</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">5</td>
<td class="" colspan="1" rowspan="1">Up and to the left</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4</td>
<td class="" colspan="1" rowspan="1">Up and to the right</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">Down and to the left</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">Down and to the right</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60386"></span>60386</td>
<td class="bytes-0"></td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=direction indicator (128, 64, 32, 16, 8 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60387"></span>60387</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character buffer pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60388"></span>60388</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the character is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60390"></span>60390</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,84</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=84: bits 6 (right), 4 (up/right) and 2 (down/right) set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60392"></span>60392</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,60395</td>
<td class="comment-11" rowspan="1">Jump if the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60394"></span>60394</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=168: bits 7 (left), 5 (up/left) and 3 (down/left) set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60395"></span>60395</td>
<td class="bytes-0"></td>
<td class="instruction">AND D</td>
<td class="comment-11" rowspan="1">Is the character facing the direction in which he wants to move?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60396"></span>60396</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60358</td>
<td class="comment-11" rowspan="1">Make him turn round if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60398"></span>
<div class="comments">
<div class="paragraph">
The character is facing the direction in which he wants to move. Now we examine the character's current location to determine whether the desired move requires any special handling.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60398"></span>60398</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,4</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 4 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60400"></span>60400</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=location type indicator for the character's current location (1-5; see <a href="60179.html">60179</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60401"></span>60401</td>
<td class="bytes-0"></td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Is the character on the sidewalk or the road?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60402"></span>60402</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,60420</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60404"></span>
<div class="comments">
<div class="paragraph">
The character is on the sidewalk or the road. In this case we need to check whether the character is going up a step, and change his z-coordinate accordingly.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60404"></span>60404</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=direction indicator (128, 64, 32, 16, 8 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60405"></span>60405</td>
<td class="bytes-0"></td>
<td class="instruction">AND 48</td>
<td class="comment-11" rowspan="1">Check bits 4 and 5: is the character going to move up a step?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60407"></span>60407</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60423</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60409"></span>60409</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="4">Slide bits 5 and 4 of <span class="register">A</span> into bits 1 and 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60410"></span>60410</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60411"></span>60411</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60412"></span>60412</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60413"></span>60413</td>
<td class="bytes-0"></td>
<td class="instruction">AND C</td>
<td class="comment-11" rowspan="1">Will going up the step change the character's z-coordinate to 2?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60414"></span>60414</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60423</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60416"></span>60416</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),2</td>
<td class="comment-11" rowspan="1">Set the character's z-coordinate to 2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60418"></span>60418</td>
<td class="bytes-0"></td>
<td class="instruction">JR 60423</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60420"></span>
<div class="comments">
<div class="paragraph">
The character is not on the sidewalk or the road.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60420"></span>60420</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">Is the location type indicator 3 (at the open entrance to a building) or 5 (a location that requires special handling)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60421"></span>60421</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,60473</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60423"></span>
<div class="comments">
<div class="paragraph">
Finally we can move the character midstride in the desired direction and update the SRB accordingly. This entry point is used by the routines at <a href="31580.html">31580</a> and <a href="64512.html">64512</a>. The address of this entry point is also found at <a href="40982.html">40982</a>; it is used to handle a character who is moving from one of a set of certain special locations, but it does not actually do anything special.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60423"></span>60423</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60425"></span>60425</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,5</td>
<td class="comment-11" rowspan="2">Point <span class="register">BC</span> at byte 5 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60427"></span>60427</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60428"></span>60428</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60429"></span>60429</td>
<td class="bytes-0"></td>
<td class="instruction">XOR 2</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's post-midstride animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60431"></span>60431</td>
<td class="bytes-0"></td>
<td class="instruction">LD (BC),A</td>
<td class="comment-11" rowspan="1">Save this in byte 5 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60432"></span>60432</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60433"></span>60433</td>
<td class="bytes-0"></td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Point <span class="register">BC</span> at byte 6 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60434"></span>60434</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="4"><span class="register">A</span>=-1 if the character is facing left, 1 if he's facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60435"></span>60435</td>
<td class="bytes-0"></td>
<td class="instruction">SBC A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60436"></span>60436</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60437"></span>60437</td>
<td class="bytes-0"></td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60438"></span>60438</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-11" rowspan="1">Add the character's current x-coordinate to obtain his post-midstride x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60439"></span>60439</td>
<td class="bytes-0"></td>
<td class="instruction">LD (BC),A</td>
<td class="comment-11" rowspan="1">Save this in byte 6 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60440"></span>60440</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60441"></span>60441</td>
<td class="bytes-0"></td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Point <span class="register">BC</span> at byte 7 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60442"></span>60442</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=direction indicator (128, 64, 32, 16, 8 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60443"></span>60443</td>
<td class="bytes-0"></td>
<td class="instruction">AND 60</td>
<td class="comment-11" rowspan="1">Is the character going up or down a step?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60445"></span>60445</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60454</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60447"></span>60447</td>
<td class="bytes-0"></td>
<td class="instruction">AND 48</td>
<td class="comment-11" rowspan="1">Is the character going up a step?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60449"></span>60449</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60453</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60451"></span>60451</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,254</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=-2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60453"></span>60453</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=-1 if the character is going up a step, or 1 if he's going down a step</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60454"></span>60454</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-11" rowspan="1">Add the character's y-coordinate; now the carry flag is set if the character will be going up a step</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60455"></span>60455</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60457"></span>60457</td>
<td class="bytes-0"></td>
<td class="instruction">LD (BC),A</td>
<td class="comment-11" rowspan="1">Save the character's post-midstride y-coordinate in byte 7 of his buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60458"></span>60458</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60459"></span>60459</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save the carry flag briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60460"></span>60460</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the character's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60463"></span>60463</td>
<td class="bytes-0"></td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60464"></span>60464</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,60467</td>
<td class="comment-11" rowspan="1">Jump unless the character is going up a step</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60466"></span>60466</td>
<td class="bytes-0"></td>
<td class="instruction">DEC D</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=character's new y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60467"></span>60467</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's new animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60468"></span>60468</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="59861.html">59861</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60471"></span>60471</td>
<td class="bytes-0"></td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag to indicate that the character was moved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60472"></span>60472</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60473"></span>
<div class="comments">
<div class="paragraph">
The location type indicator is 3 (at the open entrance to a building) or 5 (a location that requires special handling).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60473"></span>60473</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">Is the location type indicator 5 (a location that requires special handling)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60474"></span>60474</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,60485</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60476"></span>
<div class="comments">
<div class="paragraph">
The character is standing at the open entrance to a building.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60476"></span>60476</td>
<td class="bytes-0"></td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the character is indoors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60477"></span>60477</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),1</td>
<td class="comment-11" rowspan="1">Set the character's z-coordinate to 1 (indoors)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60479"></span>60479</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=direction indicator (128, 64, 32, 16, 8 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60480"></span>60480</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="30396.html">30396</a></td>
<td class="comment-11" rowspan="1">Adjust the character's z-coordinate according to whether he is going to enter or exit the building, and, if dealing with Sam, check whether he is entering a house without a key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60483"></span>60483</td>
<td class="bytes-0"></td>
<td class="instruction">JR 60423</td>
<td class="comment-11" rowspan="1">Move the character midstride</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60485"></span>
<div class="comments">
<div class="paragraph">
The character is at a location that may require special handling depending on the direction in which he is going.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="60485"></span>60485</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=direction indicator (128, 64, 32, 16, 8 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60486"></span>60486</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="2">Move bits 7 (left) and 6 (right) into bits 1 and 0 for comparison with bits 1 and 0 of the direction descriptor in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60487"></span>60487</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60488"></span>60488</td>
<td class="bytes-0"></td>
<td class="instruction">AND C</td>
<td class="comment-11" rowspan="1">Is the character moving in a direction that requires special handling (e.g. off the edge of a roof)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60489"></span>60489</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,60423</td>
<td class="comment-11" rowspan="1">Jump if not to move the character midstride</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60491"></span>
<div class="comments">
<div class="paragraph">
The character's next move requires special handling.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60491"></span>60491</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q'', the third byte of the location descriptor (1-7; see <a href="60179.html">60179</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60492"></span>60492</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,159</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=160-166</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60494"></span>60494</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60495"></span>60495</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="6">Collect in <span class="register">HL</span> the special location handler routine address (<a href="31580.html">31580</a>, <a href="60347.html#60423">60423</a> or <a href="64338.html">64338</a>) from <a href="40982.html">40982</a>, <a href="41238.html">41238</a>, <a href="41494.html">41494</a>, <a href="41750.html">41750</a>, <a href="42006.html">42006</a>, <a href="42262.html">42262</a> or <a href="42518.html">42518</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60496"></span>60496</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,22</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60498"></span>60498</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60499"></span>60499</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60500"></span>60500</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60501"></span>60501</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60502"></span>60502</td>
<td class="bytes-0"></td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span>, and copy the special location handler routine address onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="60503"></span>60503</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">To <a href="31580.html">31580</a> (if Q''=7), <a href="60347.html#60423">60423</a> (Q''=1) or <a href="64338.html">64338</a> (Q''=2, 3, 4, 5 or 6)</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="60334.html">60334</a></span></td>
<td class="up">Up: <a href="../maps/all.html#60347">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="60504.html">60504</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20190619</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../../asm/EBBB.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>