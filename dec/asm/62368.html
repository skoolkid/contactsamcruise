<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 62368</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62363.html">62363</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62368">Map</a></td>
<td class="next">
Next: <a href="62465.html">62465</a>
</td>
</tr>
</table>
<div class="description">62368: Update the SRB for a window</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="62468.html">62468</a> and <a href="62597.html">62597</a>. Updates the <a href="32512.html">screen refresh buffer</a> (SRB) for a window (or window-pair) after a light switch has been flipped or a blind has been raised or lowered.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">185-189 (corresponding to the 5th, 4th, 3rd, 2nd or 1st floor)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">0-31 or 64-95 (corresponding to the x-coordinate of the window)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="62368"></span>62368</td>
<td class="instruction">RES 6,L</td>
<td class="comment-1" rowspan="1">Now <span class="register">L</span>=X'/8 (where X' is the x-coordinate of the left edge of the window), and <span class="register">HL</span> points at the Z value corresponding to the window</td>
</tr>
<tr>
<td class="address-1"><span id="62370"></span>62370</td>
<td class="instruction">LD BC,(32766)</td>
<td class="comment-1" rowspan="1">The play area coordinates of the top-left corner of the screen are stored at <a href="32766.html">32766</a> and <a href="32767.html">32767</a></td>
</tr>
<tr>
<td class="address-1"><span id="62374"></span>62374</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X (the x-coordinate of the leftmost column of the play area on screen)</td>
</tr>
<tr>
<td class="address-1"><span id="62375"></span>62375</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=X/8</td>
</tr>
<tr>
<td class="address-1"><span id="62376"></span>62376</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62377"></span>62377</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62378"></span>62378</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=X/8 (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="62379"></span>62379</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X'/8 (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="62380"></span>62380</td>
<td class="instruction">SUB E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X'/8-X/8</td>
</tr>
<tr>
<td class="address-1"><span id="62381"></span>62381</td>
<td class="instruction">CP 4</td>
<td class="comment-1" rowspan="1">Is the window off screen to the right or left?</td>
</tr>
<tr>
<td class="address-1"><span id="62383"></span>62383</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="62384"></span>62384</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=0-3 (index of the 8-tile wide column containing the window)</td>
</tr>
<tr>
<td class="address-1"><span id="62385"></span>62385</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=1 (5th floor), 2, 3, 4 or 5 (1st floor)</td>
</tr>
<tr>
<td class="address-1"><span id="62386"></span>62386</td>
<td class="instruction">SUB 184</td>
</tr>
<tr>
<td class="address-1"><span id="62388"></span>62388</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="5"><span class="register">D</span>=6 (5th floor), 12, 18, 24 or 30 (1st floor)</td>
</tr>
<tr>
<td class="address-1"><span id="62389"></span>62389</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62390"></span>62390</td>
<td class="instruction">ADD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="62391"></span>62391</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62392"></span>62392</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="62393"></span>62393</td>
<td class="instruction">SUB B</td>
<td class="comment-1" rowspan="1">Subtract Y, the y-coordinate of the topmost row of the play area on screen (2, 8, 14 or 20)</td>
</tr>
<tr>
<td class="address-1"><span id="62394"></span>62394</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="2">Is the window off screen?</td>
</tr>
<tr>
<td class="address-1"><span id="62396"></span>62396</td>
<td class="instruction">CP 21</td>
</tr>
<tr>
<td class="address-1"><span id="62398"></span>62398</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="62399"></span>62399</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=4*(<span class="register">D</span>-Y+4)+<span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="62400"></span>62400</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="62401"></span>62401</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="62402"></span>62402</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">DE</span> at the SRB byte corresponding to the top row of the window</td>
</tr>
<tr>
<td class="address-1"><span id="62403"></span>62403</td>
<td class="instruction">LD D,127</td>
</tr>
<tr>
<td class="address-1"><span id="62405"></span>62405</td>
<td class="instruction">LD C,128</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=128 (10000000)</td>
</tr>
<tr>
<td class="address-1"><span id="62407"></span>62407</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the Z value for the window</td>
</tr>
<tr>
<td class="address-1"><span id="62408"></span>62408</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the Z'' value for the leftmost column of tiles in the 8-tile wide segment that contains the window</td>
</tr>
<tr>
<td class="address-1"><span id="62409"></span>62409</td>
<td class="instruction">SET 7,L</td>
</tr>
<tr>
<td class="address-1"><span id="62411"></span>62411</td>
<td class="instruction">LD H,184</td>
</tr>
<tr>
<td class="address-1"><span id="62413"></span>62413</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="62414"></span>62414</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL'</span> at the <a href="48896.html">Z' value</a> for the 8x6 block of tiles that contains the window</td>
</tr>
<tr>
<td class="address-1"><span id="62415"></span>62415</td>
<td class="instruction">LD H,191</td>
</tr>
<tr>
<td class="address-1"><span id="62417"></span>62417</td>
<td class="instruction">LD C,1</td>
<td class="comment-1" rowspan="1"><span class="register">C'</span>=1 (00000001)</td>
</tr>
<tr>
<td class="address-1"><span id="62419"></span>62419</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62420"></span>
<div class="comments">
<div class="paragraph">
The following loop examines the 8x6 block of tiles that contains the window and updates the relevant SRB bytes for the affected window tiles.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62420"></span>62420</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="62421"></span>62421</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Rotate the set bit in <span class="register">C'</span> one place to the right</td>
</tr>
<tr>
<td class="address-1"><span id="62423"></span>62423</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z' value</td>
</tr>
<tr>
<td class="address-1"><span id="62424"></span>62424</td>
<td class="instruction">AND C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we should use the T values in pages 160, 162, 164, 166, 168 and 170</td>
</tr>
<tr>
<td class="address-1"><span id="62425"></span>62425</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="62426"></span>62426</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the pointer to the Z'' value</td>
</tr>
<tr>
<td class="address-1"><span id="62427"></span>62427</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Z'' value</td>
</tr>
<tr>
<td class="address-1"><span id="62428"></span>62428</td>
<td class="instruction">LD H,160</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the T value in page 160</td>
</tr>
<tr>
<td class="address-1"><span id="62430"></span>62430</td>
<td class="instruction">JR Z,62434</td>
<td class="comment-1" rowspan="1">Jump unless we should use the T values in pages 172, 174, 176, 178, 180 and 182</td>
</tr>
<tr>
<td class="address-1"><span id="62432"></span>62432</td>
<td class="instruction">LD H,172</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the T value in page 172</td>
</tr>
<tr>
<td class="address-2"><span id="62434"></span>62434</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="1">There are 6 rows of tiles to consider</td>
</tr>
<tr>
<td class="address-2"><span id="62436"></span>62436</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T</td>
</tr>
<tr>
<td class="address-1"><span id="62437"></span>62437</td>
<td class="instruction">AND 192</td>
<td class="comment-1" rowspan="1">Keep only bits 6 and 7</td>
</tr>
<tr>
<td class="address-1"><span id="62439"></span>62439</td>
<td class="instruction">CP 128</td>
<td class="comment-1" rowspan="1">Is there a window tile here?</td>
</tr>
<tr>
<td class="address-1"><span id="62441"></span>62441</td>
<td class="instruction">JR NZ,62446</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="62443"></span>62443</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="3">Set the appropriate bit in the SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="62444"></span>62444</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="address-1"><span id="62445"></span>62445</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-2"><span id="62446"></span>62446</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the next T value (in page 162, 164, 166, 168, 170, 174, 176, 178, 180 or 182)</td>
</tr>
<tr>
<td class="address-1"><span id="62447"></span>62447</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="62448"></span>62448</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the SRB byte for the next row down</td>
</tr>
<tr>
<td class="address-1"><span id="62449"></span>62449</td>
<td class="instruction">ADD A,4</td>
</tr>
<tr>
<td class="address-1"><span id="62451"></span>62451</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="62452"></span>62452</td>
<td class="instruction">DJNZ 62436</td>
<td class="comment-1" rowspan="1">Jump back to consider the tile in the next row down</td>
</tr>
<tr>
<td class="address-1"><span id="62454"></span>62454</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> back at the SRB byte corresponding to the top row of the window</td>
</tr>
<tr>
<td class="address-1"><span id="62455"></span>62455</td>
<td class="instruction">SUB 24</td>
</tr>
<tr>
<td class="address-1"><span id="62457"></span>62457</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="62458"></span>62458</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the Z'' value pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="62459"></span>62459</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the Z'' value for the next column of tiles to the right (in page 185-191)</td>
</tr>
<tr>
<td class="address-1"><span id="62460"></span>62460</td>
<td class="instruction">RRC C</td>
<td class="comment-1" rowspan="1">Rotate the set bit in <span class="register">C</span> one place to the right</td>
</tr>
<tr>
<td class="address-1"><span id="62462"></span>62462</td>
<td class="instruction">JR NC,62420</td>
<td class="comment-1" rowspan="1">Jump back until 8 tile columns have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="62464"></span>62464</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62363.html">62363</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62368">Map</a></td>
<td class="next">
Next: <a href="62465.html">62465</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/F3A0.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>