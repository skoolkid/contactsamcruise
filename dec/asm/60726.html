<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 60726</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="60720.html">60720</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60726">Map</a></td>
<td class="next">
Next: <a href="60810.html">60810</a>
</td>
</tr>
</table>
<div class="description">60726: Obtain an identifier for a character's current location</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="31808.html">31808</a>. Returns with <span class="register">A</span>=255 if the character's z-coordinate is 2 or 4, and his y-coordinate is less than 31 (meaning he is on the fire escape of the apartment building next to no. 19, or falling from the roof of a building); with <span class="register">A</span>=0 if he's on the sidewalk or the road; or with certain bits of <span class="register">A</span> set or reset depending on the location:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Bit(s)</th>
<th colspan="1" rowspan="1">Meaning</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="2">0</td>
<td class="" colspan="1" rowspan="1">0: On the floor of a shop or other building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">1: On a staircase between floors, or on the front steps of a building below the first floor, or on the rim of a roof</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="7">1-3</td>
<td class="" colspan="1" rowspan="1">000: On the front steps of a building below the first floor</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">001: Next to the entrance to a shop or other building (outside)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">010: Shop or first floor of other building (inside)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">011: Second floor of a building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">100: Third floor of a building</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">101: Fourth floor of a building (could be the roof)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">110: Fifth floor of a building (could be the roof)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4-7</td>
<td class="" colspan="1" rowspan="1">Region ID (see below)</td>
</tr>
</table>
</div>
<div class="paragraph">
The region ID in bits 4-7 corresponds to a certain shop or other building in the play area:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Region ID</th>
<th colspan="1" rowspan="1">Building</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0001</td>
<td class="" colspan="1" rowspan="1">Left-hand shop under the apartments next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0010</td>
<td class="" colspan="1" rowspan="1">Right-hand shop under the apartments next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0011</td>
<td class="" colspan="1" rowspan="1">Shop under no. 17</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0100</td>
<td class="" colspan="1" rowspan="1">Shop under no. 15</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0101</td>
<td class="" colspan="1" rowspan="1">Apartment building next to no. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0110</td>
<td class="" colspan="1" rowspan="1">Police station</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0111</td>
<td class="" colspan="1" rowspan="1">No. 27</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1000</td>
<td class="" colspan="1" rowspan="1">No. 74</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1001</td>
<td class="" colspan="1" rowspan="1">Hotel</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1010</td>
<td class="" colspan="1" rowspan="1">No. 31</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1011</td>
<td class="" colspan="1" rowspan="1">No. 19</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1100</td>
<td class="" colspan="1" rowspan="1">No. 17</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1101</td>
<td class="" colspan="1" rowspan="1">Unused</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1110</td>
<td class="" colspan="1" rowspan="1">No. 15</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1111</td>
<td class="" colspan="1" rowspan="1">Apartment building next to no. 19</td>
</tr>
</table>
</div>
<div class="paragraph">
In addition, on return <span class="register">E</span> holds the x-coordinate of the bottom of the staircase going up to the floor above, and <span class="register">D</span> holds the x-coordinate of the top of the staircase going down to the floor below.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="60726"></span>60726</td>
<td class="instruction">LD L,1</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="60728"></span>60728</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="60729"></span>60729</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=character's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="60730"></span>60730</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="60731"></span>60731</td>
<td class="instruction">LD L,4</td>
<td class="comment-1" rowspan="2"><span class="register">C</span>=character's z-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="60733"></span>60733</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60734"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="29072.html">29072</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="60734"></span>60734</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Is the z-coordinate 1 (indoors)?</td>
</tr>
<tr>
<td class="address-1"><span id="60736"></span>60736</td>
<td class="instruction">JR NZ,60743</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="60738"></span>60738</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="60739"></span>60739</td>
<td class="instruction">CP 31</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=255 if the y-coordinate is less than 31, 0 otherwise</td>
</tr>
<tr>
<td class="address-1"><span id="60741"></span>60741</td>
<td class="instruction">SBC A,A</td>
</tr>
<tr>
<td class="address-1"><span id="60742"></span>60742</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return with <span class="register">A</span>=255 if the y-coordinate is less than 31, and the z-coordinate is 2 or 4</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60743"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="31126.html">31126</a> and <a href="31289.html">31289</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="60743"></span>60743</td>
<td class="instruction">CALL <a href="60152.html#60159">60159</a></td>
<td class="comment-1" rowspan="1">Check whether the character is on the sidewalk or road</td>
</tr>
<tr>
<td class="address-1"><span id="60746"></span>60746</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="2">Return with <span class="register">A</span>=0 if the character is on the sidewalk or road</td>
</tr>
<tr>
<td class="address-1"><span id="60748"></span>60748</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60749"></span>
<div class="comments">
<div class="paragraph">
At this point we have determined that the character is on the front steps of or inside a building.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60749"></span>60749</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="address-1"><span id="60750"></span>60750</td>
<td class="instruction">LD A,37</td>
<td class="comment-1" rowspan="6"><span class="register">L</span>=10 (if 31&lt;<span class="register">D</span>), 11 (25&lt;<span class="register">D</span>&lt;=31), 12 (19&lt;<span class="register">D</span>&lt;=25), 13 (13&lt;<span class="register">D</span>&lt;=19), 14 (7&lt;<span class="register">D</span>&lt;=13) or 15 (1&lt;<span class="register">D</span>&lt;=7)</td>
</tr>
<tr>
<td class="address-1"><span id="60752"></span>60752</td>
<td class="instruction">LD L,9</td>
</tr>
<tr>
<td class="address-2"><span id="60754"></span>60754</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="60755"></span>60755</td>
<td class="instruction">SUB 6</td>
</tr>
<tr>
<td class="address-1"><span id="60757"></span>60757</td>
<td class="instruction">CP D</td>
</tr>
<tr>
<td class="address-1"><span id="60758"></span>60758</td>
<td class="instruction">JR NC,60754</td>
</tr>
<tr>
<td class="address-1"><span id="60760"></span>60760</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="2">Set the zero flag if <span class="register">D</span>=7, 13, 19, 25 or 31 (corresponding to the floor of a building)</td>
</tr>
<tr>
<td class="address-1"><span id="60761"></span>60761</td>
<td class="instruction">ADD A,6</td>
</tr>
<tr>
<td class="address-1"><span id="60763"></span>60763</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="60764"></span>60764</td>
<td class="instruction">LD H,239</td>
<td class="comment-1" rowspan="1">The region identifier tables are in page 239</td>
</tr>
<tr>
<td class="address-1"><span id="60766"></span>60766</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="60767"></span>60767</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at one of the tables at <a href="61194.html#61200">61200</a>, <a href="61194.html#61256">61256</a>, <a href="61194.html#61296">61296</a>, <a href="61194.html#61336">61336</a>, <a href="61194.html#61376">61376</a> and <a href="61194.html#61416">61416</a></td>
</tr>
<tr>
<td class="address-2"><span id="60768"></span>60768</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="6">Find the first entry whose first byte is greater than <span class="register">A</span> (the target x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="60769"></span>60769</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="60770"></span>60770</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="60771"></span>60771</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="60772"></span>60772</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="60773"></span>60773</td>
<td class="instruction">JR NC,60768</td>
</tr>
<tr>
<td class="address-1"><span id="60775"></span>60775</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=fourth byte of the entry (x-coordinate of the bottom of the staircase going up to the floor above)</td>
</tr>
<tr>
<td class="address-1"><span id="60776"></span>60776</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="60777"></span>60777</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=third byte of the entry (x-coordinate of the top of the staircase going down to the floor below)</td>
</tr>
<tr>
<td class="address-1"><span id="60778"></span>60778</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="60779"></span>60779</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=second byte of the entry (location identifier)</td>
</tr>
<tr>
<td class="address-1"><span id="60780"></span>60780</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="60781"></span>60781</td>
<td class="instruction">CP 80</td>
<td class="comment-1" rowspan="1">Is the second byte of the entry less than 80?</td>
</tr>
<tr>
<td class="address-1"><span id="60783"></span>60783</td>
<td class="instruction">JR NC,60794</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60785"></span>
<div class="comments">
<div class="paragraph">
The second byte of the entry is less than 80, which is true only for the four entries in the region identifier table at <a href="61194.html#61200">61200</a> that correspond to the shops.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="60785"></span>60785</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag (though the values are ignored at this point)</td>
</tr>
<tr>
<td class="address-2"><span id="60786"></span>60786</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="60787"></span>60787</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Set the zero flag if the z-coordinate is 1 (indoors)</td>
</tr>
<tr>
<td class="address-1"><span id="60789"></span>60789</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="60790"></span>60790</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if the z-coordinate is 1</td>
</tr>
<tr>
<td class="address-1"><span id="60791"></span>60791</td>
<td class="instruction">SUB 2</td>
<td class="comment-1" rowspan="1">Reset bit 2 of <span class="register">A</span>, and set bit 1 (to indicate that the character is standing outside the door of a shop or house)</td>
</tr>
<tr>
<td class="address-1"><span id="60793"></span>60793</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="60794"></span>
<div class="comments">
<div class="paragraph">
The second byte of the entry (held in <span class="register">A</span>) is at least 80, which means it corresponds to a location other than one of the four shops.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="60794"></span>60794</td>
<td class="instruction">AND 15</td>
<td class="comment-1" rowspan="1">Keep only bits 0-3 of the location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="60796"></span>60796</td>
<td class="instruction">CP 4</td>
<td class="comment-1" rowspan="1">Is this location on the first floor of a building?</td>
</tr>
<tr>
<td class="address-1"><span id="60798"></span>60798</td>
<td class="instruction">JR NZ,60804</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="60800"></span>60800</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="60801"></span>60801</td>
<td class="instruction">JR Z,60786</td>
<td class="comment-1" rowspan="1">Jump if the y-coordinate corresponds to a floor of a building</td>
</tr>
<tr>
<td class="address-1"><span id="60803"></span>60803</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> and the zero flag again</td>
</tr>
<tr>
<td class="address-2"><span id="60804"></span>60804</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">A</span> and the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="60805"></span>60805</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=location identifier</td>
</tr>
<tr>
<td class="address-1"><span id="60806"></span>60806</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="60807"></span>60807</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if the y-coordinate corresponds to a floor of a building</td>
</tr>
<tr>
<td class="address-1"><span id="60808"></span>60808</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set bit 0 of <span class="register">A</span> to indicate that the character is on a staircase between two floors of a building, or on the front steps of a building below the first floor, or on the rim of a roof</td>
</tr>
<tr>
<td class="address-1"><span id="60809"></span>60809</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="60720.html">60720</a>
</td>
<td class="up">Up: <a href="../maps/all.html#60726">Map</a></td>
<td class="next">
Next: <a href="60810.html">60810</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/ED36.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>