<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 62120</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62119.html">62119</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62120">Map</a></td>
<td class="next">
Next: <a href="62173.html">62173</a>
</td>
</tr>
</table>
<div class="description">62120: Check whether a character can open a door</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="62216.html">62216</a> and <a href="62278.html">62278</a>. Returns with the carry flag reset if the door is already open, or the character can open the door (either because the door requires no key, or because the character has the key); otherwise returns with the carry flag set, and the zero flag set if the character has no keys. If the door is closed and requires a key, this routine will either open it (if the character has the key), or signal that the door was knocked on.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="62120"></span>62120</td>
<td class="instruction">LD D,H</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=character number</td>
</tr>
<tr>
<td class="address-1"><span id="62121"></span>62121</td>
<td class="instruction">CALL <a href="62099.html">62099</a></td>
<td class="comment-1" rowspan="1">Check whether the door is open</td>
</tr>
<tr>
<td class="address-1"><span id="62124"></span>62124</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=character number</td>
</tr>
<tr>
<td class="address-1"><span id="62125"></span>62125</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return (with the carry flag reset) if the door is open</td>
</tr>
<tr>
<td class="address-1"><span id="62126"></span>62126</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the door status flags</td>
</tr>
<tr>
<td class="address-1"><span id="62127"></span>62127</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=door status flags</td>
</tr>
<tr>
<td class="address-1"><span id="62128"></span>62128</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Does the door require a key to unlock it?</td>
</tr>
<tr>
<td class="address-1"><span id="62129"></span>62129</td>
<td class="instruction">JR NZ,62142</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62131"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="62216.html">62216</a> and <a href="62339.html">62339</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62131"></span>62131</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Initialise the door close delay timer (in bits 0-2 of the door status flags) to 7</td>
</tr>
<tr>
<td class="address-1"><span id="62132"></span>62132</td>
<td class="instruction">ADD A,7</td>
</tr>
<tr>
<td class="address-1"><span id="62134"></span>62134</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="62135"></span>62135</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the character number (in <span class="register">D</span>) briefly</td>
</tr>
<tr>
<td class="address-1"><span id="62136"></span>62136</td>
<td class="instruction">CALL <a href="63437.html">63437</a></td>
<td class="comment-1" rowspan="1">Open the door</td>
</tr>
<tr>
<td class="address-1"><span id="62139"></span>62139</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="62140"></span>62140</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Reset the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="62141"></span>62141</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62142"></span>
<div class="comments">
<div class="paragraph">
The door requires a key to unlock it.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="62142"></span>62142</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character number (215-230)</td>
</tr>
<tr>
<td class="address-1"><span id="62143"></span>62143</td>
<td class="instruction">CP 230</td>
<td class="comment-1" rowspan="1">Is this Sam?</td>
</tr>
<tr>
<td class="address-1"><span id="62145"></span>62145</td>
<td class="instruction">JR NZ,62152</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="62147"></span>62147</td>
<td class="instruction">LD A,(32746)</td>
<td class="comment-1" rowspan="1">Pick up the key inventory flags from <a href="32746.html">32746</a></td>
</tr>
<tr>
<td class="address-1"><span id="62150"></span>62150</td>
<td class="instruction">JR 62158</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="62152"></span>62152</td>
<td class="instruction">ADD A,10</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character number + 10 (225-239)</td>
</tr>
<tr>
<td class="address-1"><span id="62154"></span>62154</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">BC</span> at the entry in the table of key ownership flags at <a href="62177.html">62177</a> that corresponds to this character</td>
</tr>
<tr>
<td class="address-1"><span id="62155"></span>62155</td>
<td class="instruction">LD B,242</td>
</tr>
<tr>
<td class="address-1"><span id="62157"></span>62157</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1">Pick up the key ownership flags</td>
</tr>
<tr>
<td class="address-2"><span id="62158"></span>62158</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=character's key ownership flags</td>
</tr>
<tr>
<td class="address-1"><span id="62159"></span>62159</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">Does the character have the key to this door?</td>
</tr>
<tr>
<td class="address-1"><span id="62160"></span>62160</td>
<td class="instruction">JR NZ,62131</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="62162"></span>62162</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=LSB of the door status flag byte (240-249)</td>
</tr>
<tr>
<td class="address-1"><span id="62163"></span>62163</td>
<td class="instruction">SUB 70</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=170-179</td>
</tr>
<tr>
<td class="address-1"><span id="62165"></span>62165</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the door knock status flags for the door (at <a href="32682.html">32682</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="62166"></span>62166</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Signal: somebody has knocked on the door</td>
</tr>
<tr>
<td class="address-1"><span id="62168"></span>62168</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character's key ownership flags</td>
</tr>
<tr>
<td class="address-1"><span id="62169"></span>62169</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Set the zero flag if the character has no keys</td>
</tr>
<tr>
<td class="address-1"><span id="62170"></span>62170</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Signal: the character cannot open the door</td>
</tr>
<tr>
<td class="address-1"><span id="62171"></span>62171</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="62172"></span>62172</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62119.html">62119</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62120">Map</a></td>
<td class="next">
Next: <a href="62173.html">62173</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/F2A8.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>