<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 64005</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="64004.html">64004</a>
</td>
<td class="up">Up: <a href="../maps/all.html#64005">Map</a></td>
<td class="next">
Next: <a href="64121.html">64121</a>
</td>
</tr>
</table>
<div class="description">64005: Deal with a character who has been knocked over</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this uninterruptible subcommand routine is placed into bytes 18 and 19 of a character's buffer (by the routine at <a href="64162.html">64162</a>) when he's been hit on the head by a falling character with an x-coordinate that differs from his by 1. It controls the character from the moment he is knocked over until he has finished staggering from being dazed by the collision.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-229)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="64005"></span>64005</td>
<td class="instruction">LD A,138</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=10 (short knockout delay) + 128 (quick recovery)</td>
</tr>
<tr>
<td class="address-1"><span id="64007"></span>64007</td>
<td class="instruction">JR 64011</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64009"></span>
<div class="comments">
<div class="paragraph">
The address of this entry point is placed into bytes 18 and 19 of a character's buffer (by the routine at <a href="64162.html">64162</a>) when he's been hit on the head by a falling character with the same x-coordinate.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="64009"></span>64009</td>
<td class="instruction">LD A,20</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=20 (long knockout delay) + 0 (slow recovery)</td>
</tr>
<tr>
<td class="address-2"><span id="64011"></span>64011</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="2">Initialise the character's knockout delay counter in byte 20 of his buffer</td>
</tr>
<tr>
<td class="address-1"><span id="64013"></span>64013</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="64014"></span>64014</td>
<td class="instruction">LD L,0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="64016"></span>64016</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=character's animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="64017"></span>64017</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="address-1"><span id="64018"></span>64018</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="64019"></span>64019</td>
<td class="instruction">LD L,13</td>
<td class="comment-1" rowspan="2">Store the character's pre-knockout animatory state in byte 13 of his buffer</td>
</tr>
<tr>
<td class="address-1"><span id="64021"></span>64021</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="address-1"><span id="64022"></span>64022</td>
<td class="instruction">LD L,21</td>
<td class="comment-1" rowspan="2">Store the character's current x-coordinate in byte 21 of his buffer</td>
</tr>
<tr>
<td class="address-1"><span id="64024"></span>64024</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="address-1"><span id="64025"></span>64025</td>
<td class="instruction">CALL <a href="63954.html">63954</a></td>
<td class="comment-1" rowspan="1">Knock the character over</td>
</tr>
<tr>
<td class="address-1"><span id="64028"></span>64028</td>
<td class="instruction">CALL <a href="63994.html#63997">63997</a></td>
<td class="comment-1" rowspan="1">Place the address of the following instruction into bytes 18 and 19 of the character's buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64031"></span>
<div class="comments">
<div class="paragraph">
This entry point is used after the character has been knocked over and until he stands up again.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="64031"></span>64031</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="1">Byte 20 of the character's buffer holds the knockout delay counter</td>
</tr>
<tr>
<td class="address-1"><span id="64033"></span>64033</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrement it</td>
</tr>
<tr>
<td class="address-1"><span id="64034"></span>64034</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the current value in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="64035"></span>64035</td>
<td class="instruction">AND 127</td>
<td class="comment-1" rowspan="1">Is it time for the character to stand up?</td>
</tr>
<tr>
<td class="address-1"><span id="64037"></span>64037</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="64038"></span>64038</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=20</td>
</tr>
<tr>
<td class="address-1"><span id="64039"></span>64039</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Is bit 7 of the knockout delay counter set?</td>
</tr>
<tr>
<td class="address-1"><span id="64041"></span>64041</td>
<td class="instruction">JR NZ,64044</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="64043"></span>64043</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=40</td>
</tr>
<tr>
<td class="address-2"><span id="64044"></span>64044</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Initialise the recovery delay counter (in byte 20 of the character's buffer) to 40 (if the character was hit by another with the same x-coordinate) or 20</td>
</tr>
<tr>
<td class="address-1"><span id="64045"></span>64045</td>
<td class="instruction">CALL <a href="60293.html#60300">60300</a></td>
<td class="comment-1" rowspan="1">Make the character stand up</td>
</tr>
<tr>
<td class="address-1"><span id="64048"></span>64048</td>
<td class="instruction">CALL <a href="63994.html#63997">63997</a></td>
<td class="comment-1" rowspan="1">Place the address of the following instruction into bytes 18 and 19 of the character's buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64051"></span>
<div class="comments">
<div class="paragraph">
This entry point is used after the character has stood up again and while he is still dazed from the collision.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="64051"></span>64051</td>
<td class="instruction">LD L,20</td>
<td class="comment-1" rowspan="2">Decrement the recovery delay counter</td>
</tr>
<tr>
<td class="address-1"><span id="64053"></span>64053</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="64054"></span>64054</td>
<td class="instruction">JR Z,<a href="64131.html">64131</a></td>
<td class="comment-1" rowspan="1">Jump if it has reached 0</td>
</tr>
<tr>
<td class="address-1"><span id="64056"></span>64056</td>
<td class="instruction">LD L,0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="64058"></span>64058</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-1" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="address-1"><span id="64060"></span>64060</td>
<td class="instruction">JR NZ,64075</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="64062"></span>64062</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="address-1"><span id="64063"></span>64063</td>
<td class="instruction">CALL <a href="60179.html">60179</a></td>
<td class="comment-1" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="address-1"><span id="64066"></span>64066</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="64067"></span>64067</td>
<td class="instruction">BIT 7,C</td>
<td class="comment-1" rowspan="1">Can the character move left?</td>
</tr>
<tr>
<td class="address-1"><span id="64069"></span>64069</td>
<td class="instruction">JR Z,64080</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="64071"></span>64071</td>
<td class="instruction">BIT 6,C</td>
<td class="comment-1" rowspan="1">Can the character move right?</td>
</tr>
<tr>
<td class="address-1"><span id="64073"></span>64073</td>
<td class="instruction">JR Z,64080</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-2"><span id="64075"></span>64075</td>
<td class="instruction">CALL <a href="61823.html">61823</a></td>
<td class="comment-1" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="64078"></span>64078</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Rotate bit 0 into bit 7 for no apparent reason</td>
</tr>
<tr>
<td class="address-1"><span id="64079"></span>64079</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Bit 7 of <span class="register">C</span> will be used to decide whether the character should move left next</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64080"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="64131.html">64131</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="64080"></span>64080</td>
<td class="instruction">LD DE,59861</td>
<td class="comment-1" rowspan="2">Load the address of the routine at <a href="59861.html">59861</a> onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="64083"></span>64083</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="address-1"><span id="64084"></span>64084</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the direction descriptor (in <span class="register">C</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="64085"></span>64085</td>
<td class="instruction">CALL <a href="59848.html">59848</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the character's current animatory state and location</td>
</tr>
<tr>
<td class="address-1"><span id="64088"></span>64088</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the direction descriptor to <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="64089"></span>64089</td>
<td class="instruction">RLC C</td>
<td class="comment-1" rowspan="1">Set the carry flag if the character is going to move left</td>
</tr>
<tr>
<td class="address-1"><span id="64091"></span>64091</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="address-1"><span id="64093"></span>64093</td>
<td class="instruction">JR NZ,64109</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64095"></span>
<div class="comments">
<div class="paragraph">
The character is facing left.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="64095"></span>64095</td>
<td class="instruction">JR NC,64111</td>
<td class="comment-1" rowspan="1">Jump if the character is going to move right (take a step backwards)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64097"></span>
<div class="comments">
<div class="paragraph">
The character is going to take a step forwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="64097"></span>64097</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="64098"></span>64098</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">Is it midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="64100"></span>64100</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return (to <a href="59861.html">59861</a>) if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64101"></span>
<div class="comments">
<div class="paragraph">
The character has just moved from the midstride position. Adjust his x-coordinate as appropriate.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="64101"></span>64101</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=x-1 (where x is the character's x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="64102"></span>64102</td>
<td class="instruction">JR C,64106</td>
<td class="comment-1" rowspan="1">Jump if the character is moving left</td>
</tr>
<tr>
<td class="address-1"><span id="64104"></span>64104</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=x+1 (the character is moving right)</td>
</tr>
<tr>
<td class="address-1"><span id="64105"></span>64105</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="address-2"><span id="64106"></span>64106</td>
<td class="instruction">AND 251</td>
<td class="comment-1" rowspan="1">Make sure that bit 2 of the character's animatory state is reset</td>
</tr>
<tr>
<td class="address-1"><span id="64108"></span>64108</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">To <a href="59861.html">59861</a>, to update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64109"></span>
<div class="comments">
<div class="paragraph">
The character is facing right.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="64109"></span>64109</td>
<td class="instruction">JR NC,64097</td>
<td class="comment-1" rowspan="1">Jump if the character is going to move right (take a step forwards)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64111"></span>
<div class="comments">
<div class="paragraph">
The character is going to take a step backwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="64111"></span>64111</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="64112"></span>64112</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">Is it midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="64114"></span>64114</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return (to <a href="59861.html">59861</a>) if not</td>
</tr>
<tr>
<td class="address-1"><span id="64115"></span>64115</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Add 4 to <span class="register">A</span> (without affecting the carry flag) to obtain the correct midstride animatory state (though bit 2 may need to be reset)</td>
</tr>
<tr>
<td class="address-1"><span id="64116"></span>64116</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="64117"></span>64117</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="64118"></span>64118</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="64119"></span>64119</td>
<td class="instruction">JR 64101</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="64004.html">64004</a>
</td>
<td class="up">Up: <a href="../maps/all.html#64005">Map</a></td>
<td class="next">
Next: <a href="64121.html">64121</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/FA05.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>