<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 29218</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29194.html">29194</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29218">Map</a></td>
<td class="next">
Next: <a href="29332.html">29332</a>
</td>
</tr>
</table>
<div class="description">29218: Make a policeman start chasing Sam if appropriate</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="29559.html">29559</a>. Returns with the carry flag reset if the policeman spots, recognises and starts chasing Sam.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">222 or 223 (policeman)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="29218"></span>29218</td>
<td class="instruction">CALL <a href="28842.html">28842</a></td>
<td class="comment-1" rowspan="1">Is Sam close enough that the policeman has a chance of spotting him?</td>
</tr>
<tr>
<td class="address-1"><span id="29221"></span>29221</td>
<td class="instruction">CCF</td>
<td class="comment-1" rowspan="2">Return with the carry flag set if not</td>
</tr>
<tr>
<td class="address-1"><span id="29222"></span>29222</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="29223"></span>29223</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1"><span class="register">E</span> and <span class="register">D</span> hold the horizontal and vertical distances between Sam and the policeman; save these briefly</td>
</tr>
<tr>
<td class="address-1"><span id="29224"></span>29224</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the policeman's character number briefly</td>
</tr>
<tr>
<td class="address-1"><span id="29225"></span>29225</td>
<td class="instruction">LD H,230</td>
<td class="comment-1" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="address-1"><span id="29227"></span>29227</td>
<td class="instruction">CALL <a href="28886.html">28886</a></td>
<td class="comment-1" rowspan="1">Check whether Sam is visible to passers-by</td>
</tr>
<tr>
<td class="address-1"><span id="29230"></span>29230</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="1">Prepare <span class="register">B</span> for the case where Sam is visible to passers-by</td>
</tr>
<tr>
<td class="address-1"><span id="29232"></span>29232</td>
<td class="instruction">JR Z,29248</td>
<td class="comment-1" rowspan="1">Jump if Sam is visible to passers-by</td>
</tr>
<tr>
<td class="address-1"><span id="29234"></span>29234</td>
<td class="instruction">CALL <a href="62518.html">62518</a></td>
<td class="comment-1" rowspan="1">Is Sam standing next to a light switch?</td>
</tr>
<tr>
<td class="address-1"><span id="29237"></span>29237</td>
<td class="instruction">JR Z,29247</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29239"></span>29239</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=window flags for Sam's location</td>
</tr>
<tr>
<td class="address-1"><span id="29240"></span>29240</td>
<td class="instruction">AND 32</td>
<td class="comment-1" rowspan="1">Set the zero flag if the light switch for this window is in the 'on' position</td>
</tr>
<tr>
<td class="address-1"><span id="29242"></span>29242</td>
<td class="instruction">LD A,4</td>
<td class="comment-1" rowspan="1">Prepare <span class="register">A</span> for the case where Sam is standing next to a light switch in the 'on' position</td>
</tr>
<tr>
<td class="address-1"><span id="29244"></span>29244</td>
<td class="instruction">JR Z,29247</td>
<td class="comment-1" rowspan="1">Jump if the light switch for this window is in the 'on' position</td>
</tr>
<tr>
<td class="address-1"><span id="29246"></span>29246</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Prepare <span class="register">A</span> for the case where Sam is neither visible to passers-by nor standing next to a light switch in the 'on' position</td>
</tr>
<tr>
<td class="address-2"><span id="29247"></span>29247</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=0, 4 or 6</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29248"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">B</span>=6 (if Sam is visible to passers-by), or 4 (if Sam is standing next to a light switch that is in the 'on' position), or 0 otherwise.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29248"></span>29248</td>
<td class="instruction">CALL <a href="29332.html">29332</a></td>
<td class="comment-1" rowspan="1">Check whether Sam's disguise is known to the police</td>
</tr>
<tr>
<td class="address-1"><span id="29251"></span>29251</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the policeman's character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="29252"></span>29252</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the horizontal and vertical distances between Sam and the policeman to <span class="register">E</span> and <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="29253"></span>29253</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0, 1, 4, 5, 6 or 7</td>
</tr>
<tr>
<td class="address-1"><span id="29254"></span>29254</td>
<td class="instruction">CP 6</td>
<td class="comment-1" rowspan="1">Is Sam visible to passers-by?</td>
</tr>
<tr>
<td class="address-1"><span id="29256"></span>29256</td>
<td class="instruction">JR NC,29265</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="29258"></span>29258</td>
<td class="instruction">CALL <a href="28886.html">28886</a></td>
<td class="comment-1" rowspan="1">Is the policeman visible to passers-by?</td>
</tr>
<tr>
<td class="address-1"><span id="29261"></span>29261</td>
<td class="instruction">JR NZ,29265</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29263"></span>29263</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="2"><span class="register">B</span>=2, 3, 6 or 7</td>
</tr>
<tr>
<td class="address-1"><span id="29264"></span>29264</td>
<td class="instruction">INC B</td>
</tr>
<tr>
<td class="address-2"><span id="29265"></span>29265</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0-7</td>
</tr>
<tr>
<td class="address-1"><span id="29266"></span>29266</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Save this value in <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="29267"></span>29267</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="5">Point <span class="register">BC</span> at an entry in the table at <a href="29194.html">29194</a></td>
</tr>
<tr>
<td class="address-1"><span id="29268"></span>29268</td>
<td class="instruction">ADD A,B</td>
</tr>
<tr>
<td class="address-1"><span id="29269"></span>29269</td>
<td class="instruction">ADD A,10</td>
</tr>
<tr>
<td class="address-1"><span id="29271"></span>29271</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="29272"></span>29272</td>
<td class="instruction">LD B,114</td>
</tr>
<tr>
<td class="address-1"><span id="29274"></span>29274</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1">Pick up the first byte of the entry</td>
</tr>
<tr>
<td class="address-1"><span id="29275"></span>29275</td>
<td class="instruction">CP D</td>
<td class="comment-1" rowspan="1">Compare it with the vertical distance between Sam and the policeman</td>
</tr>
<tr>
<td class="address-1"><span id="29276"></span>29276</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return (with the carry flag set) if the vertical distance is greater</td>
</tr>
<tr>
<td class="address-1"><span id="29277"></span>29277</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="2">Pick up the second byte of the entry</td>
</tr>
<tr>
<td class="address-1"><span id="29278"></span>29278</td>
<td class="instruction">LD A,(BC)</td>
</tr>
<tr>
<td class="address-1"><span id="29279"></span>29279</td>
<td class="instruction">CP E</td>
<td class="comment-1" rowspan="1">Compare it with the horizontal distance between Sam and the policeman</td>
</tr>
<tr>
<td class="address-1"><span id="29280"></span>29280</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return (with the carry flag set) if the horizontal distance is greater</td>
</tr>
<tr>
<td class="address-1"><span id="29281"></span>29281</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="2">Pick up the third byte of the entry</td>
</tr>
<tr>
<td class="address-1"><span id="29282"></span>29282</td>
<td class="instruction">LD A,(BC)</td>
</tr>
<tr>
<td class="address-1"><span id="29283"></span>29283</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="2">Subtract both the horizontal and vertical distances between Sam and the policeman</td>
</tr>
<tr>
<td class="address-1"><span id="29284"></span>29284</td>
<td class="instruction">SUB E</td>
</tr>
<tr>
<td class="address-1"><span id="29285"></span>29285</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return (with the carry flag set) if the result is negative</td>
</tr>
<tr>
<td class="address-1"><span id="29286"></span>29286</td>
<td class="instruction">BIT 0,L</td>
<td class="comment-1" rowspan="1">Bit 0 of <span class="register">L</span> is set if Sam's current disguise (if any) is known to the police</td>
</tr>
<tr>
<td class="address-1"><span id="29288"></span>29288</td>
<td class="instruction">LD L,29</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29290"></span>29290</td>
<td class="instruction">JR NZ,29322</td>
<td class="comment-1" rowspan="1">Jump if Sam's current disguise is known to the police</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29292"></span>
<div class="comments">
<div class="paragraph">
Sam has been spotted by the policeman, but he's wearing a disguise that is not (yet) known to the police.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="29292"></span>29292</td>
<td class="instruction">LD A,(32713)</td>
<td class="comment-1" rowspan="1">Collect Sam's current disguise ID (1-7) from <a href="32713.html">32713</a></td>
</tr>
<tr>
<td class="address-1"><span id="29295"></span>29295</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="3">Move bits 0-2 into bits 5-7</td>
</tr>
<tr>
<td class="address-1"><span id="29296"></span>29296</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29297"></span>29297</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29298"></span>29298</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy these disguise identifier bits into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="29299"></span>29299</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29300"></span>29300</td>
<td class="instruction">AND 31</td>
<td class="comment-1" rowspan="1">Keep only bits 0-4 (the disguise timeout counter)</td>
</tr>
<tr>
<td class="address-1"><span id="29302"></span>29302</td>
<td class="instruction">JR NZ,29306</td>
<td class="comment-1" rowspan="1">Jump unless they are all 0</td>
</tr>
<tr>
<td class="address-1"><span id="29304"></span>29304</td>
<td class="instruction">LD A,16</td>
<td class="comment-1" rowspan="1">The disguise timeout counter will be initialised to 16</td>
</tr>
<tr>
<td class="address-2"><span id="29306"></span>29306</td>
<td class="instruction">OR C</td>
<td class="comment-1" rowspan="1">Copy the disguise identifier bits from <span class="register">C</span> into bits 5-7 of <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="29307"></span>29307</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy the disguise identifier bits and the timeout counter into byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29308"></span>29308</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=30</td>
</tr>
<tr>
<td class="address-1"><span id="29309"></span>29309</td>
<td class="instruction">CALL <a href="25944.html">25944</a></td>
<td class="comment-1" rowspan="1">Determine Sam's location</td>
</tr>
<tr>
<td class="address-1"><span id="29312"></span>29312</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-1" rowspan="1">Copy Sam's x-coordinate into byte 30 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29313"></span>29313</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=31</td>
</tr>
<tr>
<td class="address-1"><span id="29314"></span>29314</td>
<td class="instruction">AND 3</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0 if z (Sam's z-coordinate) is 4, 2 if z is 2, or 1 if z is 1</td>
</tr>
<tr>
<td class="address-1"><span id="29316"></span>29316</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=0 if z=4, 128 (bit 7 set) if z=2, or 64 (bit 6 set) if z=1</td>
</tr>
<tr>
<td class="address-1"><span id="29317"></span>29317</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29318"></span>29318</td>
<td class="instruction">OR D</td>
<td class="comment-1" rowspan="1">Copy Sam's y-coordinate into bits 0-5 of <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="29319"></span>29319</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy this value into byte 31 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29320"></span>29320</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set the carry flag: the policeman is not chasing Sam</td>
</tr>
<tr>
<td class="address-1"><span id="29321"></span>29321</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29322"></span>
<div class="comments">
<div class="paragraph">
Sam has been spotted by the policeman, and his current disguise (if any) is known to the police.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29322"></span>29322</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Collect byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29323"></span>29323</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there a disguise ID in bits 5-7?</td>
</tr>
<tr>
<td class="address-1"><span id="29324"></span>29324</td>
<td class="instruction">CALL NZ,<a href="29100.html#29126">29126</a></td>
<td class="comment-1" rowspan="1">If so, make that disguise known to the police (if it isn't already)</td>
</tr>
<tr>
<td class="address-1"><span id="29327"></span>29327</td>
<td class="instruction">CALL <a href="29088.html">29088</a></td>
<td class="comment-1" rowspan="1">Set the policeman's destination to Sam's current location</td>
</tr>
<tr>
<td class="address-1"><span id="29330"></span>29330</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag to indicate that the policeman is now chasing Sam</td>
</tr>
<tr>
<td class="address-1"><span id="29331"></span>29331</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29194.html">29194</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29218">Map</a></td>
<td class="next">
Next: <a href="29332.html">29332</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/7222.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>