<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 59148</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="59136.html">59136</a>
</td>
<td class="up">Up: <a href="../maps/all.html#59148">Map</a></td>
<td class="next">
Next: <a href="59366.html">59366</a>
</td>
</tr>
</table>
<div class="description">59148: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="26075.html">26075</a>, <a href="59406.html">59406</a>, <a href="59461.html">59461</a>, <a href="59516.html">59516</a>, <a href="59575.html">59575</a> and <a href="60032.html">60032</a>. Copies a background tile of the play area into the back buffer at <a href="40990.html">40990</a>, superimposes character sprite tiles and a foreground tile as appropriate, and then copies the resultant tile to the screen. Also sets the corresponding attribute byte.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Screen row number (0-19)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">Screen column number (0-31)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="59148"></span>59148</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Put the screen coordinates onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="59149"></span>59149</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="11">Compute the corresponding display file address in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="59150"></span>59150</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="59152"></span>59152</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59153"></span>59153</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59154"></span>59154</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59155"></span>59155</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="59156"></span>59156</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="59157"></span>59157</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="59158"></span>59158</td>
<td class="instruction">AND 24</td>
</tr>
<tr>
<td class="address-1"><span id="59160"></span>59160</td>
<td class="instruction">ADD A,64</td>
</tr>
<tr>
<td class="address-1"><span id="59162"></span>59162</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="59163"></span>59163</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-1" rowspan="1">Put the display file address onto the stack and get the screen coordinates back in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="59164"></span>59164</td>
<td class="instruction">LD DE,(32766)</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=play area coordinates of the top-left corner of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="59168"></span>59168</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=play area coordinates of the tile to be printed</td>
</tr>
<tr>
<td class="address-1"><span id="59169"></span>59169</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Push these coordinates onto the stack...</td>
</tr>
<tr>
<td class="address-1"><span id="59170"></span>59170</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="59171"></span>59171</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">...and pop them into <span class="register">DE'</span></td>
</tr>
<tr>
<td class="address-1"><span id="59172"></span>59172</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59173"></span>
<div class="comments">
<div class="paragraph">
In order to find the graphic data and attribute byte for the play area tile(s) to be printed at (X,Y), we need the T and T' values for that location; these values can be found in turn from the Z, Z' and Z'' values for the location.
</div>
<div class="paragraph">
The Z value (0&lt;=Z&lt;=101) for the play area location (X,Y) is found in byte INT(X/8) of page 184+INT(Y/6). Then the Z' value is found in byte Z of page <a href="48896.html">191</a>, and the Z'' value in byte 128+Z of page 184+X%8.
</div>
<div class="paragraph">
Z'' and bit 7-(X%8) of Z' determine the address, P, of the T value for the play area location (X,Y): Z'' is the LSB, and the MSB is either 160+2*(Y%6) or 172+2*(Y%6), depending on whether bit 7-(X%8) of Z' is reset or set. The address of the T' value is P+256.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59173"></span>59173</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="address-1"><span id="59174"></span>59174</td>
<td class="instruction">LD D,183</td>
<td class="comment-1" rowspan="4">Set <span class="register">D</span>=184+INT(Y/6) (184-190)</td>
</tr>
<tr>
<td class="address-2"><span id="59176"></span>59176</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="59177"></span>59177</td>
<td class="instruction">SUB 6</td>
</tr>
<tr>
<td class="address-1"><span id="59179"></span>59179</td>
<td class="instruction">JR NC,59176</td>
</tr>
<tr>
<td class="address-1"><span id="59181"></span>59181</td>
<td class="instruction">ADD A,86</td>
<td class="comment-1" rowspan="1">80&lt;=<span class="register">A</span>&lt;=85</td>
</tr>
<tr>
<td class="address-1"><span id="59183"></span>59183</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=160, 162, 164, 166, 168 or 170</td>
</tr>
<tr>
<td class="address-1"><span id="59184"></span>59184</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=160+2*(Y%6)</td>
</tr>
<tr>
<td class="address-1"><span id="59185"></span>59185</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="address-1"><span id="59186"></span>59186</td>
<td class="instruction">AND 248</td>
<td class="comment-1" rowspan="1">Keep only bits 3-7</td>
</tr>
<tr>
<td class="address-1"><span id="59188"></span>59188</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="3">Slide them down into bits 0-4; now <span class="register">A</span>=INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="59189"></span>59189</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59190"></span>59190</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59191"></span>59191</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the Z value for the play area location (X,Y)</td>
</tr>
<tr>
<td class="address-1"><span id="59192"></span>59192</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="address-1"><span id="59193"></span>59193</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">Keep only bits 0-2; now <span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="address-1"><span id="59195"></span>59195</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save this value briefly</td>
</tr>
<tr>
<td class="address-1"><span id="59196"></span>59196</td>
<td class="instruction">ADD A,160</td>
<td class="comment-1" rowspan="1">160&lt;=<span class="register">A</span>&lt;=167</td>
</tr>
<tr>
<td class="address-1"><span id="59198"></span>59198</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=160+(X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="59199"></span>59199</td>
<td class="instruction">LD L,21</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 21 of page 160+(X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="59201"></span>59201</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Now <span class="register">C</span>=128 (if X%8=0), 64, 32, 16, 8, 4, 2, or 1 (if X%8=7)</td>
</tr>
<tr>
<td class="address-1"><span id="59202"></span>59202</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z (value of byte INT(X/8) of page 184+INT(Y/6))</td>
</tr>
<tr>
<td class="address-1"><span id="59203"></span>59203</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=Z (0-101)</td>
</tr>
<tr>
<td class="address-1"><span id="59204"></span>59204</td>
<td class="instruction">LD H,191</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the table of Z' values at <a href="48896.html">48896</a></td>
</tr>
<tr>
<td class="address-1"><span id="59206"></span>59206</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=Z' (0, 1, 3, 7, 14, 31, 128, 134, 199, 215, 240, 252, or 255)</td>
</tr>
<tr>
<td class="address-1"><span id="59207"></span>59207</td>
<td class="instruction">AND C</td>
<td class="comment-1" rowspan="1">Is bit 7-(X%8) of Z' set?</td>
</tr>
<tr>
<td class="address-1"><span id="59208"></span>59208</td>
<td class="instruction">JR Z,59214</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="59210"></span>59210</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="3">Otherwise set <span class="register">B</span>=172+2*(Y%6)</td>
</tr>
<tr>
<td class="address-1"><span id="59211"></span>59211</td>
<td class="instruction">ADD A,12</td>
</tr>
<tr>
<td class="address-1"><span id="59213"></span>59213</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-2"><span id="59214"></span>59214</td>
<td class="instruction">SET 7,L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=128+Z (128-229)</td>
</tr>
<tr>
<td class="address-1"><span id="59216"></span>59216</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="address-1"><span id="59217"></span>59217</td>
<td class="instruction">ADD A,184</td>
<td class="comment-1" rowspan="2"><span class="register">H</span>=184+X%8</td>
</tr>
<tr>
<td class="address-1"><span id="59219"></span>59219</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="59220"></span>59220</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=Z'' (value of byte 128+Z of page 184+X%8)</td>
</tr>
<tr>
<td class="address-1"><span id="59221"></span>59221</td>
<td class="instruction">SET 5,E</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=32+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="59223"></span>59223</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=value of byte 32+INT(X/8) of page 184+INT(Y/6)</td>
</tr>
<tr>
<td class="address-1"><span id="59224"></span>59224</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=attribute byte address LSB (0-27)</td>
</tr>
<tr>
<td class="address-1"><span id="59225"></span>59225</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=32+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="59226"></span>59226</td>
<td class="instruction">XOR 96</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=64+INT(X/8)</td>
</tr>
<tr>
<td class="address-1"><span id="59228"></span>59228</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the window flags for the play area location (X,Y)</td>
</tr>
<tr>
<td class="address-1"><span id="59229"></span>59229</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T (value of byte Z'' of page 160+2*(Y%6) or 172+2*(Y%6))</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59230"></span>
<div class="comments">
<div class="paragraph">
<span id="tValue" /> We have collected the T value for the play area location (X,Y). Bits 7 and 6 of T have the following meanings:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Value</th>
<th colspan="1" rowspan="1">Meaning</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">11</td>
<td class="" colspan="1" rowspan="1">This location has a background tile and a transparent foreground tile</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">10</td>
<td class="" colspan="1" rowspan="1">This location has a blank background tile and a transparent foreground tile (used by windows and house number signs)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">01</td>
<td class="" colspan="1" rowspan="1">This location has an opaque foreground tile only (characters with a z-coordinate of 1 will appear behind it)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">00</td>
<td class="" colspan="1" rowspan="1">This location has a background tile only (characters with a z-coordinate of 1 will appear in front of it)</td>
</tr>
</table>
</div>
<div class="paragraph">
When bits 7 and 6 of T are both set (11), bits 2-5 of T and bit 7 of T' indicate the LSB of the address of the background tile's graphic data; the MSB is always 128. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from bits 0-6 of T'; the MSBs are always 128.
</div>
<div class="paragraph">
When bit 7 of T is set and bit 6 is reset (10), bits 3-5 are unused, and bit 2 is set only if the right-hand window of a pair is at this location. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from T' (0-31) and the window flags; the MSBs are always 128.
</div>
<div class="paragraph">
When bit 7 of T is reset, bit 5 is unused (always reset), and bits 2-4 indicate the MSB of the address of the tile's graphic data (128, 136, 144, 152 or 160); the LSB is equal to T'.
</div>
<div class="paragraph">
Finally, bits 1 and 0 of T indicate the MSB of the address of the tile's attribute byte (168, 169, 170 or 171); the LSB (0-27, already collected in <span class="register">L</span> at this point) is found in byte 32+INT(X/8) of page 184+INT(Y/6).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59230"></span>59230</td>
<td class="instruction">AND 3</td>
<td class="comment-1" rowspan="1">Keep only bits 0 and 1 of T</td>
</tr>
<tr>
<td class="address-1"><span id="59232"></span>59232</td>
<td class="instruction">ADD A,168</td>
<td class="comment-1" rowspan="1">168&lt;=<span class="register">A</span>&lt;=171</td>
</tr>
<tr>
<td class="address-1"><span id="59234"></span>59234</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">168&lt;=<span class="register">H</span>&lt;=171</td>
</tr>
<tr>
<td class="address-1"><span id="59235"></span>59235</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=play area tile attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="59236"></span>59236</td>
<td class="instruction">LD (43038),A</td>
<td class="comment-1" rowspan="1">Save it at <a href="43038.html">43038</a> for later retrieval</td>
</tr>
<tr>
<td class="address-1"><span id="59239"></span>59239</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T</td>
</tr>
<tr>
<td class="address-1"><span id="59240"></span>59240</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=161+2*(Y%6) or 173+2*(Y%6); now <span class="register">BC</span> points at the T' value</td>
</tr>
<tr>
<td class="address-1"><span id="59241"></span>59241</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Does this play area location have a background tile and a foreground tile?</td>
</tr>
<tr>
<td class="address-1"><span id="59242"></span>59242</td>
<td class="instruction">JR NC,59324</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59244"></span>
<div class="comments">
<div class="paragraph">
The play area location under consideration has a background tile and a foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59244"></span>59244</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Is there a window or a house number sign here?</td>
</tr>
<tr>
<td class="address-1"><span id="59246"></span>59246</td>
<td class="instruction">JR NZ,59268</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59248"></span>
<div class="comments">
<div class="paragraph">
There is a window or a house number sign at this location.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59248"></span>59248</td>
<td class="instruction">CALL <a href="63450.html">63450</a></td>
<td class="comment-1" rowspan="1">Collect the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="59251"></span>59251</td>
<td class="instruction">JR Z,59259</td>
<td class="comment-1" rowspan="1">Jump unless we are dealing with the right-hand window of a pair</td>
</tr>
<tr>
<td class="address-1"><span id="59253"></span>59253</td>
<td class="instruction">AND 35</td>
<td class="comment-1" rowspan="1">Keep only bits 5 (light indicator), 1 and 0 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="59255"></span>59255</td>
<td class="instruction">ADD A,96</td>
<td class="comment-1" rowspan="1">Set bit 7 if the light is off (i.e. copy bit 5 into bit 7)</td>
</tr>
<tr>
<td class="address-1"><span id="59257"></span>59257</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="2">Move bits 1 and 0 (decoration indicator) into bits 7 and 6, and the light indicator back into bit 5</td>
</tr>
<tr>
<td class="address-1"><span id="59258"></span>59258</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-2"><span id="59259"></span>59259</td>
<td class="instruction">AND 224</td>
<td class="comment-1" rowspan="1">Keep only bits 5 (light indicator), 6 and 7 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="address-1"><span id="59261"></span>59261</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Copy these bits to <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="59262"></span>59262</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T' (0-31 for window tiles and house number sign tiles)</td>
</tr>
<tr>
<td class="address-1"><span id="59263"></span>59263</td>
<td class="instruction">OR E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="address-1"><span id="59264"></span>59264</td>
<td class="instruction">LD L,159</td>
<td class="comment-1" rowspan="1">Use tile 159 in page 128 (which is blank) as the background tile</td>
</tr>
<tr>
<td class="address-1"><span id="59266"></span>59266</td>
<td class="instruction">JR 59281</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59268"></span>
<div class="comments">
<div class="paragraph">
There is no window or house number sign at this location, and it has a background tile and a transparent foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="59268"></span>59268</td>
<td class="instruction">AND 120</td>
<td class="comment-1" rowspan="2">Keep only bits 2-5 of T</td>
</tr>
<tr>
<td class="address-1"><span id="59270"></span>59270</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="59271"></span>59271</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2">Shift bits 2-5 into bits 1-4 and set bit 7</td>
</tr>
<tr>
<td class="address-1"><span id="59272"></span>59272</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="59273"></span>59273</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=background tile reference (even number &gt;= 128)</td>
</tr>
<tr>
<td class="address-1"><span id="59274"></span>59274</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="address-1"><span id="59275"></span>59275</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Is bit 7 of T' set?</td>
</tr>
<tr>
<td class="address-1"><span id="59276"></span>59276</td>
<td class="instruction">JR NC,59279</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="59278"></span>59278</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Increment the background tile reference (to an odd number &gt;= 129)</td>
</tr>
<tr>
<td class="address-2"><span id="59279"></span>59279</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=T' with bit 7 set</td>
</tr>
<tr>
<td class="address-1"><span id="59280"></span>59280</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-2"><span id="59281"></span>59281</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="address-1"><span id="59282"></span>59282</td>
<td class="instruction">LD H,128</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the background tile graphic data</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59284"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">HL</span> holds the base address of the background tile graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59284"></span>59284</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the foreground tile identifier (in <span class="register">E</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="59285"></span>59285</td>
<td class="instruction">CALL <a href="59136.html">59136</a></td>
<td class="comment-1" rowspan="1">Copy the background tile into the back buffer at <a href="40990.html">40990</a></td>
</tr>
<tr>
<td class="address-1"><span id="59288"></span>59288</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1)</td>
</tr>
<tr>
<td class="address-1"><span id="59290"></span>59290</td>
<td class="instruction">CALL <a href="59635.html#59640">59640</a></td>
</tr>
<tr>
<td class="address-1"><span id="59293"></span>59293</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the foreground tile identifier to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59294"></span>
<div class="comments">
<div class="paragraph">
Now we superimpose the foreground tile. The 16 graphic and mask bytes for the foreground tile are found in two groups of 8 bytes in pages 128-135.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59294"></span>59294</td>
<td class="instruction">LD B,192</td>
<td class="comment-1" rowspan="1">The LSB of the first group of 8 bytes is found in page <a href="49152.html">192</a></td>
</tr>
<tr>
<td class="address-1"><span id="59296"></span>59296</td>
<td class="instruction">LD DE,40990</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the back buffer at <a href="40990.html">40990</a></td>
</tr>
<tr>
<td class="address-1"><span id="59299"></span>59299</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=LSB of the first group of 8 bytes</td>
</tr>
<tr>
<td class="address-2"><span id="59300"></span>59300</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Copy the LSB to <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="59301"></span>59301</td>
<td class="instruction">LD H,128</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first byte (a graphic byte) in the group</td>
</tr>
<tr>
<td class="address-1"><span id="59303"></span>59303</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="1">There are 4 pairs of bytes per group</td>
</tr>
<tr>
<td class="address-2"><span id="59305"></span>59305</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="59306"></span>59306</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">OR on the graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="59307"></span>59307</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the corresponding mask byte</td>
</tr>
<tr>
<td class="address-1"><span id="59308"></span>59308</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">AND on the mask byte</td>
</tr>
<tr>
<td class="address-1"><span id="59309"></span>59309</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="59310"></span>59310</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Replace the back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="59311"></span>59311</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next back buffer byte</td>
</tr>
<tr>
<td class="address-1"><span id="59312"></span>59312</td>
<td class="instruction">DJNZ 59305</td>
<td class="comment-1" rowspan="1">Jump back until all 8 bytes have been done</td>
</tr>
<tr>
<td class="address-1"><span id="59314"></span>59314</td>
<td class="instruction">LD B,193</td>
<td class="comment-1" rowspan="1">The LSB of the second group of 8 bytes is found in page <a href="49408.html">193</a></td>
</tr>
<tr>
<td class="address-1"><span id="59316"></span>59316</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=LSB of the second group of 8 bytes</td>
</tr>
<tr>
<td class="address-1"><span id="59317"></span>59317</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we've just done the second group</td>
</tr>
<tr>
<td class="address-1"><span id="59318"></span>59318</td>
<td class="instruction">LD C,255</td>
<td class="comment-1" rowspan="1">Signal: the second group is next</td>
</tr>
<tr>
<td class="address-1"><span id="59320"></span>59320</td>
<td class="instruction">JR NZ,59300</td>
<td class="comment-1" rowspan="1">Jump back until both groups have been done</td>
</tr>
<tr>
<td class="address-1"><span id="59322"></span>59322</td>
<td class="instruction">JR 59342</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59324"></span>
<div class="comments">
<div class="paragraph">
The play area location under consideration has only one tile: either a background tile (if bit 6 of T is reset), or an opaque foreground tile (bit 6 of T set).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="59324"></span>59324</td>
<td class="instruction">AND 184</td>
<td class="comment-1" rowspan="1">Keep only bits 3-5 and 7 (bits 2-4 and 6 of T)</td>
</tr>
<tr>
<td class="address-1"><span id="59326"></span>59326</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Copy bit 6 of T into the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="59327"></span>59327</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="59328"></span>59328</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2">Now <span class="register">A</span> has bit 7 set, and a copy of bits 2-4 of T in bits 3-5</td>
</tr>
<tr>
<td class="address-1"><span id="59329"></span>59329</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="59330"></span>59330</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=128, 136, 144, 152 or 160</td>
</tr>
<tr>
<td class="address-1"><span id="59331"></span>59331</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="address-1"><span id="59332"></span>59332</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the tile graphic data</td>
</tr>
<tr>
<td class="address-1"><span id="59333"></span>59333</td>
<td class="instruction">CALL <a href="59136.html">59136</a></td>
<td class="comment-1" rowspan="1">Copy the tile into the back buffer at <a href="40990.html">40990</a></td>
</tr>
<tr>
<td class="address-1"><span id="59336"></span>59336</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="59337"></span>59337</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1) if we're dealing with a background tile</td>
</tr>
<tr>
<td class="address-1"><span id="59339"></span>59339</td>
<td class="instruction">CALL NC,<a href="59635.html#59640">59640</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59342"></span>
<div class="comments">
<div class="paragraph">
Now we can superimpose sprite tiles for characters who are in the foreground.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="59342"></span>59342</td>
<td class="instruction">LD A,2</td>
<td class="comment-1" rowspan="2">Superimpose sprite tiles for characters who are between a building and the sidewalk (z=2), and then for characters who are on the sidewalk or road (z=4)</td>
</tr>
<tr>
<td class="address-1"><span id="59344"></span>59344</td>
<td class="instruction">CALL <a href="59635.html">59635</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="59347"></span>
<div class="comments">
<div class="paragraph">
The tile in the back buffer is now ready to be drawn.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="59347"></span>59347</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=display file address</td>
</tr>
<tr>
<td class="address-1"><span id="59348"></span>59348</td>
<td class="instruction">LD C,E</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=corresponding attribute file address LSB</td>
</tr>
<tr>
<td class="address-1"><span id="59349"></span>59349</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=display file address MSB (64, 72 or 80)</td>
</tr>
<tr>
<td class="address-1"><span id="59350"></span>59350</td>
<td class="instruction">LD HL,40990</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the back buffer containing the tile to be drawn</td>
</tr>
<tr>
<td class="address-1"><span id="59353"></span>59353</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4"><span class="register">A</span>=88, 89 or 90</td>
</tr>
<tr>
<td class="address-1"><span id="59354"></span>59354</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59355"></span>59355</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="59356"></span>59356</td>
<td class="instruction">ADD A,80</td>
</tr>
<tr>
<td class="address-1"><span id="59358"></span>59358</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the appropriate byte of the attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="59359"></span>59359</td>
<td class="instruction">LD A,(43038)</td>
<td class="comment-1" rowspan="1">Collect the attribute byte saved earlier at <a href="43038.html">43038</a></td>
</tr>
<tr>
<td class="address-1"><span id="59362"></span>59362</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Copy it to the attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="59363"></span>59363</td>
<td class="instruction">JP <a href="59136.html#59139">59139</a></td>
<td class="comment-1" rowspan="1">Copy the tile to the display file</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="59136.html">59136</a>
</td>
<td class="up">Up: <a href="../maps/all.html#59148">Map</a></td>
<td class="next">
Next: <a href="59366.html">59366</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/E70C.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>