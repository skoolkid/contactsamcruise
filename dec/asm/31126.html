<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 31126</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31110.html">31110</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31126">Map</a></td>
<td class="next">
Next: <a href="31204.html">31204</a>
</td>
</tr>
</table>
<div class="description">31126: Collect a keypress during the game (or simulate one in demo mode)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Called from the main loop at <a href="61483.html">61483</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="31126"></span>31126</td>
<td class="instruction">LD A,(32750)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current game mode (0-4)</td>
</tr>
<tr>
<td class="address-1"><span id="31129"></span>31129</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it demo mode?</td>
</tr>
<tr>
<td class="address-1"><span id="31130"></span>31130</td>
<td class="instruction">JP NZ,<a href="60082.html">60082</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31133"></span>
<div class="comments">
<div class="paragraph">
It's demo mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="31133"></span>31133</td>
<td class="instruction">CALL <a href="60121.html">60121</a></td>
<td class="comment-1" rowspan="1">Collect the ASCII code of the last key pressed in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="31136"></span>31136</td>
<td class="instruction">JP NZ,<a href="61630.html#61674">61674</a></td>
<td class="comment-1" rowspan="1">Start a new game if a game key was pressed</td>
</tr>
<tr>
<td class="address-1"><span id="31139"></span>31139</td>
<td class="instruction">LD A,38</td>
<td class="comment-1" rowspan="1">Message <a href="27089.html">38</a>: 'PRESS A KEY TO PLAY'</td>
</tr>
<tr>
<td class="address-1"><span id="31141"></span>31141</td>
<td class="instruction">LD (32722),A</td>
<td class="comment-1" rowspan="1">Store this message number at <a href="32722.html">32722</a> so that it can be monitored</td>
</tr>
<tr>
<td class="address-1"><span id="31144"></span>31144</td>
<td class="instruction">CALL <a href="30972.html#30975">30975</a></td>
<td class="comment-1" rowspan="1">Is this message in the message queue?</td>
</tr>
<tr>
<td class="address-1"><span id="31147"></span>31147</td>
<td class="instruction">CALL NZ,<a href="28357.html">28357</a></td>
<td class="comment-1" rowspan="1">If not, add it to the message queue (again)</td>
</tr>
<tr>
<td class="address-1"><span id="31150"></span>31150</td>
<td class="instruction">LD A,248</td>
<td class="comment-1" rowspan="2">Set bits 3-7 at <a href="32746.html">32746</a>, effectively giving Sam the keys to all the houses</td>
</tr>
<tr>
<td class="address-1"><span id="31152"></span>31152</td>
<td class="instruction">LD (32746),A</td>
</tr>
<tr>
<td class="address-1"><span id="31155"></span>31155</td>
<td class="instruction">LD A,(58891)</td>
<td class="comment-1" rowspan="1">Pick up byte 11 of Sam's buffer (which holds his destination y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="31158"></span>31158</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Has a destination been set for Sam yet?</td>
</tr>
<tr>
<td class="address-1"><span id="31159"></span>31159</td>
<td class="instruction">JR NZ,31188</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31161"></span>
<div class="comments">
<div class="paragraph">
We need to set a new destination for Sam.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="31161"></span>31161</td>
<td class="instruction">CALL <a href="61823.html">61823</a></td>
<td class="comment-1" rowspan="3">Get an even random number between 134 and 148 in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="31164"></span>31164</td>
<td class="instruction">AND 14</td>
</tr>
<tr>
<td class="address-1"><span id="31166"></span>31166</td>
<td class="instruction">ADD A,134</td>
</tr>
<tr>
<td class="address-1"><span id="31168"></span>31168</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at an entry in the table of locations at <a href="31110.html">31110</a></td>
</tr>
<tr>
<td class="address-1"><span id="31169"></span>31169</td>
<td class="instruction">LD H,121</td>
</tr>
<tr>
<td class="address-1"><span id="31171"></span>31171</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Collect the location coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="31172"></span>31172</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="31173"></span>31173</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="31174"></span>31174</td>
<td class="instruction">LD HL,58890</td>
<td class="comment-1" rowspan="4">Copy the location coordinates into bytes 10 and 11 of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31177"></span>31177</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="address-1"><span id="31178"></span>31178</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="31179"></span>31179</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="address-1"><span id="31180"></span>31180</td>
<td class="instruction">LD C,1</td>
<td class="comment-1" rowspan="1">Assume a z-coordinate of 1 (indoors)</td>
</tr>
<tr>
<td class="address-1"><span id="31182"></span>31182</td>
<td class="instruction">CALL <a href="60726.html#60743">60743</a></td>
<td class="comment-1" rowspan="1">Obtain an identifier for the location</td>
</tr>
<tr>
<td class="address-1"><span id="31185"></span>31185</td>
<td class="instruction">LD L,12</td>
<td class="comment-1" rowspan="2">Copy the destination location identifier into byte 12 of Sam's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="31187"></span>31187</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-2"><span id="31188"></span>31188</td>
<td class="instruction">LD H,230</td>
<td class="comment-1" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="address-1"><span id="31190"></span>31190</td>
<td class="instruction">CALL <a href="60812.html">60812</a></td>
<td class="comment-1" rowspan="1">Determine the next move Sam should make to reach his destination</td>
</tr>
<tr>
<td class="address-1"><span id="31193"></span>31193</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is Sam already at his destination?</td>
</tr>
<tr>
<td class="address-1"><span id="31194"></span>31194</td>
<td class="instruction">JR Z,31161</td>
<td class="comment-1" rowspan="1">Jump back to set a new destination if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="31196"></span>
<div class="comments">
<div class="paragraph">
Sam's destination has been set. Now to simulate a keypress that will make him take the next step towards it.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="31196"></span>31196</td>
<td class="instruction">ADD A,127</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the offset of the appropriate keypress to simulate in the table at <a href="31104.html">31104</a></td>
</tr>
<tr>
<td class="address-1"><span id="31198"></span>31198</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="31199"></span>31199</td>
<td class="instruction">LD H,121</td>
</tr>
<tr>
<td class="address-1"><span id="31201"></span>31201</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the keypress offset</td>
</tr>
<tr>
<td class="address-1"><span id="31202"></span>31202</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Make sure the zero flag is reset to indicate that a simulated keypress was made (this instruction is redundant)</td>
</tr>
<tr>
<td class="address-1"><span id="31203"></span>31203</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31110.html">31110</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31126">Map</a></td>
<td class="next">
Next: <a href="31204.html">31204</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20221122</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/7996.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>