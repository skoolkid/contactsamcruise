<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 28357</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28355.html">28355</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28357">Map</a></td>
<td class="next">
Next: <a href="28611.html">28611</a>
</td>
</tr>
</table>
<div class="description">28357: Add a message to the message queue</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="30154.html">30154</a>, <a href="30211.html">30211</a>, <a href="30989.html">30989</a>, <a href="31126.html">31126</a>, <a href="31594.html">31594</a> and <a href="64338.html">64338</a>. Adds a message to the message queue, and updates the message line (by clearing it or displaying the next message or message portion) if necessary.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Message number</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="28357"></span>28357</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=number of the message to be queued</td>
</tr>
<tr>
<td class="address-1"><span id="28358"></span>28358</td>
<td class="instruction">LD HL,32695</td>
<td class="comment-1" rowspan="1"><a href="32695.html">32695</a> holds the index of the current message in the message queue at <a href="32696.html">32696</a></td>
</tr>
<tr>
<td class="address-1"><span id="28361"></span>28361</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the index of the current message</td>
</tr>
<tr>
<td class="address-1"><span id="28362"></span>28362</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=index of the last message in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28363"></span>28363</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="28365"></span>28365</td>
<td class="instruction">ADD A,184</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the corresponding slot in the message queue at <a href="32696.html">32696</a></td>
</tr>
<tr>
<td class="address-1"><span id="28367"></span>28367</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28368"></span>28368</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the message number from this slot</td>
</tr>
<tr>
<td class="address-1"><span id="28369"></span>28369</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the slot empty?</td>
</tr>
<tr>
<td class="address-1"><span id="28370"></span>28370</td>
<td class="instruction">JR Z,28386</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28372"></span>
<div class="comments">
<div class="paragraph">
The message queue is full. To make space for the new message, we remove the second message from the queue, and move the following messages up a slot, thus leaving the final slot free.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28372"></span>28372</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="1">There are six messages to move up a slot, and one to remove completely</td>
</tr>
<tr>
<td class="address-1"><span id="28374"></span>28374</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1">The final slot will be made empty</td>
</tr>
<tr>
<td class="address-2"><span id="28376"></span>28376</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the message number from this slot</td>
</tr>
<tr>
<td class="address-1"><span id="28377"></span>28377</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Replace it with 0 or the message number from the previous slot</td>
</tr>
<tr>
<td class="address-1"><span id="28378"></span>28378</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save the old contents of this slot</td>
</tr>
<tr>
<td class="address-1"><span id="28379"></span>28379</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="4">Point <span class="register">HL</span> at the previous slot in the message queue</td>
</tr>
<tr>
<td class="address-1"><span id="28380"></span>28380</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="28381"></span>28381</td>
<td class="instruction">OR 8</td>
</tr>
<tr>
<td class="address-1"><span id="28383"></span>28383</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28384"></span>28384</td>
<td class="instruction">DJNZ 28376</td>
<td class="comment-1" rowspan="1">Jump back to deal with the remaining slots</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28386"></span>
<div class="comments">
<div class="paragraph">
The following loop looks for the first empty slot in the message queue, and stores the message number there.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28386"></span>28386</td>
<td class="instruction">LD L,183</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32695.html">32695</a> (which holds the index of the current message in the message queue at <a href="32696.html">32696</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="28388"></span>28388</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="1">Copy the index to <span class="register">L</span></td>
</tr>
<tr>
<td class="address-2"><span id="28389"></span>28389</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=index of the next message in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28390"></span>28390</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="28391"></span>28391</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="28393"></span>28393</td>
<td class="instruction">ADD A,184</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the corresponding slot in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28395"></span>28395</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28396"></span>28396</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the message number from this slot</td>
</tr>
<tr>
<td class="address-1"><span id="28397"></span>28397</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the slot empty?</td>
</tr>
<tr>
<td class="address-1"><span id="28398"></span>28398</td>
<td class="instruction">JR NZ,28389</td>
<td class="comment-1" rowspan="1">Jump back if not to check the next slot</td>
</tr>
<tr>
<td class="address-1"><span id="28400"></span>28400</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-1" rowspan="1">Store the message number in this slot</td>
</tr>
<tr>
<td class="address-1"><span id="28401"></span>28401</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="3"></td>
</tr>
<tr>
<td class="address-1"><span id="28402"></span>28402</td>
<td class="instruction">NOP</td>
</tr>
<tr>
<td class="address-1"><span id="28403"></span>28403</td>
<td class="instruction">NOP</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28404"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="30972.html">30972</a>, <a href="30989.html">30989</a> and <a href="61440.html">61440</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28404"></span>28404</td>
<td class="instruction">LD HL,32695</td>
<td class="comment-1" rowspan="1"><a href="32695.html">32695</a> holds the index of the current message in the message queue at <a href="32696.html">32696</a></td>
</tr>
<tr>
<td class="address-1"><span id="28407"></span>28407</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the index of the current message (0-7)</td>
</tr>
<tr>
<td class="address-1"><span id="28408"></span>28408</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the corresponding slot in the message queue</td>
</tr>
<tr>
<td class="address-1"><span id="28410"></span>28410</td>
<td class="instruction">ADD A,184</td>
</tr>
<tr>
<td class="address-1"><span id="28412"></span>28412</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28413"></span>28413</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the number of the current message</td>
</tr>
<tr>
<td class="address-1"><span id="28414"></span>28414</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there a message being displayed at the moment?</td>
</tr>
<tr>
<td class="address-1"><span id="28415"></span>28415</td>
<td class="instruction">JR NZ,28426</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="28417"></span>28417</td>
<td class="instruction">CALL <a href="64121.html">64121</a></td>
<td class="comment-1" rowspan="1">Check whether there are any messages remaining in the message queue</td>
</tr>
<tr>
<td class="address-1"><span id="28420"></span>28420</td>
<td class="instruction">LD HL,(23672)</td>
<td class="comment-1" rowspan="1">Collect the two least significant bytes of the system variable FRAMES in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="28423"></span>28423</td>
<td class="instruction">JR NZ,28454</td>
<td class="comment-1" rowspan="1">Jump if there is another message waiting in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28425"></span>28425</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">This return always happens</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28426"></span>
<div class="comments">
<div class="paragraph">
There is a message being displayed at the moment.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28426"></span>28426</td>
<td class="instruction">CALL <a href="30160.html">30160</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=minimum number of subintervals of 0.64s that the current message (or message portion) should be displayed for before being replaced</td>
</tr>
<tr>
<td class="address-1"><span id="28429"></span>28429</td>
<td class="instruction">LD HL,0</td>
<td class="comment-1" rowspan="6"><span class="register">DE</span>=32*<span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="28432"></span>28432</td>
<td class="instruction">LD DE,32</td>
</tr>
<tr>
<td class="address-2"><span id="28435"></span>28435</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="28436"></span>28436</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="28437"></span>28437</td>
<td class="instruction">JR NZ,28435</td>
</tr>
<tr>
<td class="address-1"><span id="28439"></span>28439</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="28440"></span>28440</td>
<td class="instruction">LD HL,(23672)</td>
<td class="comment-1" rowspan="1">Collect the two least significant bytes of the system variable FRAMES in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="28443"></span>28443</td>
<td class="instruction">LD BC,(32672)</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=two least significant bytes of the system variable FRAMES as they were when the last message was displayed</td>
</tr>
<tr>
<td class="address-1"><span id="28447"></span>28447</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="2">Is it time to display the next message (or next portion of the current message) yet?</td>
</tr>
<tr>
<td class="address-1"><span id="28449"></span>28449</td>
<td class="instruction">SBC HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="28451"></span>28451</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="address-1"><span id="28452"></span>28452</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="2">Restore the current value of the two least significant bytes of the system variable FRAMES to <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="28453"></span>28453</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-2"><span id="28454"></span>28454</td>
<td class="instruction">LD (32672),HL</td>
<td class="comment-1" rowspan="1">Update the message display timer at <a href="32672.html">32672</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28457"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="29716.html">29716</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28457"></span>28457</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="28458"></span>28458</td>
<td class="instruction">LD HL,32639</td>
<td class="comment-1" rowspan="5">Fill the message buffer at <a href="32608.html">32608</a> with spaces</td>
</tr>
<tr>
<td class="address-1"><span id="28461"></span>28461</td>
<td class="instruction">LD BC,8224</td>
</tr>
<tr>
<td class="address-2"><span id="28464"></span>28464</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="28465"></span>28465</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="28466"></span>28466</td>
<td class="instruction">DJNZ 28464</td>
</tr>
<tr>
<td class="address-1"><span id="28468"></span>28468</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="28469"></span>28469</td>
<td class="instruction">LD HL,32641</td>
<td class="comment-1" rowspan="1"><a href="32641.html">32641</a> holds the submessage indicator (0, 2, 4, 6 or 8)</td>
</tr>
<tr>
<td class="address-1"><span id="28472"></span>28472</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick it up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="28473"></span>28473</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Are we in the middle of a message at the moment?</td>
</tr>
<tr>
<td class="address-2"><span id="28474"></span>28474</td>
<td class="instruction">JR NZ,28512</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28476"></span>
<div class="comments">
<div class="paragraph">
We've reached the end of the current message. Time to display the next message, or clear the message line if there are no messages waiting in the queue.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28476"></span>28476</td>
<td class="instruction">LD L,183</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32695.html">32695</a> (which holds the index of the current message in the message queue at <a href="32696.html">32696</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="28478"></span>28478</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up this index</td>
</tr>
<tr>
<td class="address-1"><span id="28479"></span>28479</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment the index</td>
</tr>
<tr>
<td class="address-1"><span id="28480"></span>28480</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the current message in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28482"></span>28482</td>
<td class="instruction">ADD A,184</td>
</tr>
<tr>
<td class="address-1"><span id="28484"></span>28484</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28485"></span>28485</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Set the current message number to 0 (no message)</td>
</tr>
<tr>
<td class="address-1"><span id="28487"></span>28487</td>
<td class="instruction">SUB 7</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the next message in the queue</td>
</tr>
<tr>
<td class="address-1"><span id="28489"></span>28489</td>
<td class="instruction">OR 8</td>
</tr>
<tr>
<td class="address-1"><span id="28491"></span>28491</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="28492"></span>28492</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the message number</td>
</tr>
<tr>
<td class="address-1"><span id="28493"></span>28493</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is there another message waiting in the queue?</td>
</tr>
<tr>
<td class="address-1"><span id="28494"></span>28494</td>
<td class="instruction">JR Z,28534</td>
<td class="comment-1" rowspan="1">Jump if not to clear the message line</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28496"></span>
<div class="comments">
<div class="paragraph">
Here we transition from no message to top-level message, or from one message level to a submessage. <span class="register">A</span> holds the (sub)message number.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28496"></span>28496</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">BC</span> at the LSB of the message address</td>
</tr>
<tr>
<td class="address-1"><span id="28497"></span>28497</td>
<td class="instruction">LD B,108</td>
</tr>
<tr>
<td class="address-1"><span id="28499"></span>28499</td>
<td class="instruction">LD L,129</td>
<td class="comment-1" rowspan="3">Increase the submessage indicator at <a href="32641.html">32641</a> by 2 (to 2, 4, 6 or 8)</td>
</tr>
<tr>
<td class="address-1"><span id="28501"></span>28501</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="28502"></span>28502</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="28503"></span>28503</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at where the LSB of the message address will be stored</td>
</tr>
<tr>
<td class="address-1"><span id="28504"></span>28504</td>
<td class="instruction">SET 7,L</td>
</tr>
<tr>
<td class="address-1"><span id="28506"></span>28506</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="2">Copy the LSB of the message address here</td>
</tr>
<tr>
<td class="address-1"><span id="28507"></span>28507</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="28508"></span>28508</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the MSB of the message address</td>
</tr>
<tr>
<td class="address-1"><span id="28509"></span>28509</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at where the MSB of the message address will be stored</td>
</tr>
<tr>
<td class="address-1"><span id="28510"></span>28510</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="2">Copy the MSB of the message address here</td>
</tr>
<tr>
<td class="address-1"><span id="28511"></span>28511</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-2"><span id="28512"></span>28512</td>
<td class="instruction">LD L,129</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32641.html">32641</a> (submessage indicator)</td>
</tr>
<tr>
<td class="address-1"><span id="28514"></span>28514</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the LSB of the address of the next character in the message</td>
</tr>
<tr>
<td class="address-1"><span id="28515"></span>28515</td>
<td class="instruction">SET 7,L</td>
</tr>
<tr>
<td class="address-1"><span id="28517"></span>28517</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the LSB in <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="28518"></span>28518</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment the LSB</td>
</tr>
<tr>
<td class="address-1"><span id="28519"></span>28519</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the MSB of the address of the next character in the message</td>
</tr>
<tr>
<td class="address-1"><span id="28520"></span>28520</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the MSB in <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="28521"></span>28521</td>
<td class="instruction">JR NZ,28524</td>
<td class="comment-1" rowspan="1">Jump unless the LSB rolled over to 0</td>
</tr>
<tr>
<td class="address-1"><span id="28523"></span>28523</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment the MSB</td>
</tr>
<tr>
<td class="address-2"><span id="28524"></span>28524</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ASCII code of the next character in the message</td>
</tr>
<tr>
<td class="address-1"><span id="28525"></span>28525</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it the end marker?</td>
</tr>
<tr>
<td class="address-1"><span id="28526"></span>28526</td>
<td class="instruction">JR NZ,28543</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28528"></span>
<div class="comments">
<div class="paragraph">
We've reached the end of the top-level message or a submessage.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28528"></span>28528</td>
<td class="instruction">LD L,129</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32641.html">32641</a> (submessage indicator)</td>
</tr>
<tr>
<td class="address-1"><span id="28530"></span>28530</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="2">Reduce the submessage indicator by 2</td>
</tr>
<tr>
<td class="address-1"><span id="28531"></span>28531</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="28532"></span>28532</td>
<td class="instruction">JR NZ,28474</td>
<td class="comment-1" rowspan="1">Jump unless we've reached the end of the top-level message</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28534"></span>
<div class="comments">
<div class="paragraph">
It's time to print the contents of the message buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28534"></span>28534</td>
<td class="instruction">LD HL,32608</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first byte of the message buffer at <a href="32608.html">32608</a></td>
</tr>
<tr>
<td class="address-1"><span id="28537"></span>28537</td>
<td class="instruction">LD DE,20608</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=display file address</td>
</tr>
<tr>
<td class="address-1"><span id="28540"></span>28540</td>
<td class="instruction">JP <a href="28160.html">28160</a></td>
<td class="comment-1" rowspan="1">Print the contents of the message buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28543"></span>
<div class="comments">
<div class="paragraph">
At this point <span class="register">A</span> holds the ASCII code of the next character in the message.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28543"></span>28543</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">Is the ASCII code of the character &lt; 32?</td>
</tr>
<tr>
<td class="address-1"><span id="28545"></span>28545</td>
<td class="instruction">JR C,28496</td>
<td class="comment-1" rowspan="1">Jump if so to deal with a submessage</td>
</tr>
<tr>
<td class="address-1"><span id="28547"></span>28547</td>
<td class="instruction">JR NZ,28560</td>
<td class="comment-1" rowspan="1">Jump if the ASCII code of the character is &gt; 32</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28549"></span>
<div class="comments">
<div class="paragraph">
The next character in the message is a space. In case there's not enough room left in the message buffer for the word that follows, we now save the submessage indicator and submessage addresses.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28549"></span>28549</td>
<td class="instruction">LD HL,32641</td>
<td class="comment-1" rowspan="4">Copy the submessage indicator and submessage addresses from <a href="32641.html">32641</a> to 32512-32527</td>
</tr>
<tr>
<td class="address-1"><span id="28552"></span>28552</td>
<td class="instruction">LD BC,16</td>
</tr>
<tr>
<td class="address-1"><span id="28555"></span>28555</td>
<td class="instruction">LD DE,32512</td>
</tr>
<tr>
<td class="address-1"><span id="28558"></span>28558</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-2"><span id="28560"></span>28560</td>
<td class="instruction">CP 96</td>
<td class="comment-1" rowspan="1">Is the ASCII code of the character &lt; 96?</td>
</tr>
<tr>
<td class="address-1"><span id="28562"></span>28562</td>
<td class="instruction">JR C,28572</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="28564"></span>28564</td>
<td class="instruction">JR Z,28534</td>
<td class="comment-1" rowspan="1">Jump if the ASCII code of the character is 96 (newline)</td>
</tr>
<tr>
<td class="address-1"><span id="28566"></span>28566</td>
<td class="instruction">CP 100</td>
<td class="comment-1" rowspan="1">Is the ASCII code of the character &gt;= 100?</td>
</tr>
<tr>
<td class="address-1"><span id="28568"></span>28568</td>
<td class="instruction">JR NC,28496</td>
<td class="comment-1" rowspan="1">Jump if so to deal with a submessage</td>
</tr>
<tr>
<td class="address-1"><span id="28570"></span>28570</td>
<td class="instruction">JR 28604</td>
<td class="comment-1" rowspan="1">Jump forward to deal with ASCII code 97 or 98 (99 is not used)</td>
</tr>
<tr>
<td class="address-2"><span id="28572"></span>28572</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="28573"></span>28573</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL'</span> at the next free byte in the message buffer at <a href="32608.html">32608</a></td>
</tr>
<tr>
<td class="address-1"><span id="28574"></span>28574</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store the ASCII code of the message character there</td>
</tr>
<tr>
<td class="address-1"><span id="28575"></span>28575</td>
<td class="instruction">BIT 7,L</td>
<td class="comment-1" rowspan="1">Reset the zero flag if we've reached the end of the message buffer (<span class="register">HL'</span>=32640)</td>
</tr>
<tr>
<td class="address-1"><span id="28577"></span>28577</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="28578"></span>28578</td>
<td class="instruction">JR Z,28512</td>
<td class="comment-1" rowspan="1">Jump if there's still space left in the message buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28580"></span>
<div class="comments">
<div class="paragraph">
The message buffer at <a href="32608.html">32608</a> is full.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28580"></span>28580</td>
<td class="instruction">LD HL,32512</td>
<td class="comment-1" rowspan="4">Restore the submessage indicator and message addresses to <a href="32641.html">32641</a></td>
</tr>
<tr>
<td class="address-1"><span id="28583"></span>28583</td>
<td class="instruction">LD DE,32641</td>
</tr>
<tr>
<td class="address-1"><span id="28586"></span>28586</td>
<td class="instruction">LD BC,16</td>
</tr>
<tr>
<td class="address-1"><span id="28589"></span>28589</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="28591"></span>28591</td>
<td class="instruction">LD L,128</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=32640 (message buffer overflow byte)</td>
</tr>
<tr>
<td class="address-2"><span id="28593"></span>28593</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="6">Remove all characters from the end of the message buffer back to the last space</td>
</tr>
<tr>
<td class="address-1"><span id="28594"></span>28594</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="28595"></span>28595</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="28596"></span>28596</td>
<td class="instruction">LD C,32</td>
</tr>
<tr>
<td class="address-1"><span id="28598"></span>28598</td>
<td class="instruction">CP 32</td>
</tr>
<tr>
<td class="address-1"><span id="28600"></span>28600</td>
<td class="instruction">JR NZ,28593</td>
</tr>
<tr>
<td class="address-1"><span id="28602"></span>28602</td>
<td class="instruction">JR 28534</td>
<td class="comment-1" rowspan="1">Print the contents of the message buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28604"></span>
<div class="comments">
<div class="paragraph">
The ASCII code of the next character in the message is 97 (person or group of people) or 98 (verb).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28604"></span>28604</td>
<td class="instruction">ADD A,100</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=197 or 198</td>
</tr>
<tr>
<td class="address-1"><span id="28606"></span>28606</td>
<td class="instruction">CALL <a href="28616.html">28616</a></td>
<td class="comment-1" rowspan="1">Randomly select a message number for either a verb or a person or group of people</td>
</tr>
<tr>
<td class="address-1"><span id="28609"></span>28609</td>
<td class="instruction">JR 28496</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28355.html">28355</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28357">Map</a></td>
<td class="next">
Next: <a href="28611.html">28611</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20191116</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/6EC5.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>