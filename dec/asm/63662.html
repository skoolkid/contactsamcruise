<!DOCTYPE html>
<html>
<head>
<title>Contact Sam Cruise: Routine at 63662</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Contact Sam Cruise" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63614.html">63614</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63662">Map</a></td>
<td class="next">
Next: <a href="63749.html">63749</a>
</td>
</tr>
</table>
<div class="description">63662: Prepare for demo mode or a new game</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="61630.html">61630</a>. Prepares everything for demo mode or a new game and then displays the introductory cutscene.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63662"></span>63662</td>
<td class="instruction">CALL <a href="64582.html">64582</a></td>
<td class="comment-1" rowspan="1">Generate the table of mirrored values of 0-255 at <a href="32256.html">32256</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63665"></span>
<div class="comments">
<div class="paragraph">
Now we initialise the game status buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63665"></span>63665</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=32512</td>
</tr>
<tr>
<td class="address-1"><span id="63666"></span>63666</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="4">Zero out the first 222 bytes of the game status buffer</td>
</tr>
<tr>
<td class="address-1"><span id="63667"></span>63667</td>
<td class="instruction">LD C,221</td>
</tr>
<tr>
<td class="address-1"><span id="63669"></span>63669</td>
<td class="instruction">LD DE,32513</td>
</tr>
<tr>
<td class="address-1"><span id="63672"></span>63672</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="63674"></span>63674</td>
<td class="instruction">LD E,224</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=32736</td>
</tr>
<tr>
<td class="address-1"><span id="63676"></span>63676</td>
<td class="instruction">LD HL,65504</td>
<td class="comment-1" rowspan="3">Copy the data at <a href="65504.html">65504</a> into the last 32 bytes of the game status buffer</td>
</tr>
<tr>
<td class="address-1"><span id="63679"></span>63679</td>
<td class="instruction">LD C,32</td>
</tr>
<tr>
<td class="address-1"><span id="63681"></span>63681</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63683"></span>
<div class="comments">
<div class="paragraph">
Next we ensure that all the shop and house doors are closed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63683"></span>63683</td>
<td class="instruction">LD B,32</td>
<td class="comment-1" rowspan="1">There are 32 Z values to check (one for each 8-tile wide segment of the play area)</td>
</tr>
<tr>
<td class="address-1"><span id="63685"></span>63685</td>
<td class="instruction">LD HL,48384</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first Z value for y-coordinates 30-35 at <a href="48384.html">48384</a></td>
</tr>
<tr>
<td class="address-2"><span id="63688"></span>63688</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the Z value</td>
</tr>
<tr>
<td class="address-1"><span id="63689"></span>63689</td>
<td class="instruction">CP 83</td>
<td class="comment-1" rowspan="4">Jump unless the Z value corresponds to the open door of a shop (80) or house (81 or 82)</td>
</tr>
<tr>
<td class="address-1"><span id="63691"></span>63691</td>
<td class="instruction">JR NC,63705</td>
</tr>
<tr>
<td class="address-1"><span id="63693"></span>63693</td>
<td class="instruction">CP 80</td>
</tr>
<tr>
<td class="address-1"><span id="63695"></span>63695</td>
<td class="instruction">JR C,63705</td>
</tr>
<tr>
<td class="address-1"><span id="63697"></span>63697</td>
<td class="instruction">SET 2,(HL)</td>
<td class="comment-1" rowspan="1">Set bit 2 of the Z value, thus closing the door</td>
</tr>
<tr>
<td class="address-1"><span id="63699"></span>63699</td>
<td class="instruction">JR NZ,63705</td>
<td class="comment-1" rowspan="1">Jump unless we are dealing with a shop door</td>
</tr>
<tr>
<td class="address-1"><span id="63701"></span>63701</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Update the Z value in the block at <a href="48640.html">48640</a> if we are dealing with a shop door</td>
</tr>
<tr>
<td class="address-1"><span id="63702"></span>63702</td>
<td class="instruction">LD (HL),83</td>
</tr>
<tr>
<td class="address-1"><span id="63704"></span>63704</td>
<td class="instruction">DEC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> back at the block of Z values at <a href="48384.html">48384</a></td>
</tr>
<tr>
<td class="address-2"><span id="63705"></span>63705</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next Z value</td>
</tr>
<tr>
<td class="address-1"><span id="63706"></span>63706</td>
<td class="instruction">DJNZ 63688</td>
<td class="comment-1" rowspan="1">Jump back until we've checked every Z value</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63708"></span>
<div class="comments">
<div class="paragraph">
Next we initialise characters 215-221, the icon panel, the score box, the message line, the phone messages, the event table at <a href="24544.html">24544</a> and the object table at <a href="32028.html">32028</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63708"></span>63708</td>
<td class="instruction">CALL <a href="63472.html">63472</a></td>
<td class="comment-1" rowspan="1">Initialise the character buffers for character groups 215-221</td>
</tr>
<tr>
<td class="address-1"><span id="63711"></span>63711</td>
<td class="instruction">CALL <a href="28760.html">28760</a></td>
<td class="comment-1" rowspan="1">Initialise the icon panel, score box and message line</td>
</tr>
<tr>
<td class="address-1"><span id="63714"></span>63714</td>
<td class="instruction">CALL <a href="31458.html">31458</a></td>
<td class="comment-1" rowspan="1">Prepare the phone messages, events and objects</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63717"></span>
<div class="comments">
<div class="paragraph">
Let's not forget about the rope that may be above the roof of no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63717"></span>63717</td>
<td class="instruction">LD HL,2827</td>
<td class="comment-1" rowspan="2">Set the appropriate Z values in the block at <a href="47360.html">47360</a> to 11, thus removing the rope (if any) from above the roof of no. 19</td>
</tr>
<tr>
<td class="address-1"><span id="63720"></span>63720</td>
<td class="instruction">LD (47386),HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63723"></span>
<div class="comments">
<div class="paragraph">
And finally we initialise the main characters (222-230) before displaying the introductory cutscene.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63723"></span>63723</td>
<td class="instruction">LD A,(32750)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current game mode (0 or 1)</td>
</tr>
<tr>
<td class="address-1"><span id="63726"></span>63726</td>
<td class="instruction">JR 63733</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63728"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="24832.html">24832</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63728"></span>63728</td>
<td class="instruction">LD HL,32750</td>
<td class="comment-1" rowspan="1"><a href="32750.html">32750</a> holds the current game mode (0-4)</td>
</tr>
<tr>
<td class="address-1"><span id="63731"></span>63731</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Move to the next game mode</td>
</tr>
<tr>
<td class="address-1"><span id="63732"></span>63732</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=next game mode</td>
</tr>
<tr>
<td class="address-2"><span id="63733"></span>63733</td>
<td class="instruction">CALL <a href="63614.html">63614</a></td>
<td class="comment-1" rowspan="1">Initialise the character buffers for characters 222-230</td>
</tr>
<tr>
<td class="address-1"><span id="63736"></span>63736</td>
<td class="instruction">DEC H</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the message number in the set of initialisation parameters for the current game mode for Sam (see <a href="58912.html">58912</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="63737"></span>63737</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="63738"></span>63738</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the message number in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63739"></span>63739</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63740"></span>63740</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Pick up the new y-coordinate for the topmost row of the play area on screen in <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="63741"></span>63741</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="63742"></span>63742</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Pick up the new x-coordinate for the topmost row of the play area on screen in <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="63743"></span>63743</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="63744"></span>63744</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Pick up the LSB of the address of the screen refresh buffer byte that corresponds to the top row of the cutscene window</td>
</tr>
<tr>
<td class="address-1"><span id="63745"></span>63745</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="63746"></span>63746</td>
<td class="instruction">JP <a href="31414.html#31451">31451</a></td>
<td class="comment-1" rowspan="1">Display the cutscene</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63614.html">63614</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63662">Map</a></td>
<td class="next">
Next: <a href="63749.html">63749</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Contact Sam Cruise RAM disassembly 20200812</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/F8AE.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>